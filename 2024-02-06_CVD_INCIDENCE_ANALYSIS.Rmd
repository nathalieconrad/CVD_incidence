---
title: "CVD Incidence - ANALYSIS"
author: "Nathalie Conrad"
date: "February 2024"
output: html_document
---

# CVD INCIDENCE


# LIBRARIES AND SETTINGS
```{r, warning=FALSE, message=FALSE}
#install.packages("xls")
library(epitools)
library(ggalluvial)
library(gridExtra)
library(MASS)
library(grid)
library(tidyverse)
library(data.table)
library(ggplot2)
library(knitr)
#library(gdata)
#library(ggplot2)
library(rapportools)
#library(rapport)
library(bit64)
library(epiR)
library(ggtext)
library(extrafont)
library(metafor)
library(gdata)
library(htmlTable)
library(table1)
#library(sysfonts)
```

# STUDY CRITERIA 

## Study Dates & parameters
```{r, eval=TRUE, warning=FALSE, message=FALSE}
#study_start_date = as.Date("01/01/1995", format="%d/%m/%Y")
linkage_start_date = as.Date("01/01/1998", format="%d/%m/%Y")
study_start_date = as.Date("01/01/2000", format="%d/%m/%Y")
study_end_date = as.Date("30/06/2019", format="%d/%m/%Y")

# Lookback period
lookback_period = 365
#lookback_period = 4*365+1 # Study excludes records with a diagnosis within the first "lookback_period" days of GP registration
lookback_period

include_death = "no"
include_death
```

## Work Environment
```{r, warning=FALSE, message=FALSE}
# Secure data directories
PATH_D = "/Users/u0133446/CPRD-2020/CPRD-DATA-1stRelease" # path to data directory
PATH_D2 = "/Users/u0133446/CPRD-2020/Final_Delivery1_19_156" # path to data directory
PATH_W = "/Users/u0133446/CPRD-2020/Workspace/CVD_incidence" # path to workspace directory
#PATH_W_CVD = "/Users/u0133446/CPRD-2020/Workspace/CVD_incidence/Lookback_4y_ex_death" # path to workspace directory
#PATH_W_CVD = "/Users/u0133446/CPRD-2020/Workspace/CVD_incidence/Lookback_1y_inc_death" # path to workspace directory
PATH_W_CVD = "/Users/u0133446/CPRD-2020/Workspace/CVD_incidence" # path to workspace directory
PATH_W_all = "/Users/u0133446/CPRD-2020/Workspace" # path to workspace directory
PATH_L = "/Users/u0133446/CPRD-2020/Final_Delivery1_19_156/Lookups" # path to lookups directory

# Dropbox directories for diagnostic codes, aggregated tables and plots
PATH = "/Users/u0133446/Dropbox/Leuven/INF-CVD" # path to dropbox directory
PATH_P = "/Users/u0133446/Dropbox/Leuven/INF-CVD/CPRD-2020_non_data/Plots/CVD_incidence" # path to plots directory
#PATH_P = "/Users/u0133446/Dropbox/Leuven/INF-CVD/CPRD-2020_non_data/Plots/CVD_incidence/Lookback_1y_inc_death" # path to plots directory
#PATH_P = "/Users/u0133446/Dropbox/Leuven/INF-CVD/CPRD-2020_non_data/Plots/CVD_incidence/Lookback_4y_ex_death" # path to plot directory

```

## Disease codes - (code review January 2024)
```{r disease_codes, eval=TRUE, warning=FALSE, message=FALSE}
# all codes
all_codes_table = data.table(read.table(file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/2024-01-19_FINAL_CVD_diagnostic_codes_table_JMM.txt"), header = TRUE, sep="\t", colClasses=c("medcode_aurum"="integer64"))) # Final set of codes for analysis as per January 2024 review
nrow(all_codes_table)
head(all_codes_table)
levels(as.factor(all_codes_table$include))

head(all_codes_table)
colnames(all_codes_table)
nrow(all_codes_table)
levels(as.factor(all_codes_table$include))
levels(as.factor(all_codes_table$codetype))
levels(as.factor(all_codes_table$disease))

# Check diagnostic codes (to avoid shortening of aurum codes) - alll fine in new table
#all_codes_table[codetype == "aurum" , medcode_aurum := as.integer64(sub(".*_", "", unique_ID))]
#all_codes_table[codetype == "gold" , medcode_gold := as.integer(sub(".*_", "", unique_ID))]
#all_codes_table[codetype == "icd" , icd_code := sub(".*_", "", unique_ID)]
#all_codes_table[codetype == "opcs" , opcs_code := sub(".*_", "", unique_ID)]

# gold 
gold_codes_table = all_codes_table[codetype == "gold"]
nrow(gold_codes_table)

# aurum
aurum_codes_table = all_codes_table[codetype == "aurum"]
nrow(aurum_codes_table)
# Check that aurum codes have not been shortened
class(aurum_codes_table$medcode_aurum)
summary(aurum_codes_table$medcode_aurum)

#max(as.integer64(diag_read_codes_table1$medcode_aurum))
# if max = 1..e+16 then codes have been truncated
aurum_codes_table[medcode_aurum == "11920121000006117"]
#Transient cerebral ischemia

# icd
icd_codes_table = all_codes_table[codetype == "icd"]
icd_codes_table[,alt_icd_code:= gsub("\\.", "", icd_code)] # remove "." in ICD-10 codes
nrow(icd_codes_table)
icd_codes_table

# icd version 9 and 10 (only used in death records up to the year 2000)
icd_9_10_codes_table = all_codes_table[codetype %in% c("icd9", "icd")]
icd_9_10_codes_table[,alt_icd_code:= gsub("\\.", "", icd_code)] # remove "." in ICD-10 codes
nrow(icd_9_10_codes_table)
icd_9_10_codes_table[codetype == "icd9"]

# opcs
opcs_codes_table= all_codes_table[codetype == "opcs"]
opcs_codes_table[,alt_opcs_code:= gsub("\\.", "", opcs_code)] # remove "." in ICD-10 codes
nrow(opcs_codes_table)

nrow(gold_codes_table)+nrow(aurum_codes_table)+nrow(icd_codes_table)+nrow(opcs_codes_table)
```

## Age group table
```{r, eval=TRUE, warning=FALSE, message=FALSE}
age_group_table = fread(file.path(PATH_L, "age_groups.txt"), header = TRUE, sep ="\t")
age_group_table
age_group_table[,age_group6 := age_group6_cvd]
```

## European Standard Population
```{r, eval=TRUE, warning=FALSE, message=FALSE}
esp = data.table(read.table(file.path(PATH_L, "/ESP 2013 Population 90_5.txt"), header = TRUE, sep ="\t"))
esp
sum(esp$esp_population)
```

## My functions
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# compute days at risk
compute_days_at_risk = function (year, data){
  year_start = as.Date(paste(year,"-01-01",sep=""), format="%Y-%m-%d")
  year_end = as.Date(paste(year,"-12-31",sep=""), format="%Y-%m-%d")
  days=as.numeric(pmax(pmin(data$diag_date, as.Date(data$lcdate), data$dod, data$todate, study_end_date, year_end,na.rm=T)+1 - pmax(as.Date(data$regdate)+lookback_period, study_start_date, as.Date(data$birth_date), year_start),0)) #time at risk start at GP registration + lookback_period
return(days)}

# compute days at risk over all years
compute_days_at_risk_all_years = function (data){
data[,days2000 := compute_days_at_risk("2000",data)]
data[,days2001 := compute_days_at_risk("2001",data)]
data[,days2002 := compute_days_at_risk("2002",data)]
data[,days2003 := compute_days_at_risk("2003",data)]
data[,days2004 := compute_days_at_risk("2004",data)]
data[,days2005 := compute_days_at_risk("2005",data)]
data[,days2006 := compute_days_at_risk("2006",data)]
data[,days2007 := compute_days_at_risk("2007",data)]
data[,days2008 := compute_days_at_risk("2008",data)]
data[,days2009 := compute_days_at_risk("2009",data)]
data[,days2010 := compute_days_at_risk("2010",data)]
data[,days2011 := compute_days_at_risk("2011",data)]
data[,days2012 := compute_days_at_risk("2012",data)]
data[,days2013 := compute_days_at_risk("2013",data)]
data[,days2014 := compute_days_at_risk("2014",data)]
data[,days2015 := compute_days_at_risk("2015",data)]
data[,days2016 := compute_days_at_risk("2016",data)]
data[,days2017 := compute_days_at_risk("2017",data)]
data[,days2018 := compute_days_at_risk("2018",data)]
data[,days2019 := compute_days_at_risk("2019",data)]
data[,days_all_years := days2000 + days2001+ days2002+ days2003+ days2004+ days2005+ days2006+ days2007+ days2008+ days2009+ days2010+ days2011+ days2012+ days2013+ days2014+ days2015+ days2016+ days2017+ days2018+ days2019]
return(data)}

# create denominator by subgroup
compute_denominator_by_subgroup = function (data){
#data=num_denom
denominator_by_yob = data[,.("2000"= round(sum(days2000)/365,4),
                            "2001"= round(sum(days2001)/365,4),
                            "2002"= round(sum(days2002)/365,4),
                            "2003"= round(sum(days2003)/365,4),
                            "2004"= round(sum(days2004)/366,4),
                            "2005"= round(sum(days2005)/365,4),
                            "2006"= round(sum(days2006)/365,4),
                            "2007"= round(sum(days2007)/365,4),
                            "2008"= round(sum(days2008)/366,4),
                            "2009"= round(sum(days2009)/365,4),
                            "2010"= round(sum(days2010)/365,4),
                            "2011"= round(sum(days2011)/365,4),
                            "2012"= round(sum(days2012)/366,4),
                            "2013"= round(sum(days2013)/365,4),
                            "2014"= round(sum(days2014)/365,4),
                            "2015"= round(sum(days2015)/365,4),
                            "2016"= round(sum(days2016)/365,4),
                            "2017"= round(sum(days2017)/365,4),
                            "2018"= round(sum(days2018)/365,4),
                            "2019"= round(sum(days2019)/365,4)),          
                            by=.(birthyear, gender_name, imd2015_5, region_name)]
denominator_by_yob_melted = reshape2::melt(denominator_by_yob, id=c("birthyear", "gender_name", "imd2015_5", "region_name"), variable.name = "year", value.name="patient_years") 
denominator_by_yob_melted = data.table(denominator_by_yob_melted)
denominator_by_yob_melted[, age := as.numeric(as.character(year))-birthyear ] # Add age-group
denominator_by_yob_melted = denominator_by_yob_melted[age >=0 ]
denominator_by_yob_melted[, age_group_id := pmin((age%/%5)+pmin(age,1),20)]
denominator_by_yob_melted=merge(x=denominator_by_yob_melted, y= age_group_table[,.(age_group_id, age_group, age_group6)], by = "age_group_id", all.x = TRUE, sort = FALSE)
denominator_by_subgroup = denominator_by_yob_melted[,.(patient_years=sum(patient_years)),  by=.(year, age_group, gender_name, imd2015_5, region_name)]
denominator_by_subgroup[is.na(patient_years)]$patient_years= 0
denominator_by_subgroup[, year := as.numeric(as.character(year))]
return(denominator_by_subgroup)}

# create denominator by subgroup 2 - by age in years
compute_denominator_by_subgroup2 = function (data){
denominator_by_yob = data[,.("2000"= round(sum(days2000)/365,4),
                            "2001"= round(sum(days2001)/365,4),
                            "2002"= round(sum(days2002)/365,4),
                            "2003"= round(sum(days2003)/365,4),
                            "2004"= round(sum(days2004)/366,4),
                            "2005"= round(sum(days2005)/365,4),
                            "2006"= round(sum(days2006)/365,4),
                            "2007"= round(sum(days2007)/365,4),
                            "2008"= round(sum(days2008)/366,4),
                            "2009"= round(sum(days2009)/365,4),
                            "2010"= round(sum(days2010)/365,4),
                            "2011"= round(sum(days2011)/365,4),
                            "2012"= round(sum(days2012)/366,4),
                            "2013"= round(sum(days2013)/365,4),
                            "2014"= round(sum(days2014)/365,4),
                            "2015"= round(sum(days2015)/365,4),
                            "2016"= round(sum(days2016)/365,4),
                            "2017"= round(sum(days2017)/365,4),
                            "2018"= round(sum(days2018)/365,4),
                            "2019"= round(sum(days2019)/365,4)),          
                            by=.(birthyear)]
denominator_by_yob_melted = reshape2::melt(denominator_by_yob, id=c("birthyear"), variable.name = "year", value.name="patient_years") 
denominator_by_yob_melted = data.table(denominator_by_yob_melted)
denominator_by_yob_melted[, age := as.numeric(as.character(year))-birthyear ] # Add age
denominator_by_yob_melted[, age := pmin(age, 101) ] # group those aged 101+ together
denominator_by_yob_melted = denominator_by_yob_melted[age >=0 ]
denominator_by_yob_melted[, patient_years := as.numeric(as.character(patient_years)) ] 
denominator_by_subgroup = denominator_by_yob_melted[,.(patient_years=sum(patient_years)),  by=.(year, age)]
denominator_by_subgroup[is.na(patient_years)]$patient_years= 0
denominator_by_subgroup[, year := as.numeric(as.character(year))]
return(denominator_by_subgroup)}

# create denominator by subgroup - season
# compute days at risk
# data
compute_days_at_risk_season = function (year, data, season){
  winter_start = as.Date(paste(year,"-01-01",sep=""), format="%Y-%m-%d")
  winter_end = as.Date(paste(year,"-03-31",sep=""), format="%Y-%m-%d")
  summer_start = as.Date(paste(year,"-06-01",sep=""), format="%Y-%m-%d")
  summer_end = as.Date(paste(year,"-08-31",sep=""), format="%Y-%m-%d")
  days= ifelse(season == "Winter", as.numeric(pmax(pmin(data$diag_date, as.Date(data$lcdate), data$dod, data$todate, study_end_date, winter_end,na.rm=T)+1 - pmax(as.Date(data$regdate)+lookback_period, as.Date(data$birth_date), winter_start),0)),as.numeric(pmax(pmin(data$diag_date, as.Date(data$lcdate), data$dod, data$todate, study_end_date, summer_end,na.rm=T)+1 - pmax(as.Date(data$regdate)+lookback_period, as.Date(data$birth_date), summer_start),0)))
  #days = ifelse(season == "Winter",as.numeric(pmax(pmin(data$diag_date, data$dod, data$todate, study_end_date, na.rm=T))), as.numeric(pmax(pmin(data$diag_date, data$dod, data$todate, study_end_date,na.rm=T))) )# time at risk start 12months after GP registration
return(days)}

# compute days at risk over all years
compute_days_at_risk_all_years_season = function (data,season){
data[, season := NULL]
#season =  "Winter"
data[, season := season]
data[,days2000 := compute_days_at_risk_season("2000",data, season)]
data[,days2001 := compute_days_at_risk_season("2001",data, season)]
data[,days2002 := compute_days_at_risk_season("2002",data, season)]
data[,days2003 := compute_days_at_risk_season("2003",data, season)]
data[,days2004 := compute_days_at_risk_season("2004",data, season)]
data[,days2005 := compute_days_at_risk_season("2005",data, season)]
data[,days2006 := compute_days_at_risk_season("2006",data, season)]
data[,days2007 := compute_days_at_risk_season("2007",data, season)]
data[,days2008 := compute_days_at_risk_season("2008",data, season)]
data[,days2009 := compute_days_at_risk_season("2009",data, season)]
data[,days2010 := compute_days_at_risk_season("2010",data, season)]
data[,days2011 := compute_days_at_risk_season("2011",data, season)]
data[,days2012 := compute_days_at_risk_season("2012",data, season)]
data[,days2013 := compute_days_at_risk_season("2013",data, season)]
data[,days2014 := compute_days_at_risk_season("2014",data, season)]
data[,days2015 := compute_days_at_risk_season("2015",data, season)]
data[,days2016 := compute_days_at_risk_season("2016",data, season)]
data[,days2017 := compute_days_at_risk_season("2017",data, season)]
data[,days2018 := compute_days_at_risk_season("2018",data, season)]
data[,days2019 := compute_days_at_risk_season("2019",data, season)]
return(data)}

compute_denominator_by_subgroup_season = function (data){
#Winter
data = compute_days_at_risk_all_years_season (data, "Winter")
denominator_by_yob = data[,.("2000"= round(sum(days2000)/365,4),
                            "2001"= round(sum(days2001)/365,4),
                            "2002"= round(sum(days2002)/365,4),
                            "2003"= round(sum(days2003)/365,4),
                            "2004"= round(sum(days2004)/366,4),
                            "2005"= round(sum(days2005)/365,4),
                            "2006"= round(sum(days2006)/365,4),
                            "2007"= round(sum(days2007)/365,4),
                            "2008"= round(sum(days2008)/366,4),
                            "2009"= round(sum(days2009)/365,4),
                            "2010"= round(sum(days2010)/365,4),
                            "2011"= round(sum(days2011)/365,4),
                            "2012"= round(sum(days2012)/366,4),
                            "2013"= round(sum(days2013)/365,4),
                            "2014"= round(sum(days2014)/365,4),
                            "2015"= round(sum(days2015)/365,4),
                            "2016"= round(sum(days2016)/365,4),
                            "2017"= round(sum(days2017)/365,4),
                            "2018"= round(sum(days2018)/365,4),
                            "2019"= round(sum(days2019)/365,4)),          
                            by=.(birthyear, gender_name, season)]
denominator_by_yob_melted = reshape2::melt(denominator_by_yob, id=c("birthyear","gender_name", "season"), variable.name = "year", value.name="patient_years") 
denominator_by_yob_melted = data.table(denominator_by_yob_melted)
denominator_by_yob_melted[, age := as.numeric(as.character(year))-birthyear ] # Add age-group
denominator_by_yob_melted = denominator_by_yob_melted[age >=0 ]
denominator_by_yob_melted[, age_group_id := pmin((age%/%5)+pmin(age,1),20)]
denominator_by_yob_melted=merge(x=denominator_by_yob_melted, y= age_group_table[,.(age_group_id, age_group, age_group6)], by = "age_group_id", all.x = TRUE, sort = FALSE)
denominator_by_yob_melted[, patient_years := as.numeric(as.character(patient_years)) ] 
denominator_by_subgroup = denominator_by_yob_melted[,.(patient_years=sum(patient_years)),  by=.(year, age_group, gender_name, season)]
denominator_by_subgroup[is.na(patient_years)]$patient_years= 0
denominator_by_subgroup[, year := as.numeric(as.character(year))]
denominator_by_subgroup_winter = denominator_by_subgroup
# Summer
data = compute_days_at_risk_all_years_season (data, "Summer")
denominator_by_yob = data[,.("2000"= round(sum(days2000)/365,4),
                            "2001"= round(sum(days2001)/365,4),
                            "2002"= round(sum(days2002)/365,4),
                            "2003"= round(sum(days2003)/365,4),
                            "2004"= round(sum(days2004)/366,4),
                            "2005"= round(sum(days2005)/365,4),
                            "2006"= round(sum(days2006)/365,4),
                            "2007"= round(sum(days2007)/365,4),
                            "2008"= round(sum(days2008)/366,4),
                            "2009"= round(sum(days2009)/365,4),
                            "2010"= round(sum(days2010)/365,4),
                            "2011"= round(sum(days2011)/365,4),
                            "2012"= round(sum(days2012)/366,4),
                            "2013"= round(sum(days2013)/365,4),
                            "2014"= round(sum(days2014)/365,4),
                            "2015"= round(sum(days2015)/365,4),
                            "2016"= round(sum(days2016)/365,4),
                            "2017"= round(sum(days2017)/365,4),
                            "2018"= round(sum(days2018)/365,4),
                            "2019"= round(sum(days2019)/365,4)),          
                            by=.(birthyear, gender_name, season)]
denominator_by_yob_melted = reshape2::melt(denominator_by_yob, id=c("birthyear","gender_name", "season"), variable.name = "year", value.name="patient_years") 
denominator_by_yob_melted = data.table(denominator_by_yob_melted)
denominator_by_yob_melted[, age := as.numeric(as.character(year))-birthyear ] # Add age-group
denominator_by_yob_melted = denominator_by_yob_melted[age >=0 ]
denominator_by_yob_melted[, age_group_id := pmin((age%/%5)+pmin(age,1),20)]
denominator_by_yob_melted=merge(x=denominator_by_yob_melted, y= age_group_table[,.(age_group_id, age_group, age_group6)], by = "age_group_id", all.x = TRUE, sort = FALSE)
denominator_by_yob_melted[, patient_years := as.numeric(as.character(patient_years)) ] 
denominator_by_subgroup = denominator_by_yob_melted[,.(patient_years=sum(patient_years)),  by=.(year, age_group, gender_name, season)]
denominator_by_subgroup[is.na(patient_years)]$patient_years= 0
denominator_by_subgroup[, year := as.numeric(as.character(year))]
denominator_by_subgroup = rbind(denominator_by_subgroup_winter, denominator_by_subgroup)
return(denominator_by_subgroup)}

# create numerator by subgroup
compute_numerator_by_subgroup = function (data){
numerator= data[disease_flag == 1]
numerator[, diag_year := year(diag_date)]
numerator[, age_at_diag := diag_year-birthyear]
numerator[, age_group_id := pmin((age_at_diag%/%5)+pmin(age_at_diag,1),20)]
#nrow(numerator[!age_group_id>=0])
numerator=merge(x=numerator, y= age_group_table[,.(age_group_id, age_group, age_group6)], by = "age_group_id", all.x = TRUE, sort = FALSE)
numerator_by_subgroup = numerator[,.(cases=sum(disease_flag)),  by=.(diag_year, age_group, gender_name, imd2015_5, region_name)]
numerator_by_subgroup[is.na(cases)]$cases= 0
setnames(numerator_by_subgroup, old = "diag_year", new = "year")
return(numerator_by_subgroup)}

# create numerator by subgroup 2 - by age in years
compute_numerator_by_subgroup2 = function (data){
numerator= data[disease_flag == 1]
numerator[, diag_year := year(diag_date)]
numerator[, age_at_diag := pmin(diag_year-birthyear, 101)]
numerator_by_subgroup = numerator[,.(cases=sum(disease_flag)),  by=.(diag_year, age_at_diag)]
numerator_by_subgroup[is.na(cases)]$cases= 0
setnames(numerator_by_subgroup, old = "diag_year", new = "year")
return(numerator_by_subgroup)}

# create numerator by subgroup 2 - SEASON
compute_numerator_by_subgroup_season = function (data){
numerator= data[disease_flag == 1]
numerator[, diag_year := year(diag_date)]
numerator[, age_at_diag := diag_year-birthyear]
numerator[, age_group_id := pmin((age_at_diag%/%5)+pmin(age_at_diag,1),20)]
numerator=merge(x=numerator, y= age_group_table[,.(age_group_id, age_group, age_group6)], by = "age_group_id", all.x = TRUE, sort = FALSE)
numerator_by_subgroup = numerator[,.(cases=sum(disease_flag)),  by=.(diag_year, age_group, gender_name, diag_season)]
numerator_by_subgroup[is.na(cases)]$cases= 0
setnames(numerator_by_subgroup, old = "diag_year", new = "year")
setnames(numerator_by_subgroup, old = "diag_season", new = "season")
return(numerator_by_subgroup)
}

# incidence by age
compute_incidence_by_age_in_years = function (num_denom, disease){
denominator_by_subgroup = compute_denominator_by_subgroup2(num_denom)
numerator_by_subgroup = compute_numerator_by_subgroup2(num_denom)
denominator_by_subgroup
numerator_by_age = numerator_by_subgroup[,.(cases=sum(cases)), by=.(age_at_diag)]
denominator_by_age = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(age)]
incidence_table_by_age = merge(x=numerator_by_age[, .(age_at_diag, cases)], y= denominator_by_age, by.x = c("age_at_diag"), by.y = c("age"), all.x = TRUE, all.y = TRUE, sort = FALSE)
incidence_table_by_age[,incidence:= round((cases/ patient_years)*100000,1)]
incidence_table_by_age[is.na(incidence)]$incidence = 0
incidence_table_by_age[,disease := disease] # incidence rates per 100'000 years at risk
return(incidence_table_by_age)}

# incidence by gender and year
compute_incidence_by_gender_year = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0

# crude incidence
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(year, gender_name)]
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,0), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,0), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,0), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted

# crude incidence all years
incidence_table_unadjusted_all_years = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(gender_name)]
incidence_table_unadjusted_all_years[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted_all_years[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted_all_years [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,0), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,0), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,0), nsmall = 0), "]",sep="")]
incidence_table_unadjusted_all_years[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted_all_years[,year:= "All years"]
incidence_table_unadjusted_all_years

# standardised incidence
numerator_by_age_gender_year = numerator_by_subgroup[,.(cases=sum(cases)), by=.(year, age_group, gender_name)]
denominator_by_age_gender_year = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(year, age_group, gender_name)]
exp_cases_by_age_gender_year = merge(x=numerator_by_age_gender_year[, .(year, age_group, gender_name, cases)], y= denominator_by_age_gender_year, by = c("year", "gender_name", "age_group"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender_year = merge(x=exp_cases_by_age_gender_year, y=esp, by = c("age_group"), all.x = TRUE, all.y=TRUE, sort = FALSE)
exp_cases_by_age_gender_year[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender_year[is.na(exp_cases)]$exp_cases = 0
#scale = sum(denominator_by_subgroup$patient_years)/100000
exp_cases_by_age_gender_year
exp_cases_by_year = exp_cases_by_age_gender_year[,.(exp_cases=sum(exp_cases), esp_population =sum(esp_population), scale = sum(patient_years)/200000), by=.(year, gender_name)]# standardized incidence per 100'000 patient-years
#exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]
exp_cases_by_year_conf = epi.conf(as.matrix(exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases_by_year[,incidence_stand_conf := paste(format(round(exp_cases_by_year_conf$est,0), nsmall = 0), " [",format(round(exp_cases_by_year_conf$lower,0), nsmall = 0),", ",format(round(exp_cases_by_year_conf$upper,0), nsmall = 0), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases_by_year[,disease := disease]

# standardised incidence all years
numerator_by_age_gender = numerator_by_subgroup[,.(cases=sum(cases)), by=.(age_group, gender_name)]
denominator_by_age_gender = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(age_group, gender_name)]
exp_cases_by_age_gender = merge(x=numerator_by_age_gender[, .(age_group, gender_name, cases)], y= denominator_by_age_gender, by = c( "gender_name", "age_group"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender = merge(x=exp_cases_by_age_gender, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender[is.na(exp_cases)]$exp_cases = 0
scale = sum(denominator_by_subgroup$patient_years)/200000
exp_cases = exp_cases_by_age_gender[,.(exp_cases=sum(exp_cases), esp_population =sum(esp_population)), by =.(gender_name)]# standardized incidence per 100'000 patient-years
exp_cases_conf = epi.conf(as.matrix(exp_cases[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases[,incidence_stand_conf := paste(format(round(exp_cases_conf$est,0), nsmall = 0), " [",format(round(exp_cases_conf$lower,0), nsmall = 0),", ",format(round(exp_cases_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases[,disease := disease] # incidence rates per 100'000 years at risk
exp_cases[,year:= "All years"]

# Rbind 
exp_cases_by_year = rbind(exp_cases_by_year[,-("scale")], exp_cases)
setnames(exp_cases_by_year, old = "exp_cases", new = "incidence_stand")
incidence_table_unadjusted = rbind(incidence_table_unadjusted, incidence_table_unadjusted_all_years)
incidence_table = merge(exp_cases_by_year, incidence_table_unadjusted, by = c("year", "gender_name", "disease")) 
#class(exp_cases_by_year$year)
#class(incidence_table_unadjusted$year)
#incidence_table_unadjusted
incidence_table = incidence_table[order(year)]
setcolorder(incidence_table, c("disease", "year", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf", "incidence_stand", "incidence_stand_conf"))
return(incidence_table)
}

# incidence by 5 year age-band
compute_incidence_by_5y_age_band = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0
incidence_table[,age_group_orig := age_group]
incidence_table[age_group %in% c("0-4", "5-9", "10-14", "15-19", "20-24"), age_group := "0-24"]

# 1. All years
# 1.1 Men and women
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages )
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted[,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "All years"]
incidence_table_unadjusted[,gender_name:= "All"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name", "age_group",  "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_men_and_women= incidence_table_unadjusted
incidence_table_unadjusted_men_and_women

# 1.2 Women
incidence_table_unadjusted = incidence_table[gender_name == "Female",.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages )
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "All years"]
incidence_table_unadjusted[,gender_name:= "Women"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name", "age_group","cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_women = incidence_table_unadjusted

# 1.3 Men 
incidence_table_unadjusted = incidence_table[gender_name == "Male",.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages )
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "All years"]
incidence_table_unadjusted[,gender_name:= "Men"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name", "age_group", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_men = incidence_table_unadjusted

incidence_table_unadjusted_all_years= cbind(incidence_table_unadjusted_men_and_women,incidence_table_unadjusted_women, incidence_table_unadjusted_men)

# 2. 2017-2019
# 2.1 Men and women
incidence_table_unadjusted = incidence_table[year %in% c(2017, 2018, 2019),.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages)
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted[,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "2017-2019"]
incidence_table_unadjusted[,gender_name:= "All"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name","age_group", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_men_and_women= incidence_table_unadjusted

# 2.2 Women
incidence_table_unadjusted = incidence_table[year %in% c(2017, 2018, 2019) & gender_name == "Female",.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages)
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "2017-2019"]
incidence_table_unadjusted[,gender_name:= "Women"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name","age_group", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_women = incidence_table_unadjusted

# 2.3 Men 
incidence_table_unadjusted = incidence_table[year %in% c(2017, 2018, 2019) & gender_name == "Male",.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages)
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "2017-2019"]
incidence_table_unadjusted[,gender_name:= "Men"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name", "age_group","cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_men = incidence_table_unadjusted

incidence_table_unadjusted_2017_2019= cbind(incidence_table_unadjusted_men_and_women,incidence_table_unadjusted_women, incidence_table_unadjusted_men)


# 3. 2000-2002
# 3.1 Men and women
incidence_table_unadjusted = incidence_table[year %in% c(2000, 2001, 2002),.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages)
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted[,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "2000-2002"]
incidence_table_unadjusted[,gender_name:= "All"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name","age_group", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_men_and_women= incidence_table_unadjusted

# 3.2 Women
incidence_table_unadjusted = incidence_table[year %in% c(2000, 2001, 2002) & gender_name == "Female",.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages)
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "2000-2002"]
incidence_table_unadjusted[,gender_name:= "Women"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name","age_group", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_women = incidence_table_unadjusted

# 3.3 Men 
incidence_table_unadjusted = incidence_table[year %in% c(2000, 2001, 2002) & gender_name == "Male",.(cases=sum(cases), patient_years= sum(patient_years)), by=.(age_group)]
all_ages = data.table(age_group = "All ages", cases=sum(incidence_table_unadjusted$cases), patient_years = sum(incidence_table_unadjusted$patient_years))
incidence_table_unadjusted = rbind(incidence_table_unadjusted,all_ages)
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted[,year:= "2000-2002"]
incidence_table_unadjusted[,gender_name:= "Men"]
setcolorder(incidence_table_unadjusted, c("disease", "year", "gender_name", "age_group","cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
incidence_table_unadjusted_men = incidence_table_unadjusted

incidence_table_unadjusted_2000_2002= cbind(incidence_table_unadjusted_men_and_women,incidence_table_unadjusted_women, incidence_table_unadjusted_men)

incidence_table_unadjusted_all = rbind(incidence_table_unadjusted_all_years, incidence_table_unadjusted_2017_2019, incidence_table_unadjusted_2000_2002)

return(incidence_table_unadjusted_all)
}


# incidence by SES and year
compute_incidence_by_ses_year = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0

# crude incidence
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(year, imd2015_5)]
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
# crude incidence all years
incidence_table_unadjusted_all_years = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by = .(imd2015_5)]
incidence_table_unadjusted_all_years[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted_all_years[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted_all_years [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted_all_years[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted_all_years[,year:= "All years"]

# standardised incidence
numerator_by_age_gender_year = numerator_by_subgroup[,.(cases=sum(cases)), by=.(year, age_group, gender_name, imd2015_5)]
denominator_by_age_gender_year = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(year, age_group, gender_name, imd2015_5)]
exp_cases_by_age_gender_year = merge(x=numerator_by_age_gender_year[, .(year, age_group, gender_name, imd2015_5, cases)], y= denominator_by_age_gender_year, by = c("year", "gender_name", "age_group", "imd2015_5"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender_year = merge(x=exp_cases_by_age_gender_year, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender_year[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender_year[is.na(exp_cases)]$exp_cases = 0
#scale = sum(denominator_by_subgroup$patient_years)/100000
exp_cases_by_year = exp_cases_by_age_gender_year[,.(exp_cases=sum(exp_cases)/2, esp_population =sum(esp_population)/2, scale = sum(patient_years)/200000), by=.(year, imd2015_5)]# standardized incidence per 100'000 patient-years
#exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]
exp_cases_by_year_conf = epi.conf(as.matrix(exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases_by_year[,incidence_stand_conf := paste(format(round(exp_cases_by_year_conf$est,1), nsmall = 1), " [",format(round(exp_cases_by_year_conf$lower,1), nsmall = 1),", ",format(round(exp_cases_by_year_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases_by_year[,disease := disease]
exp_cases_by_year

# standardised incidence all years
numerator_by_age_gender = numerator_by_subgroup[,.(cases=sum(cases)), by=.(age_group, gender_name, imd2015_5)]
denominator_by_age_gender = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(age_group, gender_name, imd2015_5)]
exp_cases_by_age_gender = merge(x=numerator_by_age_gender[, .(age_group, gender_name, imd2015_5, cases)], y= denominator_by_age_gender, by = c( "gender_name", "age_group", "imd2015_5"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender = merge(x=exp_cases_by_age_gender, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender[is.na(exp_cases)]$exp_cases = 0
scale = sum(denominator_by_subgroup$patient_years)/200000
exp_cases = exp_cases_by_age_gender[,.(exp_cases=sum(exp_cases)/2, esp_population =sum(esp_population)/2), by = .(imd2015_5)]# standardized incidence per 100'000 patient-years
exp_cases_conf = epi.conf(as.matrix(exp_cases[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases[,incidence_stand_conf := paste(format(round(exp_cases_conf$est,1), nsmall = 1), " [",format(round(exp_cases_conf$lower,1), nsmall = 1),", ",format(round(exp_cases_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases[,disease := disease] # incidence rates per 100'000 years at risk
exp_cases[,year:= "All years"]
exp_cases

# Rbind 
exp_cases_by_year = rbind(exp_cases_by_year[,-("scale")], exp_cases)
setnames(exp_cases_by_year, old = "exp_cases", new = "incidence_stand")
incidence_table_unadjusted = rbind(incidence_table_unadjusted, incidence_table_unadjusted_all_years)
incidence_table = merge(exp_cases_by_year, incidence_table_unadjusted, by = c("year", "imd2015_5", "disease")) 
#class(exp_cases_by_year$year)
#class(incidence_table_unadjusted$year)
#incidence_table_unadjusted
incidence_table = incidence_table[order(year)]
setcolorder(incidence_table, c("disease", "year", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf", "incidence_stand", "incidence_stand_conf"))
return(incidence_table)
}

# incidence by SES, GENDER and YEAR
compute_incidence_by_ses_gender_year = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0

# crude incidence
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(year, gender_name, imd2015_5)]
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
# crude incidence all years
incidence_table_unadjusted_all_years = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by = .(gender_name, imd2015_5)]
incidence_table_unadjusted_all_years[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted_all_years[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted_all_years [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted_all_years[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted_all_years[,year:= "All years"]

# standardised incidence
numerator_by_age_gender_year = numerator_by_subgroup[,.(cases=sum(cases)), by=.(year, age_group, gender_name, imd2015_5)]
denominator_by_age_gender_year = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(year, age_group, gender_name, imd2015_5)]
exp_cases_by_age_gender_year = merge(x=numerator_by_age_gender_year[, .(year, age_group, gender_name, imd2015_5, cases)], y= denominator_by_age_gender_year, by = c("year", "gender_name", "age_group", "imd2015_5"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender_year = merge(x=exp_cases_by_age_gender_year, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender_year[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender_year[is.na(exp_cases)]$exp_cases = 0
#scale = sum(denominator_by_subgroup$patient_years)/100000
exp_cases_by_year = exp_cases_by_age_gender_year[,.(exp_cases=sum(exp_cases), esp_population =sum(esp_population), scale = sum(patient_years)/200000), by=.(year, gender_name, imd2015_5)]# standardized incidence per 100'000 patient-years
#exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]
exp_cases_by_year_conf = epi.conf(as.matrix(exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases_by_year[,incidence_stand_conf := paste(format(round(exp_cases_by_year_conf$est,1), nsmall = 1), " [",format(round(exp_cases_by_year_conf$lower,1), nsmall = 1),", ",format(round(exp_cases_by_year_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases_by_year[,disease := disease]
exp_cases_by_year

# standardised incidence all years
numerator_by_age_gender = numerator_by_subgroup[,.(cases=sum(cases)), by=.(age_group, gender_name, imd2015_5)]
denominator_by_age_gender = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(age_group, gender_name, imd2015_5)]
exp_cases_by_age_gender = merge(x=numerator_by_age_gender[, .(age_group, gender_name, imd2015_5, cases)], y= denominator_by_age_gender, by = c( "gender_name", "age_group", "imd2015_5"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender = merge(x=exp_cases_by_age_gender, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender[is.na(exp_cases)]$exp_cases = 0
scale = sum(denominator_by_subgroup$patient_years)/200000
exp_cases = exp_cases_by_age_gender[,.(exp_cases=sum(exp_cases), esp_population =sum(esp_population)), by = .(gender_name, imd2015_5)]# standardized incidence per 100'000 patient-years
exp_cases_conf = epi.conf(as.matrix(exp_cases[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases[,incidence_stand_conf := paste(format(round(exp_cases_conf$est,1), nsmall = 1), " [",format(round(exp_cases_conf$lower,1), nsmall = 1),", ",format(round(exp_cases_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases[,disease := disease] # incidence rates per 100'000 years at risk
exp_cases[,year:= "All years"]
exp_cases

# Rbind 
exp_cases_by_year = rbind(exp_cases_by_year[,-("scale")], exp_cases)
setnames(exp_cases_by_year, old = "exp_cases", new = "incidence_stand")
incidence_table_unadjusted = rbind(incidence_table_unadjusted, incidence_table_unadjusted_all_years)
incidence_table = merge(exp_cases_by_year, incidence_table_unadjusted, by = c("year", "gender_name", "imd2015_5", "disease")) 
#class(exp_cases_by_year$year)
#class(incidence_table_unadjusted$year)
#incidence_table_unadjusted
incidence_table = incidence_table[order(year)]
setcolorder(incidence_table, c("disease", "year", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf", "incidence_stand", "incidence_stand_conf"))
return(incidence_table)
}

# incidence by REGION and year
compute_incidence_by_region_year = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0

# crude incidence
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(year, region_name)]
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
# crude incidence all years
incidence_table_unadjusted_all_years = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by = .(region_name)]
incidence_table_unadjusted_all_years[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted_all_years[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted_all_years [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted_all_years[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted_all_years[,year:= "All years"]

# standardised incidence
numerator_by_age_gender_year = numerator_by_subgroup[,.(cases=sum(cases)), by=.(year, age_group, gender_name, region_name)]
denominator_by_age_gender_year = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(year, age_group, gender_name, region_name)]
exp_cases_by_age_gender_year = merge(x=numerator_by_age_gender_year[, .(year, age_group, gender_name, region_name, cases)], y= denominator_by_age_gender_year, by = c("year", "gender_name", "age_group", "region_name"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender_year = merge(x=exp_cases_by_age_gender_year, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender_year[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender_year[is.na(exp_cases)]$exp_cases = 0
#scale = sum(denominator_by_subgroup$patient_years)/100000
exp_cases_by_year = exp_cases_by_age_gender_year[,.(exp_cases=sum(exp_cases)/2, esp_population =sum(esp_population)/2, scale = sum(patient_years)/200000), by=.(year, region_name)]# standardized incidence per 100'000 patient-years
#exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]
exp_cases_by_year_conf = epi.conf(as.matrix(exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases_by_year[,incidence_stand_conf := paste(format(round(exp_cases_by_year_conf$est,1), nsmall = 1), " [",format(round(exp_cases_by_year_conf$lower,1), nsmall = 1),", ",format(round(exp_cases_by_year_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases_by_year[,disease := disease]
exp_cases_by_year

# standardised incidence all years
numerator_by_age_gender = numerator_by_subgroup[,.(cases=sum(cases)), by=.(age_group, gender_name, region_name)]
denominator_by_age_gender = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(age_group, gender_name, region_name)]
exp_cases_by_age_gender = merge(x=numerator_by_age_gender[, .(age_group, gender_name, region_name, cases)], y= denominator_by_age_gender, by = c( "gender_name", "age_group", "region_name"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender = merge(x=exp_cases_by_age_gender, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender[is.na(exp_cases)]$exp_cases = 0
scale = sum(denominator_by_subgroup$patient_years)/200000
exp_cases = exp_cases_by_age_gender[,.(exp_cases=sum(exp_cases)/2, esp_population =sum(esp_population)/2), by = .(region_name)]# standardized incidence per 100'000 patient-years
exp_cases_conf = epi.conf(as.matrix(exp_cases[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases[,incidence_stand_conf := paste(format(round(exp_cases_conf$est,1), nsmall = 1), " [",format(round(exp_cases_conf$lower,1), nsmall = 1),", ",format(round(exp_cases_conf$upper,1), nsmall = 1), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases[,disease := disease] # incidence rates per 100'000 years at risk
exp_cases[,year:= "All years"]
exp_cases

# Rbind 
exp_cases_by_year = rbind(exp_cases_by_year[,-("scale")], exp_cases)
setnames(exp_cases_by_year, old = "exp_cases", new = "incidence_stand")
incidence_table_unadjusted = rbind(incidence_table_unadjusted, incidence_table_unadjusted_all_years)
incidence_table = merge(exp_cases_by_year, incidence_table_unadjusted, by = c("year", "region_name", "disease")) 
#class(exp_cases_by_year$year)
#class(incidence_table_unadjusted$year)
#incidence_table_unadjusted
incidence_table = incidence_table[order(year)]
setcolorder(incidence_table, c("disease", "year", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf", "incidence_stand", "incidence_stand_conf"))
return(incidence_table)
}

# incidence by age-group and year
compute_incidence_by_age_group_year = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0
incidence_table = merge(x=incidence_table, y = unique(age_group_table[,.(age_group, age_group6)]), by = "age_group", all.x = TRUE)
incidence_table

# crude incidence
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(year, age_group6)]
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted
# crude incidence all years
incidence_table_unadjusted_all_years = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by = .(age_group6)]
incidence_table_unadjusted_all_years[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted_all_years[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted_all_years [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,1), nsmall = 1), " [",format(round(incidence_table_unadjusted_conf$lower,1), nsmall = 1),", ",format(round(incidence_table_unadjusted_conf$upper,1), nsmall = 1), "]",sep="")]
incidence_table_unadjusted_all_years[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted_all_years[,year:= "All years"]
incidence_table = incidence_table_unadjusted
incidence_table = incidence_table[order(year)]
setcolorder(incidence_table, c("disease", "year", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf"))
return(incidence_table)
}

# incidence by year
compute_incidence_by_year = function (numerator_by_subgroup, denominator_by_subgroup, disease) 
{
incidence_table = merge(numerator_by_subgroup, denominator_by_subgroup, by= c("year", "age_group", "gender_name", "imd2015_5", "region_name"), all = TRUE)
incidence_table[is.na(cases)]$cases = 0
incidence_table
#write.table(incidence_table, file.path(PATH_P,"CVD_incidence_table.txt"), sep="\t")
# crude incidence
incidence_table_unadjusted = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years)), by=.(year)]
incidence_table_unadjusted[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,0), big.mark=" ",nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,0), big.mark=" ",nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,0), big.mark=" ",nsmall = 0), "]",sep="")]
incidence_table_unadjusted[,disease := disease] # incidence rates per 100'000 years at risk
# crude incidence all years
incidence_table_unadjusted_all_years = incidence_table[,.(cases=sum(cases), patient_years= sum(patient_years))]
incidence_table_unadjusted_all_years[,incidence_unadjusted:= round(100000*cases / patient_years,5)]
incidence_table_unadjusted_conf = epi.conf(as.matrix(incidence_table_unadjusted_all_years[,.(cases, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
incidence_table_unadjusted_all_years [,incidence_unadjusted_conf := paste(format(round(incidence_table_unadjusted_conf$est,0), big.mark=" ", nsmall = 0), " [",format(round(incidence_table_unadjusted_conf$lower,0), big.mark=" ", nsmall = 0),", ",format(round(incidence_table_unadjusted_conf$upper,0), big.mark=" ", nsmall = 0), "]",sep="")]
incidence_table_unadjusted_all_years[,disease := disease] # incidence rates per 100'000 years at risk
incidence_table_unadjusted_all_years[,year:= "All years"]
incidence_table_unadjusted_all_years

# standardised incidence
numerator_by_age_gender_year = numerator_by_subgroup[,.(cases=sum(cases)), by=.(year, age_group, gender_name)]
denominator_by_age_gender_year = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(year, age_group, gender_name)]
exp_cases_by_age_gender_year = merge(x=numerator_by_age_gender_year[, .(year, age_group, gender_name, cases)], y= denominator_by_age_gender_year, by = c("year", "gender_name", "age_group"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender_year = merge(x=exp_cases_by_age_gender_year, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender_year[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender_year[is.na(exp_cases)]$exp_cases = 0
#scale = sum(denominator_by_subgroup$patient_years)/100000
exp_cases_by_age_gender_year
#write.table(exp_cases_by_age_gender_year, file.path(PATH_P,"CVD_exp_cases_by_age_gender_year.txt"), sep="\t")
exp_cases_by_year = exp_cases_by_age_gender_year[,.(exp_cases=sum(exp_cases)/2, esp_population =sum(esp_population)/2, scale = sum(patient_years)/200000), by=.(year)]# standardized incidence per 100'000 patient-years
#exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]
exp_cases_by_year_conf = epi.conf(as.matrix(exp_cases_by_year[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases_by_year[,incidence_stand_conf := paste(format(round(exp_cases_by_year_conf$est,0), big.mark=" ", nsmall = 0), " [",format(round(exp_cases_by_year_conf$lower,0), big.mark=" ", nsmall = 0),", ",format(round(exp_cases_by_year_conf$upper,0), big.mark=" ", nsmall = 0), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases_by_year[,disease := disease]
exp_cases_by_year

# standardised incidence all years
numerator_by_age_gender = numerator_by_subgroup[,.(cases=sum(cases)), by=.(age_group, gender_name)]
denominator_by_age_gender = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(age_group, gender_name)]
exp_cases_by_age_gender = merge(x=numerator_by_age_gender[, .(age_group, gender_name, cases)], y= denominator_by_age_gender, by = c( "gender_name", "age_group"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender = merge(x=exp_cases_by_age_gender, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender[is.na(exp_cases)]$exp_cases = 0
scale = sum(denominator_by_subgroup$patient_years)/200000
exp_cases = exp_cases_by_age_gender[,.(exp_cases=sum(exp_cases)/2, esp_population =sum(esp_population)/2)]# standardized incidence per 100'000 patient-years
exp_cases_conf = epi.conf(as.matrix(exp_cases[,.(exp_cases*scale, esp_population*scale)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases[,incidence_stand_conf := paste(format(round(exp_cases_conf$est,0), big.mark=" ", nsmall = 0), " [",format(round(exp_cases_conf$lower,0), big.mark=" ", nsmall = 0),", ",format(round(exp_cases_conf$upper,0), big.mark=" ", nsmall = 0), "]",sep="")]
#exp_cases_by_year = data.table::dcast(exp_cases_by_year, 1 ~ year, value.var = c("exp_cases"))
#setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases[,disease := disease] # incidence rates per 100'000 years at risk
exp_cases[,year:= "All years"]
exp_cases

# Rbind 
exp_cases_by_year = rbind(exp_cases_by_year[,-("scale")], exp_cases)
setnames(exp_cases_by_year, old = "exp_cases", new = "incidence_stand")
incidence_table_unadjusted = rbind(incidence_table_unadjusted, incidence_table_unadjusted_all_years)
incidence_table = merge(exp_cases_by_year, incidence_table_unadjusted, by = c("year", "disease")) 
#class(exp_cases_by_year$year)
#class(incidence_table_unadjusted$year)
#incidence_table_unadjusted
incidence_table = incidence_table[order(year)]
setcolorder(incidence_table, c("disease", "year", "cases", "patient_years", "incidence_unadjusted", "incidence_unadjusted_conf", "incidence_stand", "incidence_stand_conf"))
return(incidence_table)
}

# year-group function
year_group_fun = function (data){
if (lookback_period <=366*2)
{
data[, year_group := ""]
data[year < 2003, year_group := "2000-2002"]
data[year >= 2003 & year<=2005, year_group := "2003-2005"]
data[year >= 2006 & year<=2008, year_group := "2006-2008"]
data[year >= 2009 & year<=2011, year_group := "2009-2011"]
data[year >= 2012 & year<=2014, year_group := "2012-2014"]
data[year >= 2015 & year<=2016, year_group := "2015-2016"]
data[year >= 2017 , year_group := "2017-2019"]
}
else 
{
data[, year_group := ""]
data[year < 2005, year_group := "2002-2004"]
data[year >= 2005 & year<=2007, year_group := "2005-2007"]
data[year >= 2008 & year<=2010, year_group := "2008-2010"]
data[year >= 2011 & year<=2013, year_group := "2011-2013"]
data[year >= 2014 & year<=2016, year_group := "2014-2016"]
data[year >= 2017 , year_group := "2017-2019"]
}
return(data)}

year_group_fun_2005_2007 = function (data){
data[, year_group := ""]
data[year < 2005, year_group := "2000-2004"]
data[year >= 2005 & year<=2007, year_group := "2005-2007"]
data[year >= 2008 & year<=2011, year_group := "2008-2011"]
data[year >= 2012 & year<=2016, year_group := "2012-2016"]
data[year >= 2017 , year_group := "2017-2019"]
return(data)}

#  Age-gender-standardized expected cases by year-group
compute_standardized_incidence_by_year_group_CI = function (numerator_by_subgroup, denominator_by_subgroup, disease){
numerator_by_subgroup =  year_group_fun(numerator_by_subgroup)
denominator_by_subgroup =  year_group_fun(denominator_by_subgroup)
numerator_by_age_gender_year = numerator_by_subgroup[,.(cases=sum(cases)), by=.(year_group, age_group, gender_name)]
denominator_by_age_gender_year = denominator_by_subgroup[,.(patient_years=sum(patient_years)), by=.(year_group, age_group, gender_name)]
exp_cases_by_age_gender_year = merge(x=numerator_by_age_gender_year[, .(year_group, age_group, gender_name, cases)], y= denominator_by_age_gender_year, by = c("year_group", "gender_name", "age_group"), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_age_gender_year = merge(x=exp_cases_by_age_gender_year, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_age_gender_year[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_age_gender_year[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_year = exp_cases_by_age_gender_year[,.(cases = sum(cases), patient_years = sum(patient_years), exp_cases=sum(exp_cases)/2), by=.(year_group)] # exp_cases = standardized incidence per 100'000 patient-years
exp_cases_by_year = exp_cases_by_year[order(year_group)]
exp_cases_by_year_conf = epi.conf(as.matrix(exp_cases_by_year[,.(exp_cases*patient_years/100000, patient_years)]), ctype = "inc.rate", method = "exact", N = nrow(num_denom), design = 1, conf.level = 0.95) * 100000
exp_cases_by_year_conf
exp_cases_by_year_conf = data.table(exp_cases_by_year_conf)
exp_cases_by_year_conf [,incidence_conf := paste(format(round(exp_cases_by_year_conf$est,0), big.mark=" ", nsmall = 0), " [",format(round(exp_cases_by_year_conf$lower,0), big.mark=" ",nsmall = 0),", ",format(round(exp_cases_by_year_conf$upper,0), big.mark=" ",nsmall = 0), "]",sep="")]
exp_cases_by_year_conf # incidence rates per 100'000 years at risk
exp_cases_by_year = cbind(exp_cases_by_year, exp_cases_by_year_conf)
exp_cases_by_year = data.table::dcast(exp_cases_by_year[, .(year_group, incidence_conf)], 1 ~ year_group, value.var = c("incidence_conf"))
setnames(exp_cases_by_year, old = ".", new = "disease")
exp_cases_by_year[1,1] = disease
exp_cases_by_year
return(exp_cases_by_year)}

# Poisson regression over time
poisson_reg_stand_year_group = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{
exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = year_group_fun(exp_cases_all)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year_group, gender_name, age_group, imd2015_5, region_name)]
exp_cases_all
model=glm(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "factor(year_group)2017-2019"	
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}

poisson_reg_stand_model = function (numerator_by_subgroup, denominator_by_subgroup)
{exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = year_group_fun(exp_cases_all)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year_group, gender_name, age_group, imd2015_5, region_name)]
#exp_cases_all
model=glm(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
return(model)
}

# Poisson regression by gender
poisson_reg_stand_gender = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{exp_cases_all = merge(x=numerator_by_subgroup[,!"year_group"], y= denominator_by_subgroup[,!"year_group"], by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,gender_name := as.factor(gender_name)]
exp_cases_all$gender_name <- relevel(exp_cases_all$gender_name , ref = "Female")
exp_cases_all
model=glm(exp_cases~year+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "gender_nameMale"
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}

# Poisson regression by SES
poisson_reg_stand_ses = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{exp_cases_all = merge(x=numerator_by_subgroup[,!"year_group"], y= denominator_by_subgroup[,!"year_group"], by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,imd2015_5 := as.factor(imd2015_5)]
exp_cases_all$imd2015_5 <- relevel(exp_cases_all$imd2015_5 , ref = "1")
exp_cases_all
model=glm(exp_cases~year+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "gender_nameMale"
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}

# Poisson regression by SES and REGION
poisson_reg_stand_ses_region = function (numerator_by_subgroup, denominator_by_subgroup)
{
exp_cases_all = merge(x=numerator_by_subgroup[,!"year_group"], y= denominator_by_subgroup[,!"year_group"], by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,imd2015_5 := as.factor(imd2015_5)]
exp_cases_all$imd2015_5 <- relevel(exp_cases_all$imd2015_5 , ref = "1")
exp_cases_all[,region_name := as.factor(region_name)]
exp_cases_all$region_name <- relevel(exp_cases_all$region_name , ref = "London")
model=glm(exp_cases~year+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),scientific =FALSE, nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2),scientific =FALSE, nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), scientific =FALSE, nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "gender_nameMale"
#est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, factor = rownames(est_table), est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"]))
IRR[,est_ci := paste(estimates, " [", conf_int_2.5, ", ", conf_int_97.5, "]", sep="")]
return(IRR)
}

# Poisson regression by SEASON
poisson_reg_stand_season = function (numerator_by_subgroup, denominator_by_subgroup)
{
exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "season" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,season := as.factor(season)]
levels(exp_cases_all$season)
exp_cases_all$season <- relevel(exp_cases_all$season , ref = "Summer")
model=glm(exp_cases~as.factor(year)+season, family=poisson(link="log"), data=exp_cases_all)
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
IRR = data.table(cbind(disease = disease, factor = rownames(est_table), est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"]))
IRR[,est_ci := paste(estimates, " [", conf_int_2.5, ", ", conf_int_97.5, "]", sep="")]
return(IRR)
}

#season_table = data.table(season_num=seq(1:4), season = c("Winter", "Spring", "Summer", "Autumn"))
season_table = data.table(season_num=seq(1:12), season = c("Winter","Winter", "Winter", "Other","Other", "Summer", "Summer","Summer","Other","Other","Other","Other"))
#season_table
#date_to_season = function (data)
#{
#  season_num = ceiling(month(data$diag_date)/3)
#  data[,season:= season_table[season_num == season_num]]
#  #season = merge(season_num, season_table, by= season_num, all.x=TRUE)
#  return(season)
#}

# Compute mean age by SES and year
compute_mean_age_by_ses_year = function (disease, num_denom){
# by SES and year
mean_age_at_diag_table = data.table(disease = disease, year = "All years", imd2015_5 = "All", mean_age= mean(num_denom[disease_flag==1]$age_at_diag))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", imd2015_5 = "1", mean_age= mean(num_denom[imd2015_5 ==1 &disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", imd2015_5 = "2", mean_age= mean(num_denom[imd2015_5 ==2 &disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", imd2015_5 = "3", mean_age= mean(num_denom[imd2015_5 ==3 &disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", imd2015_5 = "4", mean_age= mean(num_denom[imd2015_5 ==4 &disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", imd2015_5 = "5", mean_age= mean(num_denom[imd2015_5 ==5 &disease_flag==1]$age_at_diag)))
for (year in 2000:2019){
mean_age_0 = mean(num_denom[diag_year == year & disease_flag==1]$age_at_diag)
mean_age_1 = mean(num_denom[diag_year == year & imd2015_5 ==1 & disease_flag==1]$age_at_diag)
mean_age_2 = mean(num_denom[diag_year == year & imd2015_5 ==2 & disease_flag==1]$age_at_diag)
mean_age_3 = mean(num_denom[diag_year == year & imd2015_5 ==3 & disease_flag==1]$age_at_diag)
mean_age_4 = mean(num_denom[diag_year == year & imd2015_5 ==4 & disease_flag==1]$age_at_diag)
mean_age_5 = mean(num_denom[diag_year == year & imd2015_5 ==5 & disease_flag==1]$age_at_diag)
new_row_0 = data.table(disease = disease, year = year, imd2015_5 = "All", mean_age = mean_age_0)
new_row_1 = data.table(disease = disease, year = year, imd2015_5 = "1", mean_age = mean_age_1)
new_row_2 = data.table(disease = disease, year = year, imd2015_5 = "2", mean_age = mean_age_2)
new_row_3 = data.table(disease = disease, year = year, imd2015_5 = "3", mean_age = mean_age_3)
new_row_4 = data.table(disease = disease, year = year, imd2015_5 = "4", mean_age = mean_age_4)
new_row_5 = data.table(disease = disease, year = year, imd2015_5 = "5", mean_age = mean_age_5)
mean_age_at_diag_table = rbind(mean_age_at_diag_table, new_row_0, new_row_1, new_row_2, new_row_3, new_row_4, new_row_5)}

# by year group
num_denom[,year:=diag_year]
num_denom = year_group_fun(num_denom)
mean_age_at_diag_table_yg = data.table(disease = disease, year_group = "2000-2002", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2000-2002" & disease_flag==1]$age_at_diag))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2003-2005", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2003-2005" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2006-2008", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2006-2008" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2009-2011", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2009-2011" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2012-2014", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2012-2014" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2015-2016", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2015-2016" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2017-2019", imd2015_5 = "All", mean_age= mean(num_denom[year_group == "2017-2019" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, mean_age_at_diag_table_yg, fill = TRUE)
return(mean_age_at_diag_table)}


compute_mean_age_by_gender_year = function (disease, num_denom){
# by GENDER and year
mean_age_at_diag_table = data.table(disease = disease, year = "All years", gender_name = "All", mean_age= mean(num_denom[disease_flag==1]$age_at_diag))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", gender_name = "Male", mean_age= mean(num_denom[gender_name =="Male" &disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, data.table(disease = disease, year = "All years", gender_name = "Female", mean_age= mean(num_denom[gender_name == "Female" &disease_flag==1]$age_at_diag)))
for (year in 2000:2019){
mean_age_0 = mean(num_denom[diag_year == year & disease_flag==1]$age_at_diag)
mean_age_1 = mean(num_denom[diag_year == year & gender_name =="Male" & disease_flag==1]$age_at_diag)
mean_age_2 = mean(num_denom[diag_year == year & gender_name == "Female" & disease_flag==1]$age_at_diag)
new_row_0 = data.table(disease = disease, year = year, gender_name = "All", mean_age = mean_age_0)
new_row_1 = data.table(disease = disease, year = year, gender_name = "Male", mean_age = mean_age_1)
new_row_2 = data.table(disease = disease, year = year, gender_name = "Female", mean_age = mean_age_2)
mean_age_at_diag_table = rbind(mean_age_at_diag_table, new_row_0, new_row_1, new_row_2)}

# by year group
num_denom[,year:=diag_year]
num_denom = year_group_fun(num_denom)
mean_age_at_diag_table_yg = data.table(disease = disease, year_group = "2000-2002", gender_name = "All", mean_age= mean(num_denom[year_group == "2000-2002" & disease_flag==1]$age_at_diag))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2003-2005", gender_name = "All", mean_age= mean(num_denom[year_group == "2003-2005" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2006-2008", gender_name = "All", mean_age= mean(num_denom[year_group == "2006-2008" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2009-2011", gender_name = "All", mean_age= mean(num_denom[year_group == "2009-2011" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2012-2014", gender_name = "All", mean_age= mean(num_denom[year_group == "2012-2014" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2015-2016", gender_name = "All", mean_age= mean(num_denom[year_group == "2015-2016" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table_yg = rbind(mean_age_at_diag_table_yg, data.table(disease = disease, year_group = "2017-2019", gender_name = "All", mean_age= mean(num_denom[year_group == "2017-2019" & disease_flag==1]$age_at_diag)))
mean_age_at_diag_table = rbind(mean_age_at_diag_table, mean_age_at_diag_table_yg, fill = TRUE)
return(mean_age_at_diag_table)}


# Negative binomial regression over time
negbin_reg_stand_year_group = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{
exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = year_group_fun(exp_cases_all)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year_group, gender_name, age_group, imd2015_5, region_name)]
exp_cases_all
#fwrite(exp_cases_all, file.path(PATH_W, paste(disease_short, "_exp_cases_all.txt", sep ="")))
#model=glm(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, data = exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "factor(year_group)2017-2019"	
est_table
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}

# Negative binomial regression over time - sensitivity analyses comparing to 2005-2007 period
negbin_reg_stand_year_group_sens_2005_2007 = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{
exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = exp_cases_all[year>2004]
exp_cases_all = year_group_fun_2005_2007(exp_cases_all)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year_group, gender_name, age_group, imd2015_5, region_name)]
exp_cases_all
#model=glm(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, data = exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "factor(year_group)2017-2019"	
est_table
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}


negbin_reg_stand_model = function (numerator_by_subgroup, denominator_by_subgroup)
{exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = year_group_fun(exp_cases_all)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year_group, gender_name, age_group, imd2015_5, region_name)]
#exp_cases_all
#model=glm(exp_cases~factor(year_group)+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~factor(year_group)+age_group+gender_name+as.factor(imd2015_5)+region_name, data = exp_cases_all)
return(model)
}

# Negative binomial regression by gender
negbin_reg_stand_gender = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{  exp_cases_all = merge(x=numerator_by_subgroup[,!"year_group"], y= denominator_by_subgroup[,!"year_group"], by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,gender_name := as.factor(gender_name)]
exp_cases_all$gender_name <- relevel(exp_cases_all$gender_name , ref = "Female")
exp_cases_all
#model=glm(exp_cases~year+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~year+gender_name+as.factor(imd2015_5)+region_name, data = exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "gender_nameMale"
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}

# Negative binomial regression by SES
negbin_reg_stand_ses = function (numerator_by_subgroup, denominator_by_subgroup, factor)
{exp_cases_all = merge(x=numerator_by_subgroup[,!"year_group"], y= denominator_by_subgroup[,!"year_group"], by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,imd2015_5 := as.factor(imd2015_5)]
exp_cases_all$imd2015_5 <- relevel(exp_cases_all$imd2015_5 , ref = "1")
exp_cases_all
#model=glm(exp_cases~year+gender_name+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~year+gender_name+as.factor(imd2015_5)+region_name, data = exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "gender_nameMale"
est_table
est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"], IRR = paste(est_table["estimates"], " [", est_table["conf_int_2.5"], ", ", est_table["conf_int_97.5"], "]", sep="")))
return(IRR)
}

# Negative binomial regression by SES and REGION
negbin_reg_stand_ses_region = function (numerator_by_subgroup, denominator_by_subgroup)
{
exp_cases_all = merge(x=numerator_by_subgroup[,!"year_group"], y= denominator_by_subgroup[,!"year_group"], by = c("year", "gender_name", "age_group", "imd2015_5", "region_name" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,imd2015_5 := as.factor(imd2015_5)]
exp_cases_all$imd2015_5 <- relevel(exp_cases_all$imd2015_5 , ref = "1")
exp_cases_all[,region_name := as.factor(region_name)]
exp_cases_all$region_name <- relevel(exp_cases_all$region_name , ref = "London")
#model=glm(exp_cases~year+as.factor(imd2015_5)+region_name, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~year+as.factor(imd2015_5)+region_name, data = exp_cases_all)
#kable(data.frame(estimates=round(exp(coef(model)),2), conf_int_2.5=round(exp(confint.default(model))[,1],2), conf_int_97.5=round(exp(confint.default(model))[,2],2), pval = summary(model)$coef[,"Pr(>|z|)"] ))
est_table = data.frame(estimates=format(round(exp(coef(model)),2),scientific =FALSE, nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2),scientific =FALSE, nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), scientific =FALSE, nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
#factor = "gender_nameMale"
#est_table = subset(est_table, row.names(est_table) == factor)
IRR = data.table(cbind(disease = disease, factor = rownames(est_table), est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"]))
IRR[,est_ci := paste(estimates, " [", conf_int_2.5, ", ", conf_int_97.5, "]", sep="")]
return(IRR)
}

# Negative binomial regression by SEASON
negbin_reg_stand_season = function (numerator_by_subgroup, denominator_by_subgroup)
{
exp_cases_all = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, by = c("year", "gender_name", "age_group", "season" ), all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_all = merge(x=exp_cases_all, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_all[,exp_cases:= round((cases/ patient_years)*esp_population,2)]
exp_cases_all[is.na(exp_cases)]$exp_cases = 0
#exp_cases_all = exp_cases_all[,.(exp_cases=sum(exp_cases)), by=.(year, gender_name, age_group, imd2015_5, region_name)]
# refactor reference level
exp_cases_all[,season := as.factor(season)]
levels(exp_cases_all$season)
exp_cases_all$season <- relevel(exp_cases_all$season , ref = "Summer")
#model=glm(exp_cases~as.factor(year)+season, family=poisson(link="log"), data=exp_cases_all)
model=glm.nb(exp_cases~factor(year)+season, data = exp_cases_all)
est_table = data.frame(estimates=format(round(exp(coef(model)),2),nsmall=2), conf_int_2.5=format(round(exp(confint.default(model))[,1],2), nsmall=2), conf_int_97.5=format(round(exp(confint.default(model))[,2],2), nsmall=2), pval = summary(model)$coef[,"Pr(>|z|)"] )
IRR = data.table(cbind(disease = disease, factor = rownames(est_table), est = est_table["estimates"], conf_int_2.5 = est_table["conf_int_2.5"], conf_int_97.5 = est_table["conf_int_97.5"]))
IRR[,est_ci := paste(estimates, " [", conf_int_2.5, ", ", conf_int_97.5, "]", sep="")]
return(IRR)
}
```


# Import data
```{r, warning=FALSE, message=FALSE}
# all first diagnoses -- INCLUDING additionals (BMI and smoking)!
#NEW file : CVD_diagnoses_first_add_comord.txt.gz

diagnoses_all_first_denom= fread(file.path(PATH_W_CVD,"CVD_diagnoses_first_add_comord.txt.gz"), colClasses=c("patid"="integer64", "eventdate"="Date", "first_AD_date"="Date" , "first_INF_date"="Date", "first_HER_date"="Date", "first_CVD_date"="Date", "first_CVD_hes_primary_date"="Date", "regdate"="Date", "end_date"="Date", "start_date"="Date", "lcdate"="Date", "todate"="Date")) 
# all first diagnoses for diseases included in the study
# includes additionals (BMI, smoking, comorbidities, ethnicity and drug prescriptions)
#num_denom_0= fread(file.path(PATH_W,"CVD_incidence_num_denom_0.txt.gz"))
#diagnoses_all_first_denom[database == "ONS AURUM" ]

# CHECKS
format(nrow(diagnoses_all_first_denom), big.mark="'")  
levels(as.factor(diagnoses_all_first_denom$database))
levels(as.factor(diagnoses_all_first_denom$disease))
head(diagnoses_all_first_denom)
summary(diagnoses_all_first_denom$eventdate)
summary(diagnoses_all_first_denom$BMI)
nrow(diagnoses_all_first_denom[eventdate>as.Date("2019-12-30")])
diagnoses_all_first_denom[is.na(start_date)]
diagnoses_all_first_denom[is.na(end_date)]

# Sensitivity analyes including / excluding diagnoses recorded on death certificates
include_death
if (include_death == "no") {
  diagnoses_all_first_denom = diagnoses_all_first_denom[!database %in% c("ONS AURUM", "ONS GOLD")] # exclude any first diagnosis recorded as part of death certificate
}
format(nrow(diagnoses_all_first_denom), big.mark="'")  
levels(as.factor(diagnoses_all_first_denom$database))

# Denominator
denominator= fread(file.path(PATH_W_all,"denominator_first_release.txt.gz"), colClasses=c("patid"="integer64", "regdate"="Date", "end_date"="Date", "start_date"="Date", "lcdate"="Date", "todate"="Date", "dod"="Date")) # all first diagnoses for diseases included in the study
format(nrow(denominator), big.mark="'")

# Ethnicity
# ethnicity_all = fread(file.path(PATH_W_all,"ALL_ethnicity_all.txt.gz")) ## Ethnicity data from all individuals in CPRD. Latest ethnicity measurement from primary and secondary care. When ethnicity differed between primary and secondary care records, secondary care data was used.
# format(nrow(denominator), big.mark="'")
# head(ethnicity_all)
# levels(as.factor(ethnicity_all$ethnicity_category1))

# Num_denom_0
#num_denom_0 = fread(file.path(PATH_W_CVD,"CVD_incidence_num_denom_0.txt.gz")) 
#format(nrow(num_denom_0), big.mark="'")
#colnames(num_denom_0)

# Num_denom_0
#first_CVD_diagnosis_accross_all_conditions = fread(file.path(PATH_W_CVD,"first_CVD_diagnosis_accross_all_conditions.txt.gz")) 
#format(nrow(first_CVD_diagnosis_accross_all_conditions), big.mark="'")
#colnames(first_CVD_diagnosis_accross_all_conditions)
```


# Incidence dataset overview
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# dataset overview
nrow(diagnoses_all_first_denom[is.na(gold_db) & is.na(aurum_db)]) # CHECK that this is 0
format(nrow(diagnoses_all_first_denom), big.mark="'")  

# Set birth date at 30/06 of birth year
diagnoses_all_first_denom[,birth_date := as.Date(paste(birthyear,"-06-30", sep=""), format="%Y-%m-%d")]

# Checks
class(diagnoses_all_first_denom$regdate)
class(diagnoses_all_first_denom$end_date)
class(diagnoses_all_first_denom$eventdate)
class(diagnoses_all_first_denom$start_date)
class(diagnoses_all_first_denom$birth_date)
class(diagnoses_all_first_denom$eventdate)
table(diagnoses_all_first_denom$gender_name)
class(diagnoses_all_first_denom$imd2015_5)
class(diagnoses_all_first_denom$region_name)
head(diagnoses_all_first_denom)
nrow(diagnoses_all_first_denom[is.na(start_date)])
nrow(diagnoses_all_first_denom[is.na(eventdate)])
summary(diagnoses_all_first_denom$eventdate)
```

# Exclude diagnoses outside of range (after patient end date, priod to start date of within lookback period)
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Exclude any diagnoses after patient's end-date
format(nrow(diagnoses_all_first_denom[eventdate>end_date]), big.mark="'") 
diagnoses_all_first_denom_end = diagnoses_all_first_denom[eventdate<=pmin(end_date, study_end_date)] # exclude diagnoses recorded after patient's end of registration
format(nrow(diagnoses_all_first_denom_end), big.mark="'")
summary(diagnoses_all_first_denom_end$eventdate)

# Exclude any diagnoses prior to patient's start-date
head(diagnoses_all_first_denom_end[eventdate<start_date])
format(nrow(diagnoses_all_first_denom_end[eventdate<start_date | eventdate<study_start_date]), big.mark="'") 
diagnoses_all_first_denom_end_start = diagnoses_all_first_denom_end[eventdate>=start_date & eventdate>=study_start_date] # exclude diagnoses recorded prior to patient's start-date (latest of registration start / birthdate / practice's up to standard date / study start)
format(nrow(diagnoses_all_first_denom_end_start), big.mark="'") 
summary(diagnoses_all_first_denom_end_start$eventdate)
diagnoses_all_first_denom_end_start

# Exclude any diagnoses within the lookback_period (first 12 month of GP registration)
lookback_period
format(nrow(diagnoses_all_first_denom_end_start[eventdate<regdate+lookback_period]), big.mark="'") 
diagnoses_all_first_denom_12 = diagnoses_all_first_denom_end_start[eventdate>=regdate+lookback_period]
format(nrow(diagnoses_all_first_denom_12), big.mark="'") 
#diagnoses_all_first_denom_12 = diagnoses_all_first_denom_end_start
```

# Incidence disease flags by disease
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Num-denom table
# Transform diagnoses into long format with flag and date for each condition
diagnoses_all_first_long1 = data.table::dcast(diagnoses_all_first_denom_12, db_patid ~ paste(disease_short, "_flag", sep=""), value.var = c("disease"), fun.aggregate = list(length))
head(diagnoses_all_first_long1)

#diagnoses_all_first_denom_12[, count_d:= .N, by = c("db_patid", "disease_short")] # check for duplicate codes within each condition
#diagnoses_all_first_denom_12[count_d>1]
#diagnoses_all_first_denom_12[db_patid == "A1000089020274"]

diagnoses_all_first_long2 = data.table::dcast(diagnoses_all_first_denom_12, db_patid ~ paste(disease_short, "_date", sep=""), value.var = c("eventdate"))
head(diagnoses_all_first_long2)
diagnoses_all_first_long = merge(diagnoses_all_first_long1, diagnoses_all_first_long2, by = c("db_patid"), all = TRUE )
head(diagnoses_all_first_long)
format(nrow(diagnoses_all_first_long), big.mark="'") 
colnames(diagnoses_all_first_long)
#summary(diagnoses_all_first_long$INS_flag)
#summary(diagnoses_all_first_long$ADD_flag)

# Create "num_denom" file - that includes numerator (diagnoses) and denominator (patient days) information
num_denom_0 = merge(diagnoses_all_first_long, denominator, by = c("db_patid"), all = TRUE )
head(num_denom_0)
nrow(num_denom_0)

# Set NA flags to 0
num_denom_0[is.na(AAN_flag), AAN_flag:=0]; num_denom_0[is.na(AFF_flag), AFF_flag:=0]; num_denom_0[is.na(AMI_flag), AMI_flag:=0]; num_denom_0[is.na(AOS_flag), AOS_flag:=0]; num_denom_0[is.na(CAO_flag), CAO_flag:=0]; num_denom_0[is.na(CHB_flag), CHB_flag:=0]; num_denom_0[is.na(HFA_flag), HFA_flag:=0]; num_denom_0[is.na(HST_flag), HST_flag:=0]; num_denom_0[is.na(IHD_flag), IHD_flag:=0]; num_denom_0[is.na(IHS_flag), IHS_flag:=0]; num_denom_0[is.na(MVD_flag), MVD_flag:=0]; num_denom_0[is.na(PAD_flag), PAD_flag:=0]; num_denom_0[is.na(PVD_flag), PVD_flag:=0]; num_denom_0[is.na(STR_flag), STR_flag:=0]; num_denom_0[is.na(SVT_flag), SVT_flag:=0];  num_denom_0[is.na(TIA_flag), TIA_flag:=0]; num_denom_0[is.na(TVD_flag), TVD_flag:=0]; num_denom_0[is.na(UNS_flag), UNS_flag:=0]; num_denom_0[is.na(UVD_flag), UVD_flag:=0]; num_denom_0[is.na(VAD_flag), VAD_flag:=0]; num_denom_0[is.na(VTE_flag), VTE_flag:=0]; num_denom_0[is.na(PMK_flag), PMK_flag:=0]; # for those without relevant diagnoses, set disease flag to 0
#num_denom_0[is.na(DIN_flag), DIN_flag:=0]

format(nrow(num_denom_0[is.na(UVD_flag)]), big.mark="'") # check that no flag is set to NA

# Create num_CVD variable = number of CVD disorders
num_denom_0[, num_CVD:= (AAN_flag + AOS_flag + AFF_flag + HFA_flag + AMI_flag + IHD_flag + CHB_flag + PAD_flag + STR_flag + VTE_flag)]
num_denom_0[, num_CVD_cat:= pmin(num_CVD,3)]
summary(num_denom_0$num_CVD)

# Create CVD variable for any CVD diagnosis
num_denom_0[, CVD:= pmax(AAN_flag, AOS_flag, AFF_flag, HFA_flag, AMI_flag, IHD_flag, CHB_flag, PAD_flag, STR_flag, VTE_flag)]
num_denom_0[, first_CVD_date:= pmin(AAN_date, AOS_date, AFF_date, HFA_date, AMI_date, IHD_date, CHB_date, PAD_date, STR_date, VTE_date, na.rm = TRUE)]
head(num_denom_0)
num_denom_0[, age_at_first_CVD_date:= year(first_CVD_date)-birthyear]
num_denom_0[is.na(CVD), CVD:= 0]
sum(num_denom_0$CVD)

summary(num_denom_0$AAN_date)
class(num_denom_0$regdate)

remove("diagnoses_all_first_denom_end", "diagnoses_all_first_denom_end_start")

```


# First CVD table across all conditions
## First CVD table across all conditions - Main table
```{r, eval=TRUE, warning=FALSE, message=FALSE}
#AAN_flag, AOS_flag, AFF_flag, HFA_flag, AMI_flag, IHD_flag, CHB_flag, PAD_flag, STR_flag, VTE_flag
#table(diagnoses_all_first_denom_12$disease)
first_CVD_diagnosis_accross_all_conditions = diagnoses_all_first_denom_12[disease %in% c("Aortic aneurysm", "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease", "Heart failure", "Myocardial infarction", "Peripheral arterial disease", "Heart block", "Stroke", "Venous thromboembolism")] # only cardiovascular diagnoses, only incident diagnoses during study period

#diagnoses_all_first_denom_12[duplicated(db_patid)]
#test = diagnoses_all_first_denom_12 [row_ID %in% c("G110095_STR", "G110095_IHS")]
#test = test[,.SD[which.min(eventdate)], by = .(db_patid)]
#test

first_CVD_diagnosis_accross_all_conditions = first_CVD_diagnosis_accross_all_conditions[,.SD[which.min(eventdate)], by = .(db_patid)]
colnames(first_CVD_diagnosis_accross_all_conditions)
#nrow(CVD_diagnoses_all_first_denom)-nrow(unique(CVD_diagnoses_all_first_denom[,.(row_ID)]))
#num_denom_0 = merge(x = num_denom_0, y = CVD_diagnoses_all_first_denom[,.(db_patid, BMI, smok_status_name)], by = "", all.x = TRUE) 
#head(first_CVD_diagnosis_accross_all_conditions)
#levels(as.factor(first_CVD_diagnosis_accross_all_conditions$database))

first_CVD_diagnosis_accross_all_conditions[, first_CVD_date:= eventdate] 
first_CVD_diagnosis_accross_all_conditions[, age_at_first_CVD_date:= year(first_CVD_date)-birthyear]
#first_CVD_diagnosis_accross_all_conditions = merge(x = first_CVD_diagnosis_accross_all_conditions, y = denominator[,.(db_patid, imd2015_5, region_name)], by = "db_patid", all.x = TRUE) 
first_CVD_diagnosis_accross_all_conditions = merge(x = first_CVD_diagnosis_accross_all_conditions, y = num_denom_0[,.(db_patid, num_CVD_cat)], by = "db_patid", all.x = TRUE) 
#table(as.factor(diagnoses_all_first_denom$region_name))
#head(first_CVD_diagnosis_accross_all_conditions)

# Diagnosis year and year-group
first_CVD_diagnosis_accross_all_conditions[, diag_year := year(first_CVD_date)]
first_CVD_diagnosis_accross_all_conditions[,diag_year_group:= "NA"]
first_CVD_diagnosis_accross_all_conditions[diag_year <= 2002 ,diag_year_group:= "2000-2002"]
first_CVD_diagnosis_accross_all_conditions[diag_year >= 2003 & diag_year <= 2005 ,diag_year_group:= "2003-2005"]
first_CVD_diagnosis_accross_all_conditions[diag_year >= 2006 & diag_year <= 2008 ,diag_year_group:= "2006-2008"]
first_CVD_diagnosis_accross_all_conditions[diag_year >= 2009 & diag_year <= 2011 ,diag_year_group:= "2009-2011"]
first_CVD_diagnosis_accross_all_conditions[diag_year >= 2012 & diag_year <= 2014 ,diag_year_group:= "2012-2014"]
first_CVD_diagnosis_accross_all_conditions[diag_year >= 2015 & diag_year <= 2016 ,diag_year_group:= "2015-2016"]
first_CVD_diagnosis_accross_all_conditions[diag_year >= 2017 & diag_year <= 2019 ,diag_year_group:= "2017-2019"]
table(first_CVD_diagnosis_accross_all_conditions$diag_year_group)
#first_CVD_diagnosis_accross_all_conditions[diag_year_group== "NA"]

# BMI categories
# WHO categories BMI <18.5: underweight. BMI 18.5-24.9: normal weight. BMI ≥25.0: overweight. BMI ≥30.0: obesity.
first_CVD_diagnosis_accross_all_conditions[,BMI_cat := ""]
#first_CVD_diagnosis_accross_all_conditions[,BMI_cat := NULL]
first_CVD_diagnosis_accross_all_conditions[BMI< 18.5, BMI_cat := "underweight"]
first_CVD_diagnosis_accross_all_conditions[BMI>= 18.5 & BMI< 25, BMI_cat := "normal weight"]
first_CVD_diagnosis_accross_all_conditions[BMI>= 25 & BMI< 30, BMI_cat := "overweight"]
first_CVD_diagnosis_accross_all_conditions[BMI>= 30, BMI_cat := "obesity"]
first_CVD_diagnosis_accross_all_conditions[is.na(BMI), BMI_cat := NA]
summary(as.factor(first_CVD_diagnosis_accross_all_conditions$BMI_cat))

# exclude records with SES = NA
nrow(first_CVD_diagnosis_accross_all_conditions[is.na(imd2015_5)])
first_CVD_diagnosis_accross_all_conditions = first_CVD_diagnosis_accross_all_conditions[!is.na(imd2015_5)]
nrow(first_CVD_diagnosis_accross_all_conditions[is.na(region_name)])

#check that there are no missing start/end dates
nrow(first_CVD_diagnosis_accross_all_conditions[is.na(start_date)])
nrow(first_CVD_diagnosis_accross_all_conditions[is.na(end_date)])
nrow(num_denom_0[is.na(start_date)])
nrow(num_denom_0[is.na(end_date)])
```

## First CVD table across all conditions - Ethnicity
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Merge with ethnicity table
table(diagnoses_all_first_denom_12$ethnicity_category1)
#first_CVD_diagnosis_accross_all_conditions[,-c("ethnicity_description", "ethnicity_category1", "ethnicity_category2", "ethnicity_source" )], y = ethnicity_all[,.(db_patid, ethnicity_description, ethnicity_category1, ethnicity_category2, ethnicity_source)], by = "db_patid", all.x = TRUE)
levels(as.factor(first_CVD_diagnosis_accross_all_conditions$ethnicity_category1))

first_CVD_diagnosis_accross_all_conditions[ethnicity_description=="", ethnicity_description:= NA]
first_CVD_diagnosis_accross_all_conditions[ethnicity_source=="", ethnicity_source:= NA]
first_CVD_diagnosis_accross_all_conditions[ethnicity_category1=="", ethnicity_category1:= NA]
first_CVD_diagnosis_accross_all_conditions[ethnicity_category2=="", ethnicity_category2:= NA]
first_CVD_diagnosis_accross_all_conditions[smok_status_name=="", smok_status_name:= NA]
first_CVD_diagnosis_accross_all_conditions[ethnicity_category1 %in% c("Mixed","Other") , ethnicity_category1:= "Mixed/Other"]
head(first_CVD_diagnosis_accross_all_conditions)
```


# Therapy
## Therapy -  First CVD table across all conditions (for table 1)
```{r table1, eval=F, warning=FALSE, message=FALSE}
# Therapy
#all_therapy = fread(file.path(PATH_W_CVD,"CVD_therapy_gold_aurum.txt.gz")) # CVD therapy for all patients with at least one CVD therapy at any time
#format(nrow(all_therapy), big.mark="'")
#colnames(all_therapy)

# Select to patients in the study (those with incident CVD during study period for the 10 main conditions)
#all_therapy = all_therapy[db_patid %in% first_CVD_diagnosis_accross_all_conditions$db_patid]
#format(nrow(all_therapy), big.mark="'")

# Merge therapy with diagnosis information
#all_therapy = merge( x= all_therapy, y = first_CVD_diagnosis_accross_all_conditions[,.(db_patid, disease, diag_date, gender_name, imd2015_5, diag_year_group, region_name)], by = "db_patid", all.x = TRUE, allow.cartesian = TRUE) #  patids are unique in "first_CVD_diagnosis_accross_all_conditions"
#format(nrow(all_therapy), big.mark="'")
#colnames(all_therapy)

# Select prescriptions within 6 months following diagnosis
#all_therapy = all_therapy[(eventdate >= diag_date -1) & (eventdate < diag_date +183) ]
#format(nrow(all_therapy), big.mark="'")

#fwrite(all_therapy, file.path(PATH_W_CVD,"CVD_therapy_gold_aurum_rest.txt.gz"))  # CVD therapy for all patients included in the study
# run on January 18th 2024

#
all_therapy = fread(file.path(PATH_W_CVD,"CVD_therapy_gold_aurum_rest.txt.gz")) # CVD therapy for all patients included in the study and within 6m of first CVD
#
all_therapy = all_therapy[db_patid %in% first_CVD_diagnosis_accross_all_conditions$db_patid]
#
all_therapy = all_therapy[(eventdate >= diag_date -1) & (eventdate < diag_date + 183) ]# CVD therapy for all patients included in the study and within 1 years of first CVD
#
format(nrow(all_therapy), big.mark="'")
#
colnames(all_therapy)

# Count prescriptions by drug type
#
all_therapy_count = all_therapy[, .(count = .N), by = c("db_patid", "drug_type")]
#
format(nrow(all_therapy_count), big.mark="'")
#
all_therapy_count

# Check early years 
#levels(as.factor(all_therapy$drug_type))
#all_therapy_check= all_therapy[drug_type == "Mineralocorticoid receptor antagonists" & year(eventdate) <= 2004]
#table(all_therapy_check$drugsubstance)
#table(all_therapy_check[drugsubstance == ""]$prodcode_unique_ID)
#all_therapy_check
# "Lipid-regulating Drugs", "Parenteral Anticoagulants" , "Mineralocorticoid receptor antagonists"                     
                     

# Select patients with at least 2 prescriptions
#
all_therapy_count_2 = all_therapy_count[count>=2]
#
format(nrow(all_therapy_count_2), big.mark="'")
#
all_therapy_count_2

# Add disease_short
#levels(as.factor(all_therapy_count_2$drug_type))
drug_short_table = data.table(drug_type = c("ACE Inhibitors", "Alpha adrenoceptor antagonists", "Antiplatelet therapy", "ARB", "Beta Blockers",  "Calcium-Channel Blockers - dihydropyridines", "Calcium-Channel Blockers - non-dihydropyridines", "Diuretics With Potassium",  "Fibrates" ,  "Lipid-regulating Drugs", "Loop Diuretics",  "Mineralocorticoid receptor antagonists",  "Nitrates", "Oral Anticoagulants - NOAC", "Oral Anticoagulants - Vitamin K Antagonists" ,  "Parenteral Anticoagulants",  "Potassium-sparing Diuretics", "Sacubitril/Valsartan", "Statins"  ,  "Thiazides"), drug_type_short = c("ACE", "AAA", "APT", "ARB", "BTB",  "CCD", "CCN", "DWP",  "FIB" ,  "LRD", "LDI",  "MRA",  "NIT", "NOA", "VKA" ,  "HEP",  "PSD", "SAV", "STA" ,  "THI"))
all_therapy_count_2 = merge(all_therapy_count_2, drug_short_table, by = "drug_type", all.x = TRUE)
all_therapy_count_2

# Transform diagnoses into long format with flag and date for each condition
all_therapy_count_2_long = data.table::dcast(all_therapy_count_2, db_patid ~ paste(drug_type_short, "_min2_6m_after_diag", sep=""), value.var = c("drug_type"), fun.aggregate = list(length))
head(all_therapy_count_2_long)
all_therapy_count_2_long

# Check
#all_therapy_count_2[db_patid == "A1000000620274"]
#all_therapy_count_2_long[db_patid == "A1000000620274"]
#ACE, Antiplatelet therapy, Beta Blockers, Loop Diuretics, Oral Anticoagulants - Vitamin K Antagonists, Statins

# Merge back with first CVD table
first_CVD_diagnosis_accross_all_conditions = merge(first_CVD_diagnosis_accross_all_conditions, all_therapy_count_2_long, by = c("db_patid"), all.x = TRUE )
head(first_CVD_diagnosis_accross_all_conditions)
nrow(first_CVD_diagnosis_accross_all_conditions)

# Set NA flags to 0
first_CVD_diagnosis_accross_all_conditions[is.na(ACE_min2_6m_after_diag), ACE_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(AAA_min2_6m_after_diag), AAA_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(APT_min2_6m_after_diag), APT_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(ARB_min2_6m_after_diag), ARB_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(BTB_min2_6m_after_diag), BTB_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(CCD_min2_6m_after_diag), CCD_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(CCN_min2_6m_after_diag), CCN_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(DWP_min2_6m_after_diag), DWP_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(FIB_min2_6m_after_diag), FIB_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(LRD_min2_6m_after_diag), LRD_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(LDI_min2_6m_after_diag), LDI_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(MRA_min2_6m_after_diag), MRA_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(NIT_min2_6m_after_diag), NIT_min2_6m_after_diag:=0]; first_CVD_diagnosis_accross_all_conditions[is.na(NOA_min2_6m_after_diag), NOA_min2_6m_after_diag:=0]; 
first_CVD_diagnosis_accross_all_conditions[is.na(VKA_min2_6m_after_diag), VKA_min2_6m_after_diag:=0]; 
first_CVD_diagnosis_accross_all_conditions[is.na(HEP_min2_6m_after_diag), HEP_min2_6m_after_diag:=0]; 
first_CVD_diagnosis_accross_all_conditions[is.na(PSD_min2_6m_after_diag), PSD_min2_6m_after_diag:=0]; 
first_CVD_diagnosis_accross_all_conditions[is.na(SAV_min2_6m_after_diag), SAV_min2_6m_after_diag:=0]; 
first_CVD_diagnosis_accross_all_conditions[is.na(STA_min2_6m_after_diag), STA_min2_6m_after_diag:=0]; 
first_CVD_diagnosis_accross_all_conditions[is.na(THI_min2_6m_after_diag), THI_min2_6m_after_diag:=0]; 
 # for those without relevant prescriptions, set disease flag to 0

format(nrow(first_CVD_diagnosis_accross_all_conditions[is.na(THI_min2_6m_after_diag)]), big.mark="'") # check that no flag is set to NA

# Combine drug classes
first_CVD_diagnosis_accross_all_conditions[,STS_min2_6m_after_diag := pmax(STA_min2_6m_after_diag, LRD_min2_6m_after_diag, FIB_min2_6m_after_diag)] # STS = statins, LRD or fibrates
first_CVD_diagnosis_accross_all_conditions[,ACR_min2_6m_after_diag := pmax(ACE_min2_6m_after_diag, ARB_min2_6m_after_diag, SAV_min2_6m_after_diag)] # ACR = ACE or ARB or SAV


fwrite(first_CVD_diagnosis_accross_all_conditions, file.path(PATH_W_CVD,"first_CVD_diagnosis_accross_all_conditions.txt.gz")) 

```


## Therapy -  All first CVD by condition (for therapy figure)
```{r table1, eval=F, warning=FALSE, message=FALSE}
# Therapy
#
all_therapy = fread(file.path(PATH_W_CVD,"CVD_therapy_gold_aurum.txt.gz")) # CVD therapy for all patients with at least one CVD therapy at any time
#
format(nrow(all_therapy), big.mark="'")
#
colnames(all_therapy)

# Select to patients in the study (those with incident CVD during study period for the 10 main conditions)
#
all_therapy = all_therapy[db_patid %in% diagnoses_all_first_denom_12$db_patid]
summary(all_therapy$eventdate)
format(nrow(all_therapy), big.mark="'")
all_therapy[,issue_year := year(eventdate)]
all_therapy = all_therapy[issue_year %in% c("2000", "2001", "2002", "2003", "2017", "2018", "2019")] # subset to years of interest
format(nrow(all_therapy), big.mark="'")


head(diagnoses_all_first_denom_12)
# Add diagnosis year and year-group
diagnoses_all_first_denom_12[, diag_year := year(diag_date)]
diagnoses_all_first_denom_12[,diag_year_group:= "NA"]
diagnoses_all_first_denom_12[diag_year <= 2002 ,diag_year_group:= "2000-2002"]
diagnoses_all_first_denom_12[diag_year >= 2003 & diag_year <= 2005 ,diag_year_group:= "2003-2005"]
diagnoses_all_first_denom_12[diag_year >= 2006 & diag_year <= 2008 ,diag_year_group:= "2006-2008"]
diagnoses_all_first_denom_12[diag_year >= 2009 & diag_year <= 2011 ,diag_year_group:= "2009-2011"]
diagnoses_all_first_denom_12[diag_year >= 2012 & diag_year <= 2014 ,diag_year_group:= "2012-2014"]
diagnoses_all_first_denom_12[diag_year >= 2015 & diag_year <= 2016 ,diag_year_group:= "2015-2016"]
diagnoses_all_first_denom_12[diag_year >= 2017 & diag_year <= 2019 ,diag_year_group:= "2017-2019"]
table(diagnoses_all_first_denom_12$diag_year_group)
diagnoses_all_first_denom_12[disease == "Myocardial infarction", disease := "Acute coronary syndrome"]


diagnoses_all_first_denom_12_therapy = diagnoses_all_first_denom_12[diag_year_group %in% c("2000-2002", "2017-2019")] # subset to 2 year groups of interest
all_therapy = all_therapy[db_patid %in% diagnoses_all_first_denom_12_therapy$db_patid]
format(nrow(all_therapy), big.mark="'")

# Merge therapy with diagnosis information

## CVD disease set 
CVD_disease_set = rbind( c("AAN_flag", "Aortic aneurysm"), c("AOR_flag", "Aortic stenosis"), c("AFF_flag", "Atrial fibrillation/flutter"), c("CHB_flag", "Heart block"), c("HFA_flag", "Heart failure"), c("IHD_flag", "Chronic ischaemic heart disease"), c("PAD_flag", "Peripheral arterial disease"), c("STR_flag", "Stroke"), c("AMI_flag", "Acute coronary syndrome"),c("VTE_flag", "Venous thromboembolism"))
nrow(CVD_disease_set)

for (i in 1:nrow(CVD_disease_set))
{
#i=9
dis = CVD_disease_set[i,2]
dis
disease_short = sub("_.*", "", CVD_disease_set[i,1])
data = diagnoses_all_first_denom_12_therapy[disease == dis,.(row_ID, db_patid, disease, diag_date, gender_name, imd2015_5, diag_year_group, region_name)]
#data[db_patid == "A1000000620274"]
therapy_data = merge( x= all_therapy, y = data, by = "db_patid", all.x = TRUE, allow.cartesian = TRUE) #  patids are unique in "data"
#therapy_data[db_patid == "A1000000620274"]
therapy_data = therapy_data[(eventdate >= diag_date -1) & (eventdate < diag_date +183) ]# Select prescriptions within 6 months following diagnosis
#therapy_data[db_patid == "A1000000620274"]
# Count prescriptions by drug type
all_therapy_count = therapy_data[, .(count = .N), by = c("row_ID", "drug_type")]
format(nrow(all_therapy_count), big.mark="'")
all_therapy_count
#all_therapy_count[row_ID == "A1000000620274_AMI"]

# Select patients with at least 2 prescriptions
all_therapy_count_2 = all_therapy_count[count>=2]
format(nrow(all_therapy_count_2), big.mark="'")
all_therapy_count_2[,count:=pmin(count, 1)]
#all_therapy_count_2[row_ID == "A1000000620274_AMI"]

# save
assign(paste(disease_short, "_therapy_count_2", sep =""),all_therapy_count_2)
}

all_therapy_count_2_by_condition = rbind(AAN_therapy_count_2, AOR_therapy_count_2, AFF_therapy_count_2, CHB_therapy_count_2, HFA_therapy_count_2, IHD_therapy_count_2, PAD_therapy_count_2, STR_therapy_count_2, AMI_therapy_count_2, VTE_therapy_count_2)
#all_therapy_count_2_by_condition[row_ID == "A1000000620274_AMI"]
head(all_therapy_count_2_by_condition)
format(nrow(all_therapy_count_2_by_condition), big.mark="'")

#
fwrite(all_therapy_count_2_by_condition, file.path(PATH_W_CVD,"CVD_therapy_count2_6m_by_condition.txt.gz"))  # CVD therapy for all patients included in the study
# run on January 18th 2024#

#all_therapy_by_condition = fread(file.path(PATH_W_CVD,"CVD_therapy_gold_aurum_6m_by_condition.txt.gz")) # CVD therapy for all patients included in the study and within 6m of first CVD


# Add disease_short
#levels(as.factor(all_therapy_count_2$drug_type))
drug_short_table = data.table(drug_type = c("ACE Inhibitors", "Alpha adrenoceptor antagonists", "Antiplatelet therapy", "ARB", "Beta Blockers",  "Calcium-Channel Blockers - dihydropyridines", "Calcium-Channel Blockers - non-dihydropyridines", "Diuretics With Potassium",  "Fibrates" ,  "Lipid-regulating Drugs", "Loop Diuretics",  "Mineralocorticoid receptor antagonists",  "Nitrates", "Oral Anticoagulants - NOAC", "Oral Anticoagulants - Vitamin K Antagonists" ,  "Parenteral Anticoagulants",  "Potassium-sparing Diuretics", "Sacubitril/Valsartan", "Statins"  ,  "Thiazides"), drug_type_short = c("ACE", "AAA", "APT", "ARB", "BTB",  "CCD", "CCN", "DWP",  "FIB" ,  "LRD", "LDI",  "MRA",  "NIT", "NOA", "VKA" ,  "HEP",  "PSD", "SAV", "STA" ,  "THI"))
all_therapy_count_2_by_condition = merge(all_therapy_count_2_by_condition, drug_short_table, by = "drug_type", all.x = TRUE)
all_therapy_count_2_by_condition
head(all_therapy_count_2_by_condition)

# Transform diagnoses into long format with flag and date for each condition
all_therapy_count_2_long = data.table::dcast(all_therapy_count_2_by_condition, row_ID ~ paste(drug_type_short, "_min2_6m_after_diag", sep=""), value.var = c("drug_type"), fun.aggregate = list(length))
head(all_therapy_count_2_long)

# Check
#all_therapy_count_2[db_patid == "A1000000620274"]
#all_therapy_count_2_long[db_patid == "A1000000620274"]
#ACE, Antiplatelet therapy, Beta Blockers, Loop Diuretics, Oral Anticoagulants - Vitamin K Antagonists, Statins

# Merge back with first CVD table
diagnoses_all_first_denom_12_therapy = merge(diagnoses_all_first_denom_12_therapy, all_therapy_count_2_long, by = c("row_ID"), all.x = TRUE  )
head(all_therapy_count_2_long)
head(diagnoses_all_first_denom_12_therapy)
nrow(diagnoses_all_first_denom_12_therapy)

# Set NA flags to 0
diagnoses_all_first_denom_12_therapy[is.na(ACE_min2_6m_after_diag), ACE_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(AAA_min2_6m_after_diag), AAA_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(APT_min2_6m_after_diag), APT_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(ARB_min2_6m_after_diag), ARB_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(BTB_min2_6m_after_diag), BTB_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(CCD_min2_6m_after_diag), CCD_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(CCN_min2_6m_after_diag), CCN_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(DWP_min2_6m_after_diag), DWP_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(FIB_min2_6m_after_diag), FIB_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(LRD_min2_6m_after_diag), LRD_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(LDI_min2_6m_after_diag), LDI_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(MRA_min2_6m_after_diag), MRA_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(NIT_min2_6m_after_diag), NIT_min2_6m_after_diag:=0]; diagnoses_all_first_denom_12_therapy[is.na(NOA_min2_6m_after_diag), NOA_min2_6m_after_diag:=0]; 
diagnoses_all_first_denom_12_therapy[is.na(VKA_min2_6m_after_diag), VKA_min2_6m_after_diag:=0]; 
diagnoses_all_first_denom_12_therapy[is.na(HEP_min2_6m_after_diag), HEP_min2_6m_after_diag:=0]; 
diagnoses_all_first_denom_12_therapy[is.na(PSD_min2_6m_after_diag), PSD_min2_6m_after_diag:=0]; 
diagnoses_all_first_denom_12_therapy[is.na(SAV_min2_6m_after_diag), SAV_min2_6m_after_diag:=0]; 
diagnoses_all_first_denom_12_therapy[is.na(STA_min2_6m_after_diag), STA_min2_6m_after_diag:=0]; 
diagnoses_all_first_denom_12_therapy[is.na(THI_min2_6m_after_diag), THI_min2_6m_after_diag:=0]; 
 # for those without relevant prescriptions, set disease flag to 0

format(nrow(diagnoses_all_first_denom_12_therapy[is.na(THI_min2_6m_after_diag)]), big.mark="'") # check that no flag is set to NA

# Combine drug classes
diagnoses_all_first_denom_12_therapy[,STS_min2_6m_after_diag := pmax(STA_min2_6m_after_diag, LRD_min2_6m_after_diag, FIB_min2_6m_after_diag)] # STS = statins, LRD or fibrates
diagnoses_all_first_denom_12_therapy[,ACR_min2_6m_after_diag := pmax(ACE_min2_6m_after_diag, ARB_min2_6m_after_diag, SAV_min2_6m_after_diag)] # ACR = ACE or ARB or SAV


fwrite(diagnoses_all_first_denom_12_therapy, file.path(PATH_W_CVD,"diagnoses_all_first_denom_12_therapy.txt.gz")) 
remove("therapy_data", "AAN_therapy_count_2", "AOR_therapy_count_2", "AFF_therapy_count_2", "CHB_therapy_count_2", "HFA_therapy_count_2", "IHD_therapy_count_2", "PAD_therapy_count_2", "STR_therapy_count_2", "AMI_therapy_count_2", "VTE_therapy_count_2", "all_therapy", "all_therapy_count", "all_therapy_count_2", "all_therapy_count_2_by_condition", "all_therapy_count_2_long")

```


# Additional variables
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# exclude records with SES = NA
nrow(num_denom_0[is.na(imd2015_5)])
num_denom_0 = num_denom_0[!is.na(imd2015_5)]
nrow(num_denom_0[is.na(region_name)])

format(nrow(denominator), big.mark="'")  
format(nrow(num_denom_0), big.mark="'") 
format(nrow(diagnoses_all_first_long), big.mark="'")  

# Diagnosis year and year-group
num_denom_0[,diag_year:= year(first_CVD_date)]

# calendar year groups
num_denom_0[,diag_year_group:= "NA"]
num_denom_0[diag_year <= 2002 ,diag_year_group:= "2000-2002"]
num_denom_0[diag_year >= 2003 & diag_year <= 2005 ,diag_year_group:= "2003-2005"]
num_denom_0[diag_year >= 2006 & diag_year <= 2008 ,diag_year_group:= "2006-2008"]
num_denom_0[diag_year >= 2009 & diag_year <= 2011 ,diag_year_group:= "2009-2011"]
num_denom_0[diag_year >= 2012 & diag_year <= 2014 ,diag_year_group:= "2012-2014"]
num_denom_0[diag_year >= 2015 & diag_year <= 2016 ,diag_year_group:= "2015-2016"]
num_denom_0[diag_year >= 2017 & diag_year <= 2019 ,diag_year_group:= "2017-2019"]
table(num_denom_0$diag_year_group)
#num_denom_0[db_patid == "A1000068320274"]

#  Add ethnicity and Comorbidities
#table(num_denom_0$ethnicity_category1)
#num_denom_0 = merge(x = num_denom_0, y = first_CVD_diagnosis_accross_all_conditions[,.(db_patid, BMI, smok_status_name, CAN_flag, CKD_flag, DIA2_flag, DYS_flag, HYP_flag, OBE_flag, PSA_flag, HTH_flag, CAN_date, CKD_date, DIA2_date, DYS_date, HYP_date, OBE_date, PSA_date, HTH_date, ethnicity_description, ethnicity_category1, ethnicity_category2, ethnicity_source)], by = "db_patid", all.x = TRUE) 
#colnames(num_denom_0)

```

# Prevalent cases to be excluded from the denominator
```{r, eval=TRUE, warning=FALSE, message=FALSE}
#prev_diagnoses_all_first_denom_end_start = diagnoses_all_first_denom[eventdate<start_date | eventdate<study_start_date | eventdate<regdate+lookback_period]
prev_diagnoses_all_first_denom_end_start = diagnoses_all_first_denom[eventdate>=linkage_start_date & eventdate>=start_date & eventdate<pmax(regdate, linkage_start_date)+lookback_period]# prevalent = those with a diagnosis within lookback_period


# Transform diagnoses into long format with flag and date for each condition
diagnoses_all_first_long1 = data.table::dcast(prev_diagnoses_all_first_denom_end_start, db_patid ~ paste(disease_short, "_prev_flag", sep=""), value.var = c("disease"), fun.aggregate = list(length))
head(diagnoses_all_first_long1)

#diagnoses_all_first_denom_12[, count_d:= .N, by = c("db_patid", "disease_short")] # check for duplicate codes within each condition
#diagnoses_all_first_denom_12[count_d>1]
#diagnoses_all_first_denom_12[db_patid == "A1000020920274"]
#denominator[db_patid == "A1000020920274"]

diagnoses_all_first_long2 = data.table::dcast(prev_diagnoses_all_first_denom_end_start, db_patid ~ paste(disease_short, "_prev_date", sep=""), value.var = c("eventdate"))

diagnoses_all_first_long = merge(diagnoses_all_first_long1, diagnoses_all_first_long2, by = c("db_patid"), all = TRUE )
head(diagnoses_all_first_long)
format(nrow(diagnoses_all_first_long), big.mark="'") 
colnames(diagnoses_all_first_long)
#summary(diagnoses_all_first_long$INS_flag)
#summary(diagnoses_all_first_long$ADD_flag)

# Create "num_denom" file - that includes numerator (diagnoses) and denominator (patient days) information
num_denom_0 = merge(diagnoses_all_first_long, num_denom_0, by = c("db_patid"), all = TRUE )
head(num_denom_0)

format(nrow(denominator), big.mark="'")  
format(nrow(num_denom_0), big.mark="'")  # num_denom_0 includes slightly fewer patient_ids because those with ses = NA were excluded
format(nrow(diagnoses_all_first_long), big.mark="'")  

# Set NA flags to 0
num_denom_0[is.na(AAN_prev_flag), AAN_prev_flag:=0]; num_denom_0[is.na(AFF_prev_flag), AFF_prev_flag:=0]; num_denom_0[is.na(AMI_prev_flag), AMI_prev_flag:=0]; num_denom_0[is.na(AOS_prev_flag), AOS_prev_flag:=0]; num_denom_0[is.na(CAO_prev_flag), CAO_prev_flag:=0]; num_denom_0[is.na(CHB_prev_flag), CHB_prev_flag:=0]; num_denom_0[is.na(HFA_prev_flag), HFA_prev_flag:=0]; num_denom_0[is.na(HST_prev_flag), HST_prev_flag:=0]; num_denom_0[is.na(IHD_prev_flag), IHD_prev_flag:=0]; num_denom_0[is.na(IHS_prev_flag), IHS_prev_flag:=0]; num_denom_0[is.na(MVD_prev_flag), MVD_prev_flag:=0]; num_denom_0[is.na(PAD_prev_flag), PAD_prev_flag:=0]; num_denom_0[is.na(PVD_prev_flag), PVD_prev_flag:=0]; num_denom_0[is.na(STR_prev_flag), STR_prev_flag:=0]; num_denom_0[is.na(SVT_prev_flag), SVT_prev_flag:=0]; num_denom_0[is.na(TIA_prev_flag), TIA_prev_flag:=0]; num_denom_0[is.na(TVD_prev_flag), TVD_prev_flag:=0]; num_denom_0[is.na(UNS_prev_flag), UNS_prev_flag:=0]; num_denom_0[is.na(UVD_prev_flag), UVD_prev_flag:=0]; num_denom_0[is.na(VAD_prev_flag), VAD_prev_flag:=0]; num_denom_0[is.na(VTE_prev_flag), VTE_prev_flag:=0]; num_denom_0[is.na(PMK_prev_flag), PMK_prev_flag:=0]; # for those 
table(num_denom_0$AAN_prev_flag, num_denom_0$AAN_flag) # double check that no patient has both prevalent and incident flags
#num_denom_0[AAN_prev_flag == 1 & AAN_flag== 1] 

# Check that there are no missing start/end dates
nrow(num_denom_0[is.na(start_date)])
nrow(num_denom_0[is.na(end_date)])
nrow(num_denom_0[is.na(gender_name)])
nrow(num_denom_0[is.na(imd2015_5)])

# Merge back with denominator for reg date variables
num_denom_0 = merge(num_denom_0[,-c("gender_name", "start_date", "end_date", "lcdate", "birthyear", "dod", "regdate", "todate", "gold_db", "aurum_db", "imd2015_5", "region_name")], denominator[,.(db_patid, pracid, gender_name, start_date, end_date, lcdate, birthyear, dod, regdate, todate, gold_db, aurum_db, imd2015_5, region_name)], by = c("db_patid"), all.x = TRUE)

# Check that there are no missing start/end dates
nrow(num_denom_0[is.na(start_date)])
nrow(num_denom_0[is.na(end_date)])
nrow(num_denom_0[is.na(gender_name)])
nrow(num_denom_0[is.na(imd2015_5)])
nrow(num_denom_0[is.na(region_name)])
#num_denom_0[db_patid == "A1000068320274"]
#prev_diagnoses_all_first_denom_end_start[db_patid == "A1000068320274"]

# exclude records with SES = NA
num_denom_0 = num_denom_0[!is.na(imd2015_5)]

fwrite(num_denom_0, file.path(PATH_W_CVD,"CVD_incidence_num_denom_0.txt.gz")) 
head(num_denom_0)
levels(as.factor(num_denom_0$disease))
sum(num_denom_0$VTE_flag)

```

# Create code occurence tables by GOlD / Aurum
```{r code_occ_1, eval=TRUE, warning=FALSE, message=FALSE}
head(diagnoses_all_first_denom_12)

# subset to diseases of interest
diagnoses_all_first_denom_12_sub = diagnoses_all_first_denom_12[disease %in% c("Aortic aneurysm", "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease", "Heart failure", "Myocardial infarction", "Peripheral arterial disease", "Heart block", "Stroke", "Venous thromboembolism")] # only cardiovascular diagnoses, only incident diagnoses during study period

# Number of occurences by code (first diagnosis for each condition)
code_occ_1= diagnoses_all_first_denom_12_sub[,.N, by = c("diag_code_unique_ID","disease")]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=disease]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all.x = TRUE)
setcolorder(code_occ_1_dict, c( "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, -N)]
head(code_occ_1_dict)
nrow(code_occ_1_dict)
write.table(code_occ_1_dict, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_final_cohort/2024-01-19_code_occ_table_1_first.txt"), sep="\t", row.names=FALSE)

# Top 5 codes for each condition and db
diagnoses_all_first_denom_12_sub[gold_db == 1, patient_db := "Gold"]
diagnoses_all_first_denom_12_sub[aurum_db == 1, patient_db := "Aurum"]
code_occ_1= diagnoses_all_first_denom_12_sub[,.N, by = c("diag_code_unique_ID","disease", "patient_db")]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=c("disease", "patient_db")]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency, patient_db)], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all.x = TRUE)
setcolorder(code_occ_1_dict, c( "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(patient_db, disease, -N)]
head(code_occ_1_dict)
top_5_code_occ_1_dict = code_occ_1_dict[, head(.SD, 5), by=c("disease", "patient_db")]
top_5_code_occ_1_dict
levels(as.factor(top_5_code_occ_1_dict$disease))


# by year
diagnoses_all_first_denom_12_sub[, diag_year := year(diag_date)]
diagnoses_all_first_denom_12_sub[gold_db == 1, patient_db := "Gold"]
diagnoses_all_first_denom_12_sub[aurum_db == 1, patient_db := "Aurum"]
code_occ_1= diagnoses_all_first_denom_12_sub[,.N, by = c("diag_code_unique_ID","disease", "patient_db", "diag_year")]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=c("disease", "patient_db", "diag_year")]
code_occ_1[, "frequency_n":=round(N/sum(N),2), by=c("disease", "patient_db", "diag_year")]
code_occ_1
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency, diag_year,patient_db, frequency_n )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all.x = TRUE)
setcolorder(code_occ_1_dict, c( "disease", "patient_db", "diag_year", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, diag_year, -N)]
code_occ_1_dict = code_occ_1_dict[diag_code_unique_ID %in% top_5_code_occ_1_dict$diag_code_unique_ID]
code_occ_1_dict[,code_desc := paste(diag_code_unique_ID, description)]
head(code_occ_1_dict, 10)

## CVD disease set 
CVD_disease_set = rbind( c("AAN_flag", "Aortic aneurysm"), c("AOR_flag", "Aortic stenosis"), c("AFF_flag", "Atrial fibrillation/flutter"), c("CHB_flag", "Heart block"), c("HFA_flag", "Heart failure"), c("IHD_flag", "Chronic ischaemic heart disease"), c("PAD_flag", "Peripheral arterial disease"), c("STR_flag", "Stroke"), c("AMI_flag", "Acute coronary syndrome"),c("VTE_flag", "Venous thromboembolism"))
nrow(CVD_disease_set)

code_occ_1_dict[disease == "Myocardial infarction"  , disease := "Acute coronary syndrome"]

for (i in 1:nrow(CVD_disease_set))
  for (db in c("Gold", "Aurum"))
{{
#i=1
dis = CVD_disease_set[i,2]
disease_short = sub("_.*", "", CVD_disease_set[i,1])
#db = "Gold"
data = code_occ_1_dict[disease == dis & patient_db == db]
p= ggplot(data, aes(x = diag_year, y = frequency_n, color = factor(code_desc)))+geom_point() + stat_smooth(aes(group = factor(code_desc))) + theme_bw(base_size = 10) + ylim(0, NA) + theme_bw() + theme(plot.title = element_text(face = "bold", size = 10), plot.subtitle = element_text(size = 10), legend.position = "bottom", legend.title=element_blank(), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), plot.margin = ggplot2::margin(0, 0.1, 0.9, 0.05, "cm") ) + ylab("") + xlab("") + scale_x_continuous(breaks=c(2000,2005,2010,2015,2019)) + ggtitle(dis, subtitle = db)+guides(color = guide_legend(nrow = 6)) + scale_color_manual(values = c( "black","#000480", "blue", "red", "#FF8C33", "#D200FF", "#FF00D4"))
name = paste("p", disease_short, db, sep="_")
assign(name, p)
}}


pdf(file.path(PATH_P,"Top_5_code_occurence_plots.pdf"), width=12, height = 50)
p = grid.arrange(p_AMI_Aurum, p_AMI_Gold, p_IHD_Aurum,p_IHD_Gold, p_STR_Aurum,p_STR_Gold, p_AOR_Aurum, p_AOR_Gold, p_HFA_Aurum,  p_HFA_Gold, p_PAD_Aurum, p_PAD_Gold, p_AFF_Aurum,p_AFF_Gold, p_CHB_Aurum,p_CHB_Gold, p_AAN_Aurum, p_AAN_Gold, p_VTE_Aurum,p_VTE_Gold, ncol=2, nrow = 10, widths = c(1,1), heights = c(1,1,1,1,1, 1, 1, 1,1,1), layout_matrix = rbind(c(1, 2), c(3,4), c(5,6), c(7,8),c(9,10), c(11, 12),c(13,14),c(15,16),c(17,18),c(19,20)))
dev.off()

# table format
code_occ_1_dict_cast = data.table::dcast(code_occ_1_dict[,.(diag_code_unique_ID, diag_year, disease, patient_db, description, frequency_n)], disease+diag_code_unique_ID+description+patient_db ~ diag_year, value.var = c("frequency_n"), fun.aggregate = sum)
code_occ_1_dict_cast
write.table(code_occ_1_dict, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_final_cohort/2024-01-19_code_occ_table_1_first_by_year.txt"), sep="\t", row.names=FALSE)


```

# Create code occurence tables - any
```{r code_occ_1, eval=TRUE, warning=FALSE, message=FALSE}
head(diagnoses_all_first_denom_12)

# subset to diseases of interest
diagnoses_all_first_denom_12_sub = diagnoses_all_first_denom_12[disease %in% c("Aortic aneurysm", "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease", "Heart failure", "Myocardial infarction","Acute coronary syndrome", "Peripheral arterial disease", "Heart block", "Stroke", "Venous thromboembolism")] # only cardiovascular diagnoses, only incident diagnoses during study period
diagnoses_all_first_denom_12_sub[disease == "Acute coronary syndrome"  , disease := "Myocardial infarction"]
table(diagnoses_all_first_denom_12_sub$diag_year_group)


# Number of occurences by code (first diagnosis for each condition) -- all years
code_occ_1= diagnoses_all_first_denom_12_sub[,.N, by = c("diag_code_unique_ID","disease")]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=disease]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all.x = TRUE)
setcolorder(code_occ_1_dict, c( "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, -N)]
head(code_occ_1_dict)
nrow(code_occ_1_dict)
write.table(code_occ_1_dict, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_final_cohort/2024-01-19_code_occ_table_1_first.txt"), sep="\t", row.names=FALSE)
code_occ_1_dict_all_years = code_occ_1_dict
code_occ_1_dict_all_years[,N_all_years := N]
code_occ_1_dict_all_years[,frequency_all_years := frequency]

# Number of occurences by code (first diagnosis for each condition) -- 2017-2019
code_occ_1= diagnoses_all_first_denom_12_sub[diag_year_group == "2017-2019",.N, by = c("diag_code_unique_ID","disease")]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=disease]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all.x = TRUE)
setcolorder(code_occ_1_dict, c( "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, -N)]
head(code_occ_1_dict)
nrow(code_occ_1_dict)
code_occ_1_dict_2017_2019 = code_occ_1_dict
code_occ_1_dict_2017_2019[,N_2017_2019 := N]
code_occ_1_dict_2017_2019[,frequency_2017_2019 := frequency]

# Number of occurences by code (first diagnosis for each condition) -- all years
code_occ_1= diagnoses_all_first_denom_12_sub[diag_year_group == "2000-2002",.N, by = c("diag_code_unique_ID","disease")]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=disease]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all.x = TRUE)
setcolorder(code_occ_1_dict, c( "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, -N)]
head(code_occ_1_dict)
nrow(code_occ_1_dict)
code_occ_1_dict_2000_2002 = code_occ_1_dict
code_occ_1_dict_2000_2002[,N_2000_2002 := N]
code_occ_1_dict_2000_2002[,frequency_2000_2002 := frequency]

code_occ_1_dict = merge(code_occ_1_dict_all_years[,.(disease, codetype, diag_code_unique_ID, description, N_all_years, frequency_all_years)], code_occ_1_dict_2017_2019[,.(diag_code_unique_ID, N_2017_2019, frequency_2017_2019)], by = "diag_code_unique_ID", all.x = TRUE)
code_occ_1_dict = merge(code_occ_1_dict, code_occ_1_dict_2000_2002[,.(diag_code_unique_ID, N_2000_2002, frequency_2000_2002)], by = "diag_code_unique_ID", all.x = TRUE)
setcolorder(code_occ_1_dict, c("disease", "codetype", "diag_code_unique_ID", "description", "N_all_years", "frequency_all_years", "N_2017_2019", "frequency_2017_2019", "N_2000_2002", "frequency_2000_2002"))
code_occ_1_dict = code_occ_1_dict[order(disease, -N_all_years)]
write.table(code_occ_1_dict, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_final_cohort/2024-01-19_code_occ_table_first_over_time.txt"), sep="\t", row.names=FALSE)

top_10 = code_occ_1_dict[, head(.SD, 10), by=disease]
top_10 = top_10[order(disease, -N_all_years)]
top_10[codetype == "icd", codetype := "ICD-10"]; top_10[codetype == "gold", codetype := "Gold"]; top_10[codetype == "aurum", codetype := "Aurum"]; top_10[codetype == "opcs", codetype := "OPCS-4"]
#top_10[, diag_code := sub(".*_", "", diag_code_unique_ID)]
#top_10
top_10[, N_all_years_format :=  format(N_all_years, big.mark=" ")]
top_10[, N_2017_2019_format :=  format(N_2017_2019, big.mark=" ")]
top_10[, N_2000_2002_format :=  format(N_2000_2002, big.mark=" ")]
setcolorder(top_10, c("disease", "codetype", "diag_code_unique_ID", "description", "N_all_years_format", "frequency_all_years", "N_2017_2019_format", "frequency_2017_2019", "N_2000_2002_format", "frequency_2000_2002", "N_all_years", "N_2017_2019","N_2000_2002"))
write.table(top_10, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_final_cohort/2024-01-19_code_occ_table_first_over_time_top10_codes_by_condition.txt"), sep="\t", row.names=FALSE)

```

# Table 1 - Baseline characteristics
```{r table1, eval=F, warning=FALSE, message=FALSE}
# Total number of incident diagnoses recorded during study period
#incident_diagnoses_in_study = diagnoses_all_first_denom_12[disease %in% c("Aortic aneurysm", "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease", "Heart failure", "Myocardial infarction", "Peripheral arterial disease", "Heart block", "Stroke", "Venous thromboembolism")]
#format(nrow(incident_diagnoses_in_study), big.mark="'")  # only cardiovascular diagnoses, only incident diagnoses during study period
#format(nrow(unique(incident_diagnoses_in_study[,.(db_patid, disease)])), big.mark="'") # double-check that patid-disease tuples are unique
#incident_diagnoses_in_study[,obs_smok_status_name1 := factor(obs_smok_status_name1, levels = c("Yes", "Ex", "No", ""))]

# Check all columns
colnames(first_CVD_diagnosis_accross_all_conditions)

#Table 1 formatting functions
render.categorical <- function(x, ...) {
    c("", sapply(stats.apply.rounding(stats.default(x)), function(y) with(y,
      sprintf("%s (%s%%)", prettyNum(FREQ, big.mark=" "), PCT))))
}

render.strat <- function (label, n, ...) {
    sprintf("<span class='stratlabel'>%s<br><span class='stratn'>(N=%s)</span></span>", 
        label, prettyNum(n, big.mark=" "))
}

#render.continuous <- function(x, ...) {
#    with(stats.default(x, ...), c("",
#        "Mean (SD)"         = sprintf("%s (%s)",
#          signif_pad(MEAN,   3, big.mark=" "),
#          signif_pad(SD,     3, big.mark=" ")),
#        "Median [Min, Max]" = sprintf("%s [%s, %s]",
#          signif_pad(MEDIAN, 3, big.mark=" "),
#          signif_pad(MIN,    3, big.mark=" "),
#          signif_pad(MAX,    3, big.mark=" "))))
#}

render.continuous <- function(x, ...) {
    with(stats.default(x, ...), c("",
        "Mean (SD)"         = sprintf("%s (%s)",
          signif_pad(MEAN,   3, big.mark=" "),
          signif_pad(SD,     3, big.mark=" ")),
        "Median [Q1, Q3]" = sprintf("%s [%s, %s]",
          signif_pad(MEDIAN, 3, big.mark=" "),
          signif_pad(Q1,    3, big.mark=" "),
          signif_pad(Q3,    3, big.mark=" "))))

}


first_CVD_diagnosis_accross_all_conditions[,smok_status_name := factor(smok_status_name, levels = c("Yes", "Ex", "No", NA))]
table(first_CVD_diagnosis_accross_all_conditions$test_smok_status_name1)
first_CVD_diagnosis_accross_all_conditions[,BMI_cat := factor(BMI_cat, levels = c("underweight", "normal weight", "overweight", "obesity", NA))]
table(first_CVD_diagnosis_accross_all_conditions$BMI_cat)

first_CVD_diagnosis_accross_all_conditions[ethnicity_category1 ==  "African/Caribean", ethnicity_category1 := "African/Caribbean"]


# Table1 by gender
table1= table1(~ age_at_first_CVD_date + gender_name + ethnicity_category1 + as.factor(imd2015_5)  + SBP+ DBP +BMI+ as.factor(BMI_cat) + smok_status_name +chol_ratio + as.factor(CKD_flag) + as.factor(DYS_flag)+ as.factor(HYP_flag)+ as.factor(DIA2_flag) + as.factor(PRE_flag) + as.factor(GDM_flag)  + database + factor(region_name)   + diag_year_group + as.factor(num_CVD_cat)+ as.factor(CAN_flag)+ as.factor(OBE_flag)+ ethnicity_category1 + ethnicity_category2+ ethnicity_source
+ as.factor(ACE_min2_6m_after_diag) + as.factor(AAA_min2_6m_after_diag) + as.factor(APT_min2_6m_after_diag)+ as.factor(ARB_min2_6m_after_diag)+ as.factor(BTB_min2_6m_after_diag)+ as.factor(CCD_min2_6m_after_diag)+ as.factor(CCN_min2_6m_after_diag)+ as.factor(DWP_min2_6m_after_diag)+ as.factor(FIB_min2_6m_after_diag)+ as.factor(LRD_min2_6m_after_diag)+ as.factor(LDI_min2_6m_after_diag)+ as.factor(MRA_min2_6m_after_diag)+ as.factor(NIT_min2_6m_after_diag)+ as.factor(NOA_min2_6m_after_diag) + as.factor(VKA_min2_6m_after_diag)+ as.factor(HEP_min2_6m_after_diag)+ as.factor(PSD_min2_6m_after_diag)+ as.factor(SAV_min2_6m_after_diag)+ as.factor(STA_min2_6m_after_diag)+ as.factor(THI_min2_6m_after_diag)+ as.factor(ACR_min2_6m_after_diag)+ as.factor(STS_min2_6m_after_diag) | gender_name, data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
kable(table1)

#able1= table1(~ age_at_first_CVD_date + as.factor(DIA2_flag) + as.factor(DIA2_any_time_flag) | gender_name, data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
#kable(table1)

write.table(table1, file.path(PATH_P,"CVD_table1_by_gender_1.txt"), sep="\t", row.names = F)

## Ethnicitiy categories on complete cases
table1 = table1(~  ethnicity_category1 | gender_name, data=first_CVD_diagnosis_accross_all_conditions[!is.na(ethnicity_category1)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_gender_ethn.txt"), sep="\t", row.names = F)

## Smoking categories on complete cases
table1 = table1(~  smok_status_name | gender_name, data=first_CVD_diagnosis_accross_all_conditions[!is.na(smok_status_name)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
table1
write.table(table1, file.path(PATH_P,"CVD_table1_by_gender_smok.txt"), sep="\t", row.names = F)

## BMI categories on complete cases
table1 = table1(~  as.factor(BMI_cat) | gender_name, data=first_CVD_diagnosis_accross_all_conditions[!is.na(BMI_cat)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
table1
write.table(table1, file.path(PATH_P,"CVD_table1_by_gender_BMI.txt"), sep="\t", row.names = F)

table1_1 = fread(file.path(PATH_P,"CVD_table1_by_gender_1.txt"), sep="\t")
table1_smok = fread(file.path(PATH_P,"CVD_table1_by_gender_smok.txt"), sep="\t")
table1_ethn = fread(file.path(PATH_P,"CVD_table1_by_gender_ethn.txt"), sep="\t")
table1_bmi = fread(file.path(PATH_P,"CVD_table1_by_gender_BMI.txt"), sep="\t")
table1_by_gender = rbind(table1_1, table1_smok, table1_ethn, table1_bmi)
write.table(table1_by_gender, file.path(PATH_P,"CVD_table1_by_gender_all.txt"), sep="\t", row.names = F)


# Table1 by SES
table1 = table1(~ age_at_first_CVD_date + gender_name + ethnicity_category1 + as.factor(imd2015_5)  + SBP+ DBP +BMI  +as.factor(BMI_cat) + smok_status_name +chol_ratio + as.factor(CKD_flag) + as.factor(DYS_flag)+ as.factor(HYP_flag)+ as.factor(DIA2_flag) + as.factor(PRE_flag) + as.factor(GDM_flag)  + database + factor(region_name)   + diag_year_group + as.factor(num_CVD_cat)+ as.factor(CAN_flag)+ as.factor(OBE_flag)+ ethnicity_category1 + ethnicity_category2+ ethnicity_source
+ as.factor(ACE_min2_6m_after_diag) + as.factor(AAA_min2_6m_after_diag) + as.factor(APT_min2_6m_after_diag)+ as.factor(ARB_min2_6m_after_diag)+ as.factor(BTB_min2_6m_after_diag)+ as.factor(CCD_min2_6m_after_diag)+ as.factor(CCN_min2_6m_after_diag)+ as.factor(DWP_min2_6m_after_diag)+ as.factor(FIB_min2_6m_after_diag)+ as.factor(LRD_min2_6m_after_diag)+ as.factor(LDI_min2_6m_after_diag)+ as.factor(MRA_min2_6m_after_diag)+ as.factor(NIT_min2_6m_after_diag)+ as.factor(NOA_min2_6m_after_diag) + as.factor(VKA_min2_6m_after_diag)+ as.factor(HEP_min2_6m_after_diag)+ as.factor(PSD_min2_6m_after_diag)+ as.factor(SAV_min2_6m_after_diag)+ as.factor(STA_min2_6m_after_diag)+ as.factor(THI_min2_6m_after_diag)+ as.factor(ACR_min2_6m_after_diag)+ as.factor(STS_min2_6m_after_diag) | as.factor(imd2015_5), data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
kable(table1)
write.table(table1, file.path(PATH_P,"CVD_table1_by_ses_1.txt"), sep="\t", row.names = F)

## Ethnicitiy categories on complete cases
table1 = table1(~  ethnicity_category1 | as.factor(imd2015_5), data=first_CVD_diagnosis_accross_all_conditions[!is.na(ethnicity_category1)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_ses_ethn.txt"), sep="\t", row.names = F)

## Smoking categories on complete cases
table1 = table1(~  smok_status_name | as.factor(imd2015_5), data=first_CVD_diagnosis_accross_all_conditions[!is.na(smok_status_name)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_ses_smok.txt"), sep="\t", row.names = F)

## BMI categories on complete cases
table1 = table1(~  as.factor(BMI_cat) | as.factor(imd2015_5), data=first_CVD_diagnosis_accross_all_conditions[!is.na(BMI_cat)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_ses_BMI.txt"), sep="\t", row.names = F)

table1_1 = fread(file.path(PATH_P,"CVD_table1_by_ses_1.txt"), sep="\t")
table1_smok = fread(file.path(PATH_P,"CVD_table1_by_ses_smok.txt"), sep="\t")
table1_ethn = fread(file.path(PATH_P,"CVD_table1_by_ses_ethn.txt"), sep="\t")
table1_bmi = fread(file.path(PATH_P,"CVD_table1_by_ses_BMI.txt"), sep="\t")
table1_by_ses = rbind(table1_1, table1_smok, table1_ethn, table1_bmi)
write.table(table1_by_ses, file.path(PATH_P,"CVD_table1_by_ses_all.txt"), sep="\t", row.names = F)

# Table1 by time period
table1 = table1( ~ age_at_first_CVD_date + gender_name + ethnicity_category1 + as.factor(imd2015_5)  + SBP+ DBP +BMI  +as.factor(BMI_cat) + smok_status_name +chol_ratio + as.factor(CKD_flag) + as.factor(DYS_flag)+ as.factor(HYP_flag)+ as.factor(DIA2_flag) + as.factor(PRE_flag) + as.factor(GDM_flag)  + database + factor(region_name)   + diag_year_group + as.factor(num_CVD_cat)+ as.factor(CAN_flag)+ as.factor(OBE_flag)+ ethnicity_category1 + ethnicity_category2+ ethnicity_source
+ as.factor(ACE_min2_6m_after_diag) + as.factor(AAA_min2_6m_after_diag) + as.factor(APT_min2_6m_after_diag)+ as.factor(ARB_min2_6m_after_diag)+ as.factor(BTB_min2_6m_after_diag)+ as.factor(CCD_min2_6m_after_diag)+ as.factor(CCN_min2_6m_after_diag)+ as.factor(DWP_min2_6m_after_diag)+ as.factor(FIB_min2_6m_after_diag)+ as.factor(LRD_min2_6m_after_diag)+ as.factor(LDI_min2_6m_after_diag)+ as.factor(MRA_min2_6m_after_diag)+ as.factor(NIT_min2_6m_after_diag)+ as.factor(NOA_min2_6m_after_diag) + as.factor(VKA_min2_6m_after_diag)+ as.factor(HEP_min2_6m_after_diag)+ as.factor(PSD_min2_6m_after_diag)+ as.factor(SAV_min2_6m_after_diag)+ as.factor(STA_min2_6m_after_diag)+ as.factor(THI_min2_6m_after_diag)+ as.factor(ACR_min2_6m_after_diag)+ as.factor(STS_min2_6m_after_diag) | diag_year_group, data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
kable(table1)
write.table(table1, file.path(PATH_P,"CVD_table1_by_time_period_1.txt"), sep="\t", row.names = F)

## Ethnicitiy categories on complete cases
table1 = table1(~  ethnicity_category1 | diag_year_group, data=first_CVD_diagnosis_accross_all_conditions[!is.na(ethnicity_category1)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_time_period_ethn.txt"), sep="\t", row.names = F)

## Smoking categories on complete cases
table1 = table1(~  smok_status_name | diag_year_group, data=first_CVD_diagnosis_accross_all_conditions[!is.na(smok_status_name)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_time_period_smok.txt"), sep="\t", row.names = F)

## BMI categories on complete cases
table1 = table1(~  as.factor(BMI_cat) | diag_year_group, data=first_CVD_diagnosis_accross_all_conditions[!is.na(BMI_cat)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_time_period_BMI.txt"), sep="\t", row.names = F)

table1_1 = fread(file.path(PATH_P,"CVD_table1_by_time_period_1.txt"), sep="\t")
table1_smok = fread(file.path(PATH_P,"CVD_table1_by_time_period_smok.txt"), sep="\t")
table1_ethn = fread(file.path(PATH_P,"CVD_table1_by_time_period_ethn.txt"), sep="\t")
table1_bmi = fread(file.path(PATH_P,"CVD_table1_by_time_period_BMI.txt"), sep="\t")
table1_by_time_period = rbind(table1_1, table1_smok, table1_ethn, table1_bmi)
write.table(table1_by_time_period, file.path(PATH_P,"CVD_table1_by_time_period_all.txt"), sep="\t", row.names = F)

# check smoking by region
#
table1_smoking_region= table1(~  smok_status_name + as.factor(DIA2_flag) +BMI+ as.factor(OBE_flag) | region_name, data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
#
kable(table1_smoking_region)
write.table(table1_smoking_region, file.path(PATH_P,"CVD_table1_table1_smoking_region.txt"), sep="\t", row.names = F)


# Table1 by age >< 60
first_CVD_diagnosis_accross_all_conditions[age_at_first_CVD_date < 60, age_group_60 := "less_60"]
first_CVD_diagnosis_accross_all_conditions[age_at_first_CVD_date >= 60, age_group_60 := "more_60"]
table1= table1(~ age_at_first_CVD_date + gender_name + ethnicity_category1 + as.factor(imd2015_5)  + SBP+ DBP +BMI+ as.factor(BMI_cat) + smok_status_name +chol_ratio + as.factor(CKD_flag) + as.factor(DYS_flag)+ as.factor(HYP_flag)+ as.factor(DIA2_flag) + as.factor(PRE_flag) + as.factor(GDM_flag)  + database + factor(region_name)   + diag_year_group + as.factor(num_CVD_cat)+ as.factor(CAN_flag)+ as.factor(OBE_flag)+ ethnicity_category1 + ethnicity_category2+ ethnicity_source
+ as.factor(ACE_min2_6m_after_diag) + as.factor(AAA_min2_6m_after_diag) + as.factor(APT_min2_6m_after_diag)+ as.factor(ARB_min2_6m_after_diag)+ as.factor(BTB_min2_6m_after_diag)+ as.factor(CCD_min2_6m_after_diag)+ as.factor(CCN_min2_6m_after_diag)+ as.factor(DWP_min2_6m_after_diag)+ as.factor(FIB_min2_6m_after_diag)+ as.factor(LRD_min2_6m_after_diag)+ as.factor(LDI_min2_6m_after_diag)+ as.factor(MRA_min2_6m_after_diag)+ as.factor(NIT_min2_6m_after_diag)+ as.factor(NOA_min2_6m_after_diag) + as.factor(VKA_min2_6m_after_diag)+ as.factor(HEP_min2_6m_after_diag)+ as.factor(PSD_min2_6m_after_diag)+ as.factor(SAV_min2_6m_after_diag)+ as.factor(STA_min2_6m_after_diag)+ as.factor(THI_min2_6m_after_diag)+ as.factor(ACR_min2_6m_after_diag)+ as.factor(STS_min2_6m_after_diag) | age_group_60, data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
kable(table1)

#able1= table1(~ age_at_first_CVD_date + as.factor(DIA2_flag) + as.factor(DIA2_any_time_flag) | gender_name, data=first_CVD_diagnosis_accross_all_conditions, render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
#kable(table1)

write.table(table1, file.path(PATH_P,"CVD_table1_by_age60_1.txt"), sep="\t", row.names = F)

## Ethnicitiy categories on complete cases
table1 = table1(~  ethnicity_category1 | age_group_60, data=first_CVD_diagnosis_accross_all_conditions[!is.na(ethnicity_category1)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_age60_ethn.txt"), sep="\t", row.names = F)

## Smoking categories on complete cases
table1 = table1(~  smok_status_name | age_group_60, data=first_CVD_diagnosis_accross_all_conditions[!is.na(smok_status_name)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_age60_smok.txt"), sep="\t", row.names = F)

## BMI categories on complete cases
table1 = table1(~  as.factor(BMI_cat) | age_group_60, data=first_CVD_diagnosis_accross_all_conditions[!is.na(BMI_cat)], render.categorical=render.categorical, render.strat=render.strat, render.continuous=render.continuous)
write.table(table1, file.path(PATH_P,"CVD_table1_by_age60_BMI.txt"), sep="\t", row.names = F)

table1_1 = fread(file.path(PATH_P,"CVD_table1_by_age60_1.txt"), sep="\t")
table1_smok = fread(file.path(PATH_P,"CVD_table1_by_age60_smok.txt"), sep="\t")
table1_ethn = fread(file.path(PATH_P,"CVD_table1_by_age60_ethn.txt"), sep="\t")
table1_bmi = fread(file.path(PATH_P,"CVD_table1_by_age60_BMI.txt"), sep="\t")
table1_by_gender = rbind(table1_1, table1_smok, table1_ethn, table1_bmi)
write.table(table1_by_gender, file.path(PATH_P,"CVD_table1_by_age60_all.txt"), sep="\t", row.names = F)
```

# Aortic aneurysm
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := AAN_date]
num_denom_0[,disease_flag := AAN_flag]
num_denom_0[,prev_disease_flag := AAN_prev_flag]
disease = "Aortic aneurysm"
disease_short = "AAN"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[disease_flag == 1]), big.mark="'")
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
format(nrow(num_denom), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]
num_denom[diag_year == 2000,.(db_patid, disease_flag, prev_disease_flag, diag_date, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
summary(numerator_by_subgroup$year)
summary(denominator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#fwrite(numerator_by_subgroup, file.path(PATH_W,paste(disease_short, "_numerator_by_subgroup.txt", sep ="")))

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
exp_cases_by_subgroup
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)

##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)

##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)


# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
levels(as.factor(numerator_by_subgroup$season)) # only Winter and Summer (others excluded above)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)

```



# Atrial fibrillation/flutter
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := AFF_date]
num_denom_0[,disease_flag := AFF_flag]
num_denom_0[,prev_disease_flag := AFF_prev_flag]
disease = "Atrial fibrillation/flutter"
disease_short = "AFF"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
#num_denom = num_denom[prev_disease_flag == 0]
#num_denom = num_denom[gold_db == 1]
#nrow(num_denom_0[HFA_flag == 1 & HFA_prev_flag == 1])

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
exp_cases_by_subgroup
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)
write.table(exp_cases_by_subgroup, file.path(PATH_P, paste(disease_short, "_exp_cases_by_subgroup.txt", sep ="")), sep="\t")

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)

##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```


# Heart block (second and third degree)
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := CHB_date]
num_denom_0[,disease_flag := CHB_flag]
num_denom_0[,prev_disease_flag := CHB_prev_flag]
disease = "Heart block"
disease_short = "CHB"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```


# Heart failure
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := HFA_date]
num_denom_0[,disease_flag := HFA_flag]
num_denom_0[,prev_disease_flag := HFA_prev_flag]
disease = "Heart failure"
disease_short = "HFA"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)

##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```


# Chronic ischaemic heart disease
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := IHD_date]
num_denom_0[,disease_flag := IHD_flag]
num_denom_0[,prev_disease_flag := IHD_prev_flag]
disease = "Chronic ischaemic heart disease"
disease_short = "IHD"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```


# Myocardial infarction / Acute coronary syndrome
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := AMI_date]
num_denom_0[,disease_flag := AMI_flag]
num_denom_0[,prev_disease_flag := AMI_prev_flag]
disease = "Acute coronary syndrome"
disease_short = "AMI"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
IRR_region
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```


# Peripheral arterial disease
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := PAD_date]
num_denom_0[,disease_flag := PAD_flag]
num_denom_0[,prev_disease_flag := PAD_prev_flag]
disease = "Peripheral arterial disease"
disease_short = "PAD"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```


# Stroke (excluding TIA)
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := STR_date]
num_denom_0[,disease_flag := STR_flag]
num_denom_0[,prev_disease_flag := STR_prev_flag]
disease = "Stroke"
disease_short = "STR"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```
# Aortic stenosis
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := AOS_date]
num_denom_0[,disease_flag := AOS_flag]
num_denom_0[,prev_disease_flag := AOS_prev_flag]
disease = "Aortic stenosis"
disease_short = "AOS"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]


# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)


# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```
# Venous thromboembolism or pulmonary embolism
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := VTE_date]
num_denom_0[,disease_flag := VTE_flag]
num_denom_0[,prev_disease_flag := VTE_prev_flag]
disease = "Venous thromboembolism"
disease_short = "VTE"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
#assign(paste(disease_short, "_num_denom", sep =""),num_denom)

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)),
q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

#summary(num_denom[disease_flag==1]$age_at_diag)
#hist(num_denom[disease_flag==1]$age_at_diag)
#lines(density(num_denom[disease_flag==1]$age_at_diag),  lwd = 2,col = "blue")
#plot(density(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag))
#incidence_by_age_in_years[order(-incidence)]

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)
  
##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)
  
##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)
```






# First CVD
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Disease specific variables
num_denom_0[,diag_date := first_CVD_date]
num_denom_0[,disease_flag := CVD ]
num_denom_0[,prev_disease_flag := pmax(AAN_prev_flag, AOS_prev_flag, AFF_prev_flag, HFA_prev_flag, AMI_prev_flag, IHD_prev_flag, CHB_prev_flag, PAD_prev_flag, STR_prev_flag, VTE_prev_flag)]
disease = "First cardiovascular disorder"
disease_short = "FIR"

# Disease-specific numerator-denominator table
num_denom =  num_denom_0[,.(db_patid, disease_flag, prev_disease_flag, diag_date, gender_name, birthyear, imd2015_5, region_name, gold_db, aurum_db, start_date, birth_date, regdate, todate, dod, lcdate, end_date)]
num_denom[, diag_year := year(diag_date)]
num_denom[, diag_month := month(diag_date)]
num_denom[, diag_season := season_table[month(diag_date),]$season]
#levels(as.factor(num_denom$diag_season))
num_denom[, age_at_diag := diag_year-birthyear]
format(nrow(num_denom[prev_disease_flag == 1]), big.mark="'")
format(nrow(num_denom[disease_flag == 1]), big.mark="'")
format(nrow(num_denom[disease_flag == 1 & prev_disease_flag == 0]) - nrow(num_denom[disease_flag == 1]), big.mark="'") 
#num_denom = num_denom[prev_disease_flag == 0]

# Checks
head(num_denom)
class(num_denom$diag_date)
class(num_denom$dod)
class(num_denom$todate)
format(nrow(num_denom), big.mark="'")
summary(num_denom$diag_date)
sum(num_denom$disease_flag)
summary(num_denom[disease_flag==1]$age_at_diag)
summary(num_denom[disease_flag==1 & diag_year == 2000]$age_at_diag)
summary(num_denom[disease_flag==1 & diag_year == 2018]$age_at_diag)

# Compute days at risk
num_denom = compute_days_at_risk_all_years(num_denom)
assign(paste(disease_short, "_numerator", sep =""),num_denom[disease_flag==1])
assign(paste(disease_short, "_denominator", sep =""),num_denom[disease_flag==0])

# Denominator by subgroup
denominator_by_subgroup = compute_denominator_by_subgroup(num_denom)
if (lookback_period >366*2){denominator_by_subgroup = denominator_by_subgroup[year>= 2002]}
nrow(denominator_by_subgroup[is.na(age_group)])
head(denominator_by_subgroup)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
sum(denominator_by_subgroup$patient_years)/nrow(denominator_by_subgroup)/365 # average number of years of follow-up 

# Numerator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup(num_denom)
if (lookback_period >366*2){numerator_by_subgroup = numerator_by_subgroup[year>= 2002]}
summary(numerator_by_subgroup$year)
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
assign(paste(disease_short, "_numerator_by_subgroup", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup", sep =""),denominator_by_subgroup)

# Overview
format(nrow(numerator_by_subgroup), big.mark="'")
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
write.table(numerator_by_subgroup, file.path(PATH_P,"CVD_numerator_by_subgroup.txt"), sep="\t")
write.table(denominator_by_subgroup, file.path(PATH_P,"CVD_denominator_by_subgroup.txt"), sep="\t")

# Expected cases by subgroup
exp_cases_by_subgroup = merge(x=numerator_by_subgroup, y= denominator_by_subgroup, all.x = TRUE, all.y = TRUE, sort = FALSE)
exp_cases_by_subgroup = merge(x=exp_cases_by_subgroup, y=esp, by = c("age_group"), all.x = TRUE, sort = FALSE)
exp_cases_by_subgroup[,exp_cases:= round((cases/ patient_years)*esp_population,1)]
exp_cases_by_subgroup[is.na(exp_cases)]$exp_cases = 0
exp_cases_by_subgroup[,disease := disease]
assign(paste(disease_short, "_exp_cases_by_subgroup", sep =""),exp_cases_by_subgroup)

# Incidence by calendar year
incidence_table_by_year= compute_incidence_by_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_table_by_year # incidence rates per 100'000 years at risk
assign(paste(disease_short, "_incidence_table_by_year", sep =""),incidence_table_by_year)

##  Incidence by age in years
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom, disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_incidence_by_age_in_years", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Men
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Male"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_men", sep =""),incidence_by_age_in_years)

##  Incidence by age in years - Women
incidence_by_age_in_years = compute_incidence_by_age_in_years(num_denom[gender_name == "Female"], disease) 
incidence_by_age_in_years # standardized incidence per 100'000 patient-years
#incidence_by_age_in_years = incidence_by_age_in_years[order(age_at_diag)]
assign(paste(disease_short, "_incidence_by_age_in_years_women", sep =""),incidence_by_age_in_years)

# Median age at diagnosis
median_age_at_diag_table = data.table(disease = disease, q1 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.25)), median = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.5)), q3 = quantile(num_denom[disease_flag==1]$age_at_diag, prob=c(.75)), q1_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.25)),median_women = quantile(num_denom[disease_flag==1 & gender_name == "Female"]$age_at_diag, prob=c(.5)), q3_women = quantile(num_denom[disease_flag==1& gender_name == "Female"]$age_at_diag, prob=c(.75)), q1_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.25)),median_men = quantile(num_denom[disease_flag==1 & gender_name == "Male"]$age_at_diag, prob=c(.5)), q3_men = quantile(num_denom[disease_flag==1& gender_name == "Male"]$age_at_diag, prob=c(.75)))
median_age_at_diag_table
assign(paste(disease_short, "_median_age_at_diag_table", sep =""),median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table = compute_mean_age_by_ses_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_ses", sep =""),mean_age_at_diag_table)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table = compute_mean_age_by_gender_year(disease, num_denom)
mean_age_at_diag_table
assign(paste(disease_short, "_mean_age_at_diag_table_gender", sep =""),mean_age_at_diag_table)

##  Incidence by gender and time
incidence_by_gender = compute_incidence_by_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_gender
#levels(as.factor(incidence_by_gender$year))
incidence_by_gender[year == "All years"]
assign(paste(disease_short, "_incidence_by_gender", sep =""),incidence_by_gender)

##  Incidence by ses and time
incidence_by_ses = compute_incidence_by_ses_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses
assign(paste(disease_short, "_incidence_by_ses", sep =""),incidence_by_ses)

##  Incidence by ses, gender and time
incidence_by_ses_gender = compute_incidence_by_ses_gender_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_ses_gender
assign(paste(disease_short, "_incidence_by_ses_gender", sep =""),incidence_by_ses_gender)
  
##  Incidence by region and time
incidence_by_region = compute_incidence_by_region_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_region
assign(paste(disease_short, "_incidence_by_region", sep =""),incidence_by_region)
  
##  Incidence by age-group and time
incidence_by_age_group = compute_incidence_by_age_group_year(numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_age_group
assign(paste(disease_short, "_incidence_by_age_group", sep =""),incidence_by_age_group)

##  Incidence by 5-year-age-band
incidence_by_5y_age_band = compute_incidence_by_5y_age_band (numerator_by_subgroup, denominator_by_subgroup, disease)
incidence_by_5y_age_band
assign(paste(disease_short, "_incidence_by_5y_age_band", sep =""),incidence_by_5y_age_band)
  
##  Age-gender-standardized incidence by year-group
stand_incidence_by_year_group_CI = compute_standardized_incidence_by_year_group_CI(numerator_by_subgroup, denominator_by_subgroup, disease) 
stand_incidence_by_year_group_CI # standardized incidence per 100'000 patient-years
assign(paste(disease_short, "_stand_incidence_by_year_group_CI", sep =""),stand_incidence_by_year_group_CI)

# Temporal trends
IRR_time = negbin_reg_stand_year_group (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$cases)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2000","2001", "2002")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time", sep =""),IRR_time)

# Temporal trends - sensitivity analyses comparing the year 2017-2019 with the years 2005-2007
IRR_time = negbin_reg_stand_year_group_sens_2005_2007 (numerator_by_subgroup, denominator_by_subgroup, "factor(year_group)2017-2019")
IRR_time$IRR_time_crude = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$cases)/sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$patient_years)/(sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$cases)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$patient_years)),2)
IRR_time$IRR_time_stand_unadj = round(sum(incidence_table_by_year[year %in% c("2017","2018", "2019")]$incidence_stand)/sum(incidence_table_by_year[year %in% c("2005","2006", "2007")]$incidence_stand), 2)
IRR_time
assign(paste(disease_short, "_IRR_time_sens_2005_2007", sep =""),IRR_time)

# Plot residuals to check mean-variance relationship 
model = negbin_reg_stand_model (numerator_by_subgroup, denominator_by_subgroup)
plot(model$fitted,model$residuals,pch=19,col="grey",ylab="Residuals",xlab="Fitted")

# IRR by GENDER
IRR_gender = negbin_reg_stand_gender(numerator_by_subgroup, denominator_by_subgroup, "gender_nameMale")
IRR_gender$IRR_gender_crude = round(sum(incidence_by_gender[gender_name == "Female"]$cases)/sum(incidence_by_gender[gender_name == "Female"]$patient_years)/(sum(incidence_by_gender[gender_name == "Male"]$cases)/sum(incidence_by_gender[gender_name == "Male"]$patient_years)),2)
IRR_gender$IRR_gender_stand_unadj = round(sum(incidence_by_gender[gender_name == "Female"]$incidence_stand)/sum(incidence_by_gender[gender_name == "Male"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_gender", sep =""),IRR_gender) # incidence rate ratio of women compared to men
IRR_gender

# IRR by SES
IRR_ses = negbin_reg_stand_ses(numerator_by_subgroup, denominator_by_subgroup, "as.factor(imd2015_5)5")
IRR_ses$IRR_ses_crude  = round(sum(incidence_by_ses[imd2015_5 == "5"]$cases)/sum(incidence_by_ses[imd2015_5 == "5"]$patient_years)/(sum(incidence_by_ses[imd2015_5 == "1"]$cases)/sum(incidence_by_ses[imd2015_5 == "1"]$patient_years)),2)
IRR_ses$IRR_ses_stand_unadj = round(sum(incidence_by_ses[imd2015_5 == "5"]$incidence_stand)/sum(incidence_by_ses[imd2015_5 == "1"]$incidence_stand), 2)
assign(paste(disease_short, "_IRR_ses", sep =""),IRR_gender) # incidence rate ratio of women compared to men
IRR_ses

# IRR by SES and REGION
IRR_region = negbin_reg_stand_ses_region(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_region", sep =""),IRR_region) # incidence rate ratio of women compared to men

# IRR by SEASON
# Numerator/denominator by subgroup
numerator_by_subgroup = compute_numerator_by_subgroup_season(num_denom)
numerator_by_subgroup =numerator_by_subgroup[season != "Other"]
format(nrow(numerator_by_subgroup), big.mark="'")
format(sum(numerator_by_subgroup$cases), big.mark="'")
denominator_by_subgroup = compute_denominator_by_subgroup_season(num_denom)
format(nrow(denominator_by_subgroup), big.mark="'")
format(sum(denominator_by_subgroup$patient_years), big.mark="'")
IRR_season = negbin_reg_stand_season(numerator_by_subgroup, denominator_by_subgroup)
assign(paste(disease_short, "_IRR_season", sep =""),IRR_season) # incidence rate ratio of women compared to men
assign(paste(disease_short, "_numerator_by_subgroup_season", sep =""),numerator_by_subgroup)
assign(paste(disease_short, "_denominator_by_subgroup_season", sep =""),denominator_by_subgroup)

#numerator= num_denom[disease_flag == 1]
#num_denom_by_season = numerator[,.(cases=sum(disease_flag)),  by=.(diag_month)]
#num_denom_by_season[is.na(cases)]$cases= 0
#setnames(num_denom_by_season, old = "diag_month", new = "month")
#num_denom_by_season
#ggplot(num_denom_by_season, aes(x = month, y = cases))+  geom_point() + geom_line() + theme_bw() + theme( legend.position = "bottom", legend.title=element_blank(), axis.title.y = element_blank()) + scale_y_continuous(limits=c(0,NA))

#numerator= num_denom[disease_flag == 1]
#num_denom_by_season = numerator[,.(cases=sum(disease_flag)),  by=.(diag_season)]
#num_denom_by_season[is.na(cases)]$cases= 0
#num_denom_by_season
#ggplot(num_denom_by_season, aes(x = diag_season, y = cases))+  geom_point() + geom_line() + theme_bw() + theme( legend.position = "bottom", legend.title=element_blank(), axis.title.y = element_blank()) + scale_y_continuous(limits=c(0,NA))
```


# Aggregate incidence tables
```{r, eval=TRUE, warning=FALSE, message=FALSE}
#AAN_flag + AOS_flag + AFF_flag + HFA_flag + AMI_flag + IHD_flag + CHB_flag + PAD_flag + STR_flag + VTE_flag
# VAD, MVD, TVD, PVD, UVD, IHS, HST, UNS, TIA, PMK
incidence_table_by_year = rbind(FIR_incidence_table_by_year, AAN_incidence_table_by_year, AOS_incidence_table_by_year, AFF_incidence_table_by_year, CHB_incidence_table_by_year, HFA_incidence_table_by_year,  IHD_incidence_table_by_year, AMI_incidence_table_by_year, PAD_incidence_table_by_year, STR_incidence_table_by_year, VTE_incidence_table_by_year, fill = TRUE)
head(incidence_table_by_year)

#incidence_table_by_year = rbind(data.table(disease = "Any cardiovascular disorder", incidence_stand = sum(incidence_table_by_year[disease %in% c("Aortic aneurysm",       "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease",  "Heart failure", "Myocardial infarction", "Peripheral arterial disease", "Heart block",  "Stroke", "Venous thromboembolism")]$incidence_stand)), incidence_table_by_year, fill = TRUE)
#kable(incidence_table_by_year)

incidence_by_gender = rbind(FIR_incidence_by_gender, AAN_incidence_by_gender, AOS_incidence_by_gender, AFF_incidence_by_gender, CHB_incidence_by_gender, HFA_incidence_by_gender,  IHD_incidence_by_gender, AMI_incidence_by_gender, PAD_incidence_by_gender, STR_incidence_by_gender, VTE_incidence_by_gender, fill = TRUE)
incidence_by_gender
#incidence_by_gender = rbind(data.table(disease = "Any cardiovascular disorder", incidence_stand = sum(incidence_by_gender[disease %in% c("Aortic aneurysm",       "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease",  "Heart failure", "Myocardial infarction", "Peripheral arterial disease", "Heart block",  "Stroke", "Venous thromboembolism")]$incidence_stand)), incidence_by_gender, fill = TRUE)

incidence_by_ses = rbind(FIR_incidence_by_ses, AAN_incidence_by_ses, AOS_incidence_by_ses, AFF_incidence_by_ses, CHB_incidence_by_ses, HFA_incidence_by_ses,  IHD_incidence_by_ses, AMI_incidence_by_ses, PAD_incidence_by_ses, STR_incidence_by_ses, VTE_incidence_by_ses, fill = TRUE)
#incidence_by_ses = rbind(data.table(disease = "Any cardiovascular disorder", incidence_stand = sum(incidence_by_ses[disease %in% c("Aortic aneurysm",       "Aortic stenosis", "Atrial fibrillation/flutter", "Chronic ischaemic heart disease",  "Heart failure", "Myocardial infarction", "Peripheral arterial disease", "Heart block",  "Stroke", "Venous thromboembolism")]$incidence_stand)), incidence_by_gender, fill = TRUE)

incidence_by_ses_gender = rbind(FIR_incidence_by_ses_gender, AAN_incidence_by_ses_gender, AOS_incidence_by_ses_gender, AFF_incidence_by_ses_gender, CHB_incidence_by_ses_gender, HFA_incidence_by_ses_gender,  IHD_incidence_by_ses_gender, AMI_incidence_by_ses_gender, PAD_incidence_by_ses_gender, STR_incidence_by_ses_gender, VTE_incidence_by_ses_gender, fill = TRUE)

incidence_by_region = rbind(FIR_incidence_by_region, AAN_incidence_by_region, AOS_incidence_by_region, AFF_incidence_by_region, CHB_incidence_by_region, HFA_incidence_by_region,  IHD_incidence_by_region, AMI_incidence_by_region, PAD_incidence_by_region, STR_incidence_by_region, VTE_incidence_by_region, fill = TRUE)

incidence_by_age_group = rbind(FIR_incidence_by_age_group, AAN_incidence_by_age_group, AOS_incidence_by_age_group, AFF_incidence_by_age_group, CHB_incidence_by_age_group, HFA_incidence_by_age_group,  IHD_incidence_by_age_group, AMI_incidence_by_age_group, PAD_incidence_by_age_group, STR_incidence_by_age_group, VTE_incidence_by_age_group, fill = TRUE)

incidence_incidence_by_5y_age_band = rbind(FIR_incidence_by_5y_age_band, AAN_incidence_by_5y_age_band, AOS_incidence_by_5y_age_band, AFF_incidence_by_5y_age_band, CHB_incidence_by_5y_age_band, HFA_incidence_by_5y_age_band,  IHD_incidence_by_5y_age_band, AMI_incidence_by_5y_age_band, PAD_incidence_by_5y_age_band, STR_incidence_by_5y_age_band, VTE_incidence_by_5y_age_band, fill = TRUE)

incidence_by_age_in_years_men = rbind(FIR_incidence_by_age_in_years_men, AAN_incidence_by_age_in_years_men, AOS_incidence_by_age_in_years_men, AFF_incidence_by_age_in_years_men, CHB_incidence_by_age_in_years_men, HFA_incidence_by_age_in_years_men,  IHD_incidence_by_age_in_years_men, AMI_incidence_by_age_in_years_men, PAD_incidence_by_age_in_years_men, STR_incidence_by_age_in_years_men, VTE_incidence_by_age_in_years_men, fill = TRUE)

incidence_by_age_in_years_women = rbind(FIR_incidence_by_age_in_years_women, AAN_incidence_by_age_in_years_women, AOS_incidence_by_age_in_years_women, AFF_incidence_by_age_in_years_women, CHB_incidence_by_age_in_years_women, HFA_incidence_by_age_in_years_women,  IHD_incidence_by_age_in_years_women, AMI_incidence_by_age_in_years_women, PAD_incidence_by_age_in_years_women, STR_incidence_by_age_in_years_women, VTE_incidence_by_age_in_years_women, fill = TRUE)

# Median age at diagnosis
median_age_at_diag_table = rbind(FIR_median_age_at_diag_table, AAN_median_age_at_diag_table, AOS_median_age_at_diag_table, AFF_median_age_at_diag_table, CHB_median_age_at_diag_table, HFA_median_age_at_diag_table,  IHD_median_age_at_diag_table, AMI_median_age_at_diag_table, PAD_median_age_at_diag_table, STR_median_age_at_diag_table, VTE_median_age_at_diag_table, fill = TRUE)
kable(median_age_at_diag_table)
#median_age_at_diag_table = rbind(ADD_median_age_at_diag_table, ASP_median_age_at_diag_table, fill = TRUE)
#kable(median_age_at_diag_table)

# Mean age at diagnosis by year and ses
mean_age_at_diag_table_ses = rbind(FIR_mean_age_at_diag_table_ses, AAN_mean_age_at_diag_table_ses, AOS_mean_age_at_diag_table_ses, AFF_mean_age_at_diag_table_ses, CHB_mean_age_at_diag_table_ses, HFA_mean_age_at_diag_table_ses,  IHD_mean_age_at_diag_table_ses, AMI_mean_age_at_diag_table_ses, PAD_mean_age_at_diag_table_ses, STR_mean_age_at_diag_table_ses, VTE_mean_age_at_diag_table_ses, fill = TRUE)

# Mean age at diagnosis by year and gender
mean_age_at_diag_table_gender = rbind(FIR_mean_age_at_diag_table_gender, AAN_mean_age_at_diag_table_gender, AOS_mean_age_at_diag_table_gender, AFF_mean_age_at_diag_table_gender, CHB_mean_age_at_diag_table_gender, HFA_mean_age_at_diag_table_gender,  IHD_mean_age_at_diag_table_gender, AMI_mean_age_at_diag_table_gender, PAD_mean_age_at_diag_table_gender, STR_mean_age_at_diag_table_gender, VTE_mean_age_at_diag_table_gender, fill = TRUE)

stand_incidence_by_year_group_CI = rbind(FIR_stand_incidence_by_year_group_CI, AAN_stand_incidence_by_year_group_CI, AOS_stand_incidence_by_year_group_CI, AFF_stand_incidence_by_year_group_CI, CHB_stand_incidence_by_year_group_CI, HFA_stand_incidence_by_year_group_CI,  IHD_stand_incidence_by_year_group_CI, AMI_stand_incidence_by_year_group_CI, PAD_stand_incidence_by_year_group_CI, STR_stand_incidence_by_year_group_CI, VTE_stand_incidence_by_year_group_CI,  fill = TRUE)
kable(stand_incidence_by_year_group_CI)

IRR_time = rbind(FIR_IRR_time, AAN_IRR_time, AOS_IRR_time, AFF_IRR_time, CHB_IRR_time, HFA_IRR_time,  IHD_IRR_time, AMI_IRR_time, PAD_IRR_time, STR_IRR_time, VTE_IRR_time,  fill = TRUE)
kable(IRR_time)
IRR_time_sens_2005_2007 = rbind(FIR_IRR_time_sens_2005_2007, AAN_IRR_time_sens_2005_2007, AOS_IRR_time_sens_2005_2007, AFF_IRR_time_sens_2005_2007, CHB_IRR_time_sens_2005_2007, HFA_IRR_time_sens_2005_2007,  IHD_IRR_time_sens_2005_2007, AMI_IRR_time_sens_2005_2007, PAD_IRR_time_sens_2005_2007, STR_IRR_time_sens_2005_2007, VTE_IRR_time_sens_2005_2007,  fill = TRUE)
kable(IRR_time_sens_2005_2007)



# IRR by GENDER
IRR_gender = rbind(FIR_IRR_gender, AAN_IRR_gender, AOS_IRR_gender, AFF_IRR_gender, CHB_IRR_gender, HFA_IRR_gender,  IHD_IRR_gender, AMI_IRR_gender, PAD_IRR_gender, STR_IRR_gender, VTE_IRR_gender,  fill = TRUE)
kable(IRR_gender)


# IRR by REGION
IRR_region = rbind(FIR_IRR_region, AAN_IRR_region, AOS_IRR_region, AFF_IRR_region, CHB_IRR_region, HFA_IRR_region,  IHD_IRR_region, AMI_IRR_region, PAD_IRR_region, STR_IRR_region, VTE_IRR_region, fill = TRUE)
kable(IRR_region)


# IRR by SEASON
IRR_season = rbind(FIR_IRR_season, AAN_IRR_season, AOS_IRR_season, AFF_IRR_season, CHB_IRR_season, HFA_IRR_season,  IHD_IRR_season, AMI_IRR_season, PAD_IRR_season, STR_IRR_season, VTE_IRR_season,  fill = TRUE)
kable(IRR_season)
```

# Store incidence tables
```{r, eval=TRUE, warning=FALSE, message=FALSE}
#write.table(ASP_num_denom, file.path(PATH_P,"ASP_num_denom.txt"), sep="\t")
write.table(incidence_table_by_year, file.path(PATH_P,"CVD_incidence_table_by_year.txt"), sep="\t")
write.table(incidence_by_gender, file.path(PATH_P,"CVD_incidence_by_gender.txt"), sep="\t")
write.table(incidence_by_ses, file.path(PATH_P,"CVD_incidence_by_ses.txt"), sep="\t")
write.table(incidence_by_ses_gender, file.path(PATH_P,"CVD_incidence_by_ses_gender.txt"), sep="\t")
write.table(incidence_by_region, file.path(PATH_P,"CVD_incidence_by_region.txt"), sep="\t")
write.table(incidence_by_age_group, file.path(PATH_P,"CVD_incidence_by_age_group.txt"), sep="\t")
write.table(incidence_incidence_by_5y_age_band, file.path(PATH_P,"CVD_incidence_by_5y_age_band.txt"), sep="\t")
write.table(incidence_by_age_in_years, file.path(PATH_P,"CVD_incidence_by_age_in_years.txt"), sep="\t")
write.table(incidence_by_age_in_years_men, file.path(PATH_P,"CVD_incidence_by_age_in_years_men.txt"), sep="\t")
write.table(incidence_by_age_in_years_women, file.path(PATH_P,"CVD_incidence_by_age_in_years_women.txt"), sep="\t")
write.table(median_age_at_diag_table, file.path(PATH_P,"CVD_median_age_at_diag_table.txt"), sep="\t")
write.table(mean_age_at_diag_table_ses, file.path(PATH_P,"CVD_mean_age_at_diag_table_ses.txt"), sep="\t")
write.table(mean_age_at_diag_table_gender, file.path(PATH_P,"CVD_mean_age_at_diag_table_gender.txt"), sep="\t")
write.table(IRR_time, file.path(PATH_P,"CVD_IRR_table_2017-2019_vs_2000-2002.txt"), sep="\t")
write.table(stand_incidence_by_year_group_CI, file.path(PATH_P,"CVD_stand_incidence_by_year_group_CI_all.txt"), sep="\t")
write.table(IRR_gender, file.path(PATH_P,"CVD_IRR_gender.txt"), sep="\t")
write.table(IRR_region, file.path(PATH_P,"CVD_IRR_region.txt"), sep="\t")
write.table(IRR_season, file.path(PATH_P,"CVD_IRR_season.txt"), sep="\t")
```





