---
title: "CVD Incidence - CASE IDENTIFICATION"
author: "Nathalie Conrad"
date: "October 2023"
output: html_document
---

# LIBRARIES AND SETTINGS
```{r, warning=FALSE, message=FALSE}
#install.packages("gdata")
library(data.table)
library(knitr)
#library(gdata)
#library(ggplot2)
library(rapportools)
#library(rapport)
library(bit64)
library(epiR)
library(gdata)
```

# STUDY CRITERIA 

## Sensitivity analyses
```{r, eval=TRUE, warning=FALSE, message=FALSE}
include_cvd_death = "yes" # select yes if fatal CVD events are to be included, select no if only cvd diagnoses (in primary or secondary care are to be included)
# includes cvd deaths recorded in any of the 15 death causes
```

## Study Dates
```{r, eval=TRUE, warning=FALSE, message=FALSE}
#Data: CPRD Jan 2021 Release DR-8944
#study_start_date = as.Date("01/01/1995", format="%d/%m/%Y")
study_start_date = as.Date("01/01/1998", format="%d/%m/%Y")
study_end_date = as.Date("30/06/2019", format="%d/%m/%Y")
```

## Work Environment
```{r, warning=FALSE, message=FALSE}
# Secure data directories
PATH_D = "/Users/u0133446/CPRD-2020/CPRD-DATA-1stRelease" # path to data directory
PATH_D2 = "/Users/u0133446/CPRD-2020/Final_Delivery1_19_156" # path to data directory
PATH_W = "/Users/u0133446/CPRD-2020/Workspace/CVD_incidence" # path to workspace directory
PATH_W_orig = "/Users/u0133446/CPRD-2020/Workspace" # path to workspace directory
#PATH_L = "/Users/u0133446/CPRD-2020/CPRD-DATA-1stRelease/Lookups" # path to lookups directory
PATH_L = "/Users/u0133446/CPRD-2020/Final_Delivery1_19_156/Lookups" # path to lookups directory
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification.RData"))

# Dropbox directories for diagnostic codes, aggregated tables and plots
PATH = "/Users/u0133446/Dropbox/Leuven/INF-CVD" # path to dropbox directory
PATH_P = "/Users/u0133446/Dropbox/Leuven/INF-CVD/CPRD-2020_non_data/Plots/CVD_incidence" # path to plots directory
```


## My functions
```{r, eval=TRUE, warning=FALSE, message=FALSE}
compute_days = function (year, data, diag_date){
  year_start = as.Date(paste("01/01/",year,sep=""), format="%d/%m/%Y")
  year_end = as.Date(paste("31/12/",year,sep=""), format="%d/%m/%Y")
  days=as.numeric(pmax(pmin(diag_date, data$end_date,year_end,na.rm=T)+1 - pmax(data$start_date, year_start),0))
return(days)}
#as.numeric(pmax(pmin(diag_date, data$end_date,na.rm=T)+1 - data$start_date,0))
#as.numeric(pmax(pmin(2000-04-14, 2000-04-14,na.rm=T)+1 - 2000-01-01,0))
#as.numeric(pmax(as.Date(14/04/2000, format="%d/%m/%Y")+1 - as.Date(01/01/2000, format="%d/%m/%Y"),0))
#test=as.Date(14-04-2000, format="%d/%m/%Y")

age_group_fun = function (yob, ref_year) { 
  delta = as.numeric(as.character(ref_year)) - yob
  age_group_id = pmin((delta%/%5)+pmin(delta,1),20)
  return (age_group_id)}
```

## Disease codes - (code review 03/03/2023)
```{r disease_codes, eval=TRUE, warning=FALSE, message=FALSE}
# all codes
all_codes_table = data.table(read.table(file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/2023-03-03_FINAL_CVD_diagnostic_codes_table_JMM.txt"), header = TRUE, sep="\t", colClasses=c("medcode_aurum"="integer64"))) # Final set of codes for analysis as per JMM review 03/03/2023
nrow(all_codes_table)
head(all_codes_table)
levels(as.factor(all_codes_table$include))

all_codes_table = all_codes_table[include == 1]

head(all_codes_table)
colnames(all_codes_table)
nrow(all_codes_table)
levels(as.factor(all_codes_table$include))
levels(as.factor(all_codes_table$codetype))
levels(as.factor(all_codes_table$disease))

# gold 
gold_codes_table = all_codes_table[codetype == "gold"]
nrow(gold_codes_table)

# aurum
aurum_codes_table = all_codes_table[codetype == "aurum"]
nrow(aurum_codes_table)
# Check that aurum codes have not been shortened
class(aurum_codes_table$medcode_aurum)
summary(aurum_codes_table$medcode_aurum)

#max(as.integer64(diag_read_codes_table1$medcode_aurum))
# if max = 1..e+16 then codes have been truncated
aurum_codes_table[medcode_aurum == "11920121000006117"]
#Transient cerebral ischemia

# icd
icd_codes_table = all_codes_table[codetype == "icd"]
icd_codes_table[,alt_icd_code:= gsub("\\.", "", icd_code)] # remove "." in ICD-10 codes
nrow(icd_codes_table)
icd_codes_table

# icd version 9 and 10 (only used in death records up to the year 2000)
icd_9_10_codes_table = all_codes_table[codetype %in% c("icd9", "icd")]
icd_9_10_codes_table[,alt_icd_code:= gsub("\\.", "", icd_code)] # remove "." in ICD-10 codes
nrow(icd_9_10_codes_table)
icd_9_10_codes_table[codetype == "icd9"]

# opcs
opcs_codes_table= all_codes_table[codetype == "opcs"]
opcs_codes_table[,alt_opcs_code:= gsub("\\.", "", opcs_code)] # remove "." in ICD-10 codes
nrow(opcs_codes_table)

nrow(gold_codes_table)+nrow(aurum_codes_table)+nrow(icd_codes_table)+nrow(opcs_codes_table)

# Full original dictionary including codes labeled as include ==  0-possible (ie to be excluded) - for checks only
diag_codes_table_inc_0 = data.table(read.table(file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/2023-03-03_FULL_CVD_diagnostic_codes_table_JMM.txt"), header = TRUE, sep="\t", colClasses=c("medcode_aurum"="integer64"))) # This table includes all codes considered for this analysis including those labeled as include %in% c("0", "0-possible") ONLY for CHECKs
nrow(diag_codes_table_inc_0)
```

# READ MAIN TABLES

## 1. DENOMINATOR FILES

## 1.1 DENOMINATOR in CPRD GOLD
```{r, eval=TRUE, warning=FALSE, message=FALSE}
gold_source_main= fread(file.path(PATH_D,"/CPRD_GOLD/Source/GOLD_interim.txt.gz"), header = T, sep="\t")
gold_source_imd= fread(file.path(PATH_D,"/CPRD_GOLD/Source/GOLD_patient_imd2015_interim.txt.gz"), header = T, sep="\t")
gold_source_ons= fread(file.path(PATH_D,"/CPRD_GOLD/Source/GOLD_ONS_interim.txt.gz"), header = T, sep="\t")

# Check total number of records
nrow(gold_source_main)
nrow(gold_source_imd)
nrow(gold_source_ons)

#summary(gold_source_imd$imd2015_5)

# Check only patients with HES, ONS and SES linkage and ACCEPTable patients are included
nrow(gold_source_main[hes_e==0|death_e==0|lsoa_e==0|accept==0])

# Merge main table with IMD and DEATH tables
denominator_gold = merge(gold_source_main, gold_source_imd[,.(patid, imd2015_5)], by= "patid", all = TRUE)
denominator_gold = merge(denominator_gold, gold_source_ons[,.(patid, dod)], by= "patid", all = TRUE)
colnames(denominator_gold)
#gold_source = merge(gold_source_0, gold_source_ons, by= "patid", all = TRUE)
#gold_source_imd[patid==110010] # check missing data for imd
#nrow(gold_source [!(dod.x == dod.y)])  # check differences in dod data

# Get sex description
gender_lookup= fread(file.path(PATH_L,"/GOLD/TXTFILES/SEX.txt"), header = T, sep="\t")
setnames(gender_lookup, old=c("Code", "Sex"), new =c("gender", "gender_name"))
denominator_gold = merge(denominator_gold, gender_lookup, by= "gender", all.x = TRUE)

# Get Region description
region_lookup= fread(file.path(PATH_L,"/GOLD/TXTFILES/PRG.txt"), header = T, sep="\t")
setnames(region_lookup, old=c("Code", "Practice Region"), new =c("region", "region_name"))
region_lookup[region_name == "Yorkshire & The Humber"]$region_name = "Yorkshire And The Humber"
region_lookup
denominator_gold = merge(denominator_gold, region_lookup, by= "region", all.x = TRUE)

# Check dates
nrow(denominator_gold[is.na(regdate)])
nrow(denominator_gold[is.na(todate)])
nrow(denominator_gold[is.na(lcdate)])

# Set correct date format
denominator_gold[,regdate:=as.Date(regdate, format="%d/%m/%Y")] #set date format
#denominator_gold[,utsdate:=as.Date(utsdate, format="%d/%m/%Y")] #set date format  --- UTS MISSING in 2nd delivery
denominator_gold[,todate:=as.Date(todate, format="%d/%m/%Y")] #set date format
denominator_gold[,dod:=as.Date(dod, format="%d/%m/%Y")] #set date format
denominator_gold[,deathdate:=as.Date(deathdate, format="%d/%m/%Y")] #set date format
denominator_gold[,lcdate:=as.Date(lcdate, format="%d/%m/%Y")] #set date format

# Registration start and end dates
denominator_gold[,birth_date := as.Date(paste("30/06/",birthyear, sep=""), format="%d/%m/%Y")]
#denominator_gold$start_date = pmax(denominator_gold$regdate, study_start_date,denominator_gold$birth_date, denominator_gold$utsdate, na.rm=T)
denominator_gold[,start_date := pmax(regdate, study_start_date, birth_date, na.rm=T)]
denominator_gold[,end_date := pmin(todate, study_end_date, dod, lcdate, na.rm=T)]
denominator_gold[,reg_time:=end_date-start_date]
nrow(denominator_gold[is.na(start_date)])
nrow(denominator_gold[is.na(end_date)])

# Deduplicate practices from GOLD that have moved to Aurum
Vision_to_Emis_practices= fread(file.path(PATH_D,"/CPRD_GOLD/VisionToEmisMigrators_old_format.txt.gz"), header = T, sep="\t")
nrow(Vision_to_Emis_practices)
Vision_to_Emis_practices = unique(Vision_to_Emis_practices)
nrow(Vision_to_Emis_practices)
length(unique(Vision_to_Emis_practices$gold_pracid))
Vision_to_Emis_practices$exclude=1 ## label patids with exclude == 1 => those patients who are both in CPRD gold and aurum
denominator_gold = merge (denominator_gold, Vision_to_Emis_practices, by.x="pracid", by.y="gold_pracid", all.x =TRUE)
nrow(denominator_gold[is.na(exclude)])
denominator_gold[is.na(exclude), exclude:= 0]
nrow(denominator_gold)
head(denominator_gold)

# !! NEW on 15 Sep 2021 - NEW GOLD patids
denominator_gold[,patidold:= patid]
denominator_gold[,pracidold:= pracid]
# change pracids
denominator_gold[,pracid := as.character(substr(patid, floor(log10(patid))-1, floor(log10(patid))+1 ))] # pracid = last three digits of patidold
denominator_gold[,pracid:= paste("10",pracid,sep="")] # new pracid = "10" + last three digits of patidold 
# change patids
denominator_gold[,patid := as.character(substr(patidold, 1, floor(log10(patidold))-2 ))] # patid all digits up to the last three (which are the pracid)
denominator_gold[,patid:= as.numeric(paste(patid,pracid,sep=""))] # new patid = old patid (up to the last three digits) + new pracid 
#denominator_gold[patid == 1002210231]
#1000010010	10010	10000010	10	
#1002210231	10231	10022231	231

## get table with old/new patids
#old_new_patids= fread("/Users/u0133446/CPRD-2020/Final_Delivery1_19_156/GOLD/Data/old_new_patids_pracids.txt.gz") 
#nrow(old_new_patids) # this tables contains new patids only for patids in the second delivery

```

## 1.2 DENOMINATOR in CPRD AURUM
```{r, eval=TRUE, warning=FALSE, message=FALSE}
aurum_source_main= fread(file.path(PATH_D,"/CPRD_Aurum/Source/Aurum_interim.txt.gz"), header = T, sep="\t")
aurum_source_imd= fread(file.path(PATH_D,"/CPRD_Aurum/Source/Aurum_patient_imd2015_interim.txt.gz"), header = T, sep="\t")
aurum_source_ons= fread(file.path(PATH_D,"/CPRD_Aurum/Source/Aurum_ONS_interim.txt.gz"), header = T, sep="\t")

# Check total number of records
nrow(aurum_source_main)
nrow(aurum_source_imd)
nrow(aurum_source_ons)
summary(aurum_source_imd$imd2015_5)

# Check only patients with HES, ONS and SES linkage and ACCEPTable patients are included
nrow(aurum_source_main[hes_e==0|death_e==0|lsoa_e==0|acceptable==0])

# Merge main table with IMD and DEATH tables
denominator_aurum = merge(aurum_source_main, aurum_source_imd[,.(patid, imd2015_5)], by= "patid", all = TRUE)
denominator_aurum = merge(denominator_aurum, aurum_source_ons[,.(patid, dod)], by= "patid", all = TRUE)
setnames(denominator_aurum, old=c("acceptable", "lcd", "yob"), new =c("accept", "lcdate", "birthyear"))

# Get Gender description
denominator_aurum$gender_name = ""
denominator_aurum[gender == "F"]$gender_name = "Female"
denominator_aurum[gender == "M"]$gender_name = "Male"

# Get Region description
denominator_aurum[pracid == 20957]$region = 5
region_lookup_aurum= fread(file.path(PATH_L,"/Aurum/Region.txt"), header = T, sep="\t")
setnames(region_lookup_aurum, old=c("regionid", "Description"), new =c("region", "region_name"))
nrow(denominator_aurum[is.na(region)]) 
denominator_aurum = merge(denominator_aurum, region_lookup_aurum, by= "region", all.x = TRUE)

# Set correct date format
denominator_aurum[,regdate:=as.Date(regstartdate, format="%d/%m/%Y")] #set date format
denominator_aurum[,todate:=as.Date(regenddate, format="%d/%m/%Y")] #set date format
denominator_aurum[,dod:=as.Date(dod, format="%d/%m/%Y")] #set date format
denominator_aurum[,lcdate:=as.Date(lcdate, format="%d/%m/%Y")] #set date format

# Check dates
nrow(denominator_aurum[is.na(regdate)])
nrow(denominator_aurum[is.na(todate)])
nrow(denominator_aurum[is.na(lcdate)])

# Registration start and end dates
denominator_aurum[,birth_date := as.Date(paste("30/06/",denominator_aurum$birthyear, sep=""), format="%d/%m/%Y")]
denominator_aurum[,start_date := pmax(regdate, study_start_date,birth_date, na.rm=T)]
denominator_aurum[,end_date := pmin(todate, study_end_date, dod, lcdate, na.rm=T)]
denominator_aurum[,reg_time:=end_date-start_date]
nrow(denominator_aurum[is.na(start_date)])
nrow(denominator_aurum[is.na(end_date)])
```

## 1.3 Rbind GOLD and AURUM denominator files
```{r, eval=TRUE, warning=FALSE, message=FALSE}
denominator_gold[,gold_db := 1] 
denominator_gold[,db_patid := paste("G", patid, sep="")] 
denominator_aurum[,aurum_db := 1] 
denominator_aurum[,db_patid := paste("A", patid, sep="")] 
denominator = rbind(denominator_gold[exclude==0], denominator_aurum, fill=TRUE) ## exclude patids with exclude == 1 - those patients who are both in CPRD gold and aurum
head(denominator)
nrow(denominator_gold[exclude==0])
nrow(denominator_aurum)
nrow(denominator_gold[exclude==0])+nrow(denominator_aurum)
nrow(denominator)
denominator[is.na(gold_db), gold_db:= 0]
denominator[is.na(aurum_db), aurum_db:= 0]
#rm(denominator_gold, denominator_aurum, aurum_source_main, aurum_source_imd, aurum_source_ons, gold_source_main, gold_source_imd, gold_source_ons)

fwrite(denominator, file.path(PATH_W, "denominator_first_release.txt.gz"))

```

## 1.4 Denominator characteristics
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# Included in the study were men and women with records labelled as â€˜acceptable', approved for HES and ONS linkage, and registered with their general practice for at least 12 months during the study period (01/01/ 1998 to 30/06/2019). 
#denominator = fread(file.path(PATH_W, "denominator_first_release.txt.gz"))
format(nrow(denominator), big.mark="'")  # number of records in table
#  22'441'096
colnames(denominator)

# Check only patients with HES, ONS and SES linkage and ACCEPTable patients are included
format(nrow(denominator[hes_e ==1 & death_e==1 & lsoa_e==1 &  accept==1]), big.mark="'")  
denominator
#  22'441'096

# Check patients registered with their general practice for at least 12 months during the study period (01/01/ 1998 to 30/06/2019). 
summary(denominator$reg_time)
format(nrow(denominator[as.numeric(reg_time)>364]), big.mark="'")
denominator[as.numeric(reg_time)<364]
#  21'622'062 = total number of patients included in the study
#22'441'096-21'622'062 = 819'034
```


## 2. EVENTS of INTEREST

## 2.1 Diagnoses in CPRD GOLD

### Diagnoses in CPRD GOLD - Primary Care
```{r, eval=TRUE, warning=FALSE, message=FALSE}
setwd(file.path(PATH_D2, "GOLD/Data/Primary_Care/Clinical"))
#gold_diagnoses_primary_care= fread(file.path(PATH_D2,"/GOLD/Data/Primary_Care/Clinical/19_156_Extract_Clinical_001.txt.gz"), header = T, sep="\t")
#subset(gold_diagnoses_primary_care, medcode %in% gold_codes_table$medcode_gold)
gold_diagnoses_primary_care = rbindlist( lapply(list.files(), function(x) {subset(fread(x), medcode %in% gold_codes_table$medcode_gold)} ))

format(nrow(gold_diagnoses_primary_care), big.mark="'")  # Check total number of events
gold_diagnoses_primary_care[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] # Set date format
nrow(gold_diagnoses_primary_care[is.na(eventdate),]) # Check number of corrupt eventdates
gold_diagnoses_primary_care=gold_diagnoses_primary_care[!is.na(eventdate),] # Exclude events with corrupt date
nrow(gold_diagnoses_primary_care)
gold_diagnoses_primary_care = gold_diagnoses_primary_care[duplicated(gold_diagnoses_primary_care)==F,] # Exclude duplicates
nrow(gold_diagnoses_primary_care)
gold_diagnoses_primary_care[,database := "CPRD GOLD"] 
gold_diagnoses_primary_care[,codetype := "gold"] 
head(gold_diagnoses_primary_care)

#Merge with code dictionary
gold_diagnoses_primary_care_dict = merge(gold_diagnoses_primary_care[,.(patid, eventdate, medcode, database, codetype)], gold_codes_table[,.(medcode_gold, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "medcode", by.y = "medcode_gold", all.x=T, allow.cartesian=TRUE)
setnames(gold_diagnoses_primary_care_dict, old=c("medcode", "unique_ID"), new =c("diag_code", "diag_code_unique_ID")) # rename to diag_code
nrow(gold_diagnoses_primary_care)
nrow(gold_diagnoses_primary_care_dict)
nrow(gold_diagnoses_primary_care_dict[is.na(disease)])
levels(as.factor(gold_diagnoses_primary_care_dict[is.na(disease)]$medcode)) # Codes checked (these are codes that have been excluded from final analyses) 

# check which codes remain invalid
gold_codes_to_be_double_checked_for_inclusion = gold_diagnoses_primary_care_dict[is.na(disease)]
gold_codes_to_be_double_checked_for_inclusion[, count_na:= .N, by = c("diag_code")]
gold_codes_to_be_double_checked_for_inclusion = unique(gold_codes_to_be_double_checked_for_inclusion[,.(diag_code, count_na)])
gold_codes_to_be_double_checked_for_inclusion = merge(gold_codes_to_be_double_checked_for_inclusion, diag_codes_table_inc_0[codetype == "gold",.(description, disease, disease_category, unique_ID, medcode_gold, codetype, include)], by.x = "diag_code", by.y = "medcode_gold", all.x = TRUE) # merge with full original dictionary to retrieve descriptions
gold_codes_to_be_double_checked_for_inclusion = gold_codes_to_be_double_checked_for_inclusion[order(-count_na)]
gold_codes_to_be_double_checked_for_inclusion

# exclude events that refer to codes that are not part of final set of codes
head(gold_diagnoses_primary_care_dict[is.na(disease)])
gold_diagnoses_primary_care_dict = gold_diagnoses_primary_care_dict[!is.na(disease)] # exclude events that refer to codes that are not part of final set of codes
format(nrow(gold_diagnoses_primary_care_dict), big.mark="'")  # number of records in table
head(gold_diagnoses_primary_care_dict)
```

### Diagnoses in CPRD GOLD - HES APC
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# HES APC ICD - hospitalisations
gold_diagnoses_HES_APC_ICD= fread(file.path(PATH_D2,"/GOLD/Data/Linked_Data/HES_Diagnoses_by_hosp/hes_diagnosis_hosp_19_156A_DM.txt.gz"), header = T, sep="\t")
head(gold_diagnoses_HES_APC_ICD)
nrow(gold_diagnoses_HES_APC_ICD)
colnames(gold_diagnoses_HES_APC_ICD)
gold_diagnoses_HES_APC_ICD[as.numeric(icd)>0] # double-check if icd-9 codes were used (icd-9 codes are numeric and should not have been used here)

gold_diagnoses_HES_APC_ICD[,database := "HES APC GOLD"] 
setnames(gold_diagnoses_HES_APC_ICD, old=c("discharged", "icd", "icdx"), new =c("eventdate", "ICD_main", "ICD_modifier")) # date of diagnosis = date of admission 
gold_diagnoses_HES_APC_ICD[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(gold_diagnoses_HES_APC_ICD[is.na(eventdate),]) # double check number of corrupt eventdates
gold_diagnoses_HES_APC_ICD[is.na(eventdate), eventdate:= as.Date(admidate, format="%d/%m/%Y")]# if discharge date is missing, then use epiend date
#gold_diagnoses_HES_APC_ICD[is.na(eventdate), eventdate:= as.Date(epistart, format="%d/%m/%Y")]# if discharge date is missing, then use epistart date
nrow(gold_diagnoses_HES_APC_ICD[is.na(eventdate),]) # double check number of corrupt eventdates
gold_diagnoses_HES_APC_ICD = gold_diagnoses_HES_APC_ICD[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(gold_diagnoses_HES_APC_ICD)
#nrow(gold_diagnoses_HES_APC_ICD[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
gold_diagnoses_HES_APC_ICD = gold_diagnoses_HES_APC_ICD[duplicated(gold_diagnoses_HES_APC_ICD)==F,] # Exclude duplicates
nrow(gold_diagnoses_HES_APC_ICD)
gold_diagnoses_HES_APC_ICD[,codetype := "icd"] 
#gold_diagnoses_HES_APC[is.empty(ICD_main)&is.empty(ICD_modifier)]$codetype = "opcs"
gold_diagnoses_HES_APC_ICD[ICD_modifier %in% c("-","--","~","-~", "A", "D", "d", "Z", "-A","-D", "X", "E", "+", "*", ",", "!", "G", ".", "H", "F", "J", "K", "R", "N", "DN", "C", "I", "DH", "DR", "H3", "+L", "DG", "a", "M", "#", "~Y", "S", "0D", "2D", "2~", "9~","9D")]$ICD_modifier = ""  # Exclude unhelpful modifiers
gold_diagnoses_HES_APC_ICD[,ICD := paste(ICD_main, ICD_modifier, sep="")] # concatenate ICD codes and modifiers as one single code
gold_diagnoses_HES_APC_ICD = unique(gold_diagnoses_HES_APC_ICD[,.(patid, eventdate, ICD, database, codetype)]) # Exclude duplicates
nrow(gold_diagnoses_HES_APC_ICD)

# HES APC OPCS
gold_diagnoses_HES_APC_OPCS= fread(file.path(PATH_D2,"/GOLD/Data/Linked_Data/HES_Procedures/hes_procedures_epi_19_156A_DM.txt.gz"), header = T, sep="\t")
head(gold_diagnoses_HES_APC_OPCS)
nrow(gold_diagnoses_HES_APC_OPCS)
colnames(gold_diagnoses_HES_APC_OPCS)

gold_diagnoses_HES_APC_OPCS[,database := "HES APC GOLD"] 
setnames(gold_diagnoses_HES_APC_OPCS, old=c("discharged"), new =c("eventdate")) # date of diagnosis = date of admission 
gold_diagnoses_HES_APC_OPCS[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(gold_diagnoses_HES_APC_OPCS[is.na(eventdate),]) # double check number of corrupt eventdates
gold_diagnoses_HES_APC_OPCS[is.na(eventdate), eventdate:= as.Date(epiend, format="%d/%m/%Y")]# if discharge date is missing, then use epiend date
gold_diagnoses_HES_APC_OPCS[is.na(eventdate), eventdate:= as.Date(epistart, format="%d/%m/%Y")]# if discharge date is missing, then use epistart date
nrow(gold_diagnoses_HES_APC_OPCS[is.na(eventdate),]) # double check number of corrupt eventdates
gold_diagnoses_HES_APC_OPCS = gold_diagnoses_HES_APC_OPCS[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(gold_diagnoses_HES_APC_OPCS)
#nrow(gold_diagnoses_HES_APC_OPCS[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
gold_diagnoses_HES_APC_OPCS = gold_diagnoses_HES_APC_OPCS[duplicated(gold_diagnoses_HES_APC_OPCS)==F,] # Exclude duplicates
nrow(gold_diagnoses_HES_APC_OPCS)
gold_diagnoses_HES_APC_OPCS[,codetype := "opcs"] 
gold_diagnoses_HES_APC_OPCS = unique(gold_diagnoses_HES_APC_OPCS[,.(patid, eventdate, opcs, database, codetype)]) # Exclude duplicates
nrow(gold_diagnoses_HES_APC_OPCS)


#ICD table - Merge with code dictionary
#icd_codes_table
gold_diagnoses_HES_APC_ICD_dict = merge(gold_diagnoses_HES_APC_ICD, icd_codes_table[,.(icd_code, alt_icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "ICD", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
setnames(gold_diagnoses_HES_APC_ICD_dict, old=c("ICD", "unique_ID"), new =c("diag_code", "diag_code_unique_ID")) # rename columns
nrow(gold_diagnoses_HES_APC_ICD)
nrow(gold_diagnoses_HES_APC_ICD_dict)
nrow(gold_diagnoses_HES_APC_ICD_dict[is.na(disease)])
levels(as.factor(gold_diagnoses_HES_APC_ICD_dict[is.na(disease)]$ICD)) # Codes checked (these are codes that have been excluded from final analyses) 
nrow(gold_diagnoses_HES_APC_ICD_dict)
head(gold_diagnoses_HES_APC_ICD_dict)

# for codes that do not match, try to match with removing last character
gold_diagnoses_HES_APC_ICD_dict_na = gold_diagnoses_HES_APC_ICD_dict[is.na(disease)]
nrow(gold_diagnoses_HES_APC_ICD_dict_na)
#gold_diagnoses_HES_APC_ICD_dict_na[,orig_diag_code := diag_code]
gold_diagnoses_HES_APC_ICD_dict_na[,short_diag_code := substr(diag_code, 1, nchar(diag_code)-1)]
#gold_diagnoses_HES_APC_ICD_dict[is.na(disease), diag_code:= mod_diag_code]
gold_diagnoses_HES_APC_ICD_dict_na = merge(unique(gold_diagnoses_HES_APC_ICD_dict_na[,.(patid, eventdate, diag_code, short_diag_code, database, codetype)]), icd_codes_table[,.(icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "short_diag_code", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
head(gold_diagnoses_HES_APC_ICD_dict_na[!is.na(disease)])
gold_diagnoses_HES_APC_ICD_dict_na[,diag_code_orig:=diag_code]
gold_diagnoses_HES_APC_ICD_dict_na[,diag_code:=short_diag_code]
gold_diagnoses_HES_APC_ICD_dict_na[,diag_code_unique_ID:=unique_ID]
nrow(gold_diagnoses_HES_APC_ICD_dict_na)
nrow(gold_diagnoses_HES_APC_ICD_dict_na[is.na(disease)])
gold_diagnoses_HES_APC_ICD_dict_na[is.na(disease)]

# check which codes remain invalid
icd_codes_to_be_double_checked_for_inclusion_gold = gold_diagnoses_HES_APC_ICD_dict_na[is.na(disease)]
icd_codes_to_be_double_checked_for_inclusion_gold[, count_na:= .N, by = c("diag_code")]
icd_codes_to_be_double_checked_for_inclusion_gold = unique(icd_codes_to_be_double_checked_for_inclusion_gold[,.(diag_code, short_diag_code, count_na)])
icd_codes_to_be_double_checked_for_inclusion_gold = merge(icd_codes_to_be_double_checked_for_inclusion_gold, diag_codes_table_inc_0[codetype == "icd",.(description, disease, disease_category, unique_ID, icd_code,codetype, include)], by.x = "diag_code", by.y = "icd_code", all.x = TRUE) # merge with full original dictionary to retrieve descriptions
icd_codes_to_be_double_checked_for_inclusion_gold = icd_codes_to_be_double_checked_for_inclusion_gold[order(-count_na)]
icd_codes_to_be_double_checked_for_inclusion_gold

# exclude events that refer to codes that are not part of final set of codes
gold_diagnoses_HES_APC_ICD_dict_final = rbind(gold_diagnoses_HES_APC_ICD_dict[!is.na(disease)], gold_diagnoses_HES_APC_ICD_dict_na[!is.na(disease)], fill = TRUE)
nrow(gold_diagnoses_HES_APC_ICD_dict_final) 
nrow(gold_diagnoses_HES_APC_ICD_dict_final[is.na(eventdate)])
nrow(gold_diagnoses_HES_APC_ICD_dict_final[is.na(disease)])

#OPCS table - Merge with code dictionary
gold_diagnoses_HES_APC_OPCS_dict = merge(gold_diagnoses_HES_APC_OPCS, opcs_codes_table[,.(alt_opcs_code, opcs_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "opcs", by.y = "alt_opcs_code", all.x=T, allow.cartesian=TRUE) # ! no points in OPCS codes!
setnames(gold_diagnoses_HES_APC_OPCS_dict, old=c("opcs", "opcs_code", "unique_ID"), new =c("alt_code", "diag_code", "diag_code_unique_ID" )) # rename columns
nrow(gold_diagnoses_HES_APC_OPCS)
nrow(gold_diagnoses_HES_APC_OPCS_dict)
nrow(gold_diagnoses_HES_APC_OPCS_dict[is.na(disease)])
levels(as.factor(gold_diagnoses_HES_APC_OPCS_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses) 
gold_diagnoses_HES_APC_OPCS_dict = gold_diagnoses_HES_APC_OPCS_dict[!is.na(disease)]
nrow(gold_diagnoses_HES_APC_OPCS_dict)

# RBind ICD and OPCS tables
gold_diagnoses_HES_APC_dict = rbind(gold_diagnoses_HES_APC_ICD_dict_final,gold_diagnoses_HES_APC_OPCS_dict, fill=TRUE )
format(nrow(gold_diagnoses_HES_APC_dict), big.mark="'") 
```

### Diagnoses in CPRD GOLD - HES OP
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# HES OP ICD
gold_diagnoses_HES_OP_ICD= fread(file.path(PATH_D,"/CPRD_GOLD/Event_of_interest/GOLD_HESOP_ICD_interim.txt.gz"), header = T, sep="\t")
gold_diagnoses_HES_OP_ICD_E05= fread(file.path(PATH_D,"/Extra_E_Chapter/Event_of_interest/GOLD_HESOP_ICD_interim_extra.txt.gz"), header = T, sep="\t") # additional E05 events
gold_diagnoses_HES_OP_ICD = rbind(gold_diagnoses_HES_OP_ICD, gold_diagnoses_HES_OP_ICD_E05)

nrow(gold_diagnoses_HES_OP_ICD)
gold_diagnoses_HES_OP_ICD[,database := "HES OP GOLD"] 
setnames(gold_diagnoses_HES_OP_ICD, old=c("apptdate"), new =c("eventdate")) # date of diagnosis = date of appointment 
gold_diagnoses_HES_OP_ICD[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(gold_diagnoses_HES_OP_ICD[is.na(eventdate),]) # double check number of corrupt eventdates
gold_diagnoses_HES_OP_ICD = gold_diagnoses_HES_OP_ICD[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(gold_diagnoses_HES_OP_ICD)
#nrow(gold_diagnoses_HES_OP_ICD[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
gold_diagnoses_HES_OP_ICD = gold_diagnoses_HES_OP_ICD[duplicated(gold_diagnoses_HES_OP_ICD)==F,] # Exclude duplicates
nrow(gold_diagnoses_HES_OP_ICD)

gold_diagnoses_HES_OP_ICD[,codetype := "icd"] 
head(gold_diagnoses_HES_OP_ICD)

# HES OP OPCS
gold_diagnoses_HES_OP_OPCS= fread(file.path(PATH_D,"/CPRD_GOLD/Event_of_interest/GOLD_HESOP_OPCS_interim.txt.gz"), header = T, sep="\t")
nrow(gold_diagnoses_HES_OP_OPCS)
gold_diagnoses_HES_OP_OPCS[,database := "HES OP GOLD"] 
setnames(gold_diagnoses_HES_OP_OPCS, old=c("apptdate"), new =c("eventdate")) # date of diagnosis = date of appointment 
gold_diagnoses_HES_OP_OPCS[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(gold_diagnoses_HES_OP_OPCS[is.na(eventdate),]) # double check number of corrupt eventdates
gold_diagnoses_HES_OP_OPCS = gold_diagnoses_HES_OP_OPCS[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(gold_diagnoses_HES_OP_OPCS)
#nrow(gold_diagnoses_HES_OP_OPCS[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
gold_diagnoses_HES_OP_OPCS = gold_diagnoses_HES_OP_OPCS[duplicated(gold_diagnoses_HES_OP_OPCS)==F,] # Exclude duplicates
nrow(gold_diagnoses_HES_OP_OPCS)
gold_diagnoses_HES_OP_OPCS[,codetype := "opcs"] 

#ICD table - Merge with code dictionary
gold_diagnoses_HES_OP_ICD_dict = merge(gold_diagnoses_HES_OP_ICD[,.(patid, eventdate, ICD, database, codetype)], icd_codes_table[,.(icd_code, alt_icd_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "ICD", by.y = "alt_icd_code", all.x=T, allow.cartesian=TRUE)  # ! no points in OP codes!
head(gold_diagnoses_HES_OP_ICD_dict)
setnames(gold_diagnoses_HES_OP_ICD_dict, old=c("icd_code",  "ICD", "unique_ID"), new =c("diag_code","alt_code", "diag_code_unique_ID")) # rename columns
nrow(gold_diagnoses_HES_OP_ICD)
nrow(gold_diagnoses_HES_OP_ICD_dict)
nrow(gold_diagnoses_HES_OP_ICD_dict[is.na(disease)])
levels(as.factor(gold_diagnoses_HES_OP_ICD_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses)
gold_diagnoses_HES_OP_ICD_dict = gold_diagnoses_HES_OP_ICD_dict[!is.na(disease)]
nrow(gold_diagnoses_HES_OP_ICD_dict)

#OPCS table - Merge with code dictionary
gold_diagnoses_HES_OP_OPCS_dict = merge(gold_diagnoses_HES_OP_OPCS[,.(patid, eventdate, OPCS, database, codetype)], opcs_codes_table[,.(alt_opcs_code, opcs_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "OPCS", by.y = "alt_opcs_code", all.x=T, allow.cartesian=TRUE) # ! no points in OPCS codes!
head(gold_diagnoses_HES_OP_OPCS_dict)
setnames(gold_diagnoses_HES_OP_OPCS_dict, old=c("OPCS", "opcs_code", "unique_ID"), new =c("alt_code", "diag_code", "diag_code_unique_ID")) # rename columns
nrow(gold_diagnoses_HES_OP_OPCS)
nrow(gold_diagnoses_HES_OP_OPCS_dict)
nrow(gold_diagnoses_HES_OP_OPCS_dict[is.na(disease)])
levels(as.factor(gold_diagnoses_HES_OP_OPCS_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses)

gold_diagnoses_HES_OP_OPCS_dict = gold_diagnoses_HES_OP_OPCS_dict[!is.na(disease)]
nrow(gold_diagnoses_HES_OP_OPCS_dict)

# RBind ICD and OPCS tables
gold_diagnoses_HES_OP_dict = rbind(gold_diagnoses_HES_OP_ICD_dict,gold_diagnoses_HES_OP_OPCS_dict, fill=TRUE )
nrow(gold_diagnoses_HES_OP_dict)


# !! NEW on 15 Sep 2021 - NEW GOLD patids
gold_diagnoses_HES_OP_dict[,patidold:= patid]
# change pracids
gold_diagnoses_HES_OP_dict[,pracid := as.character(substr(patid, floor(log10(patid))-1, floor(log10(patid))+1 ))] # pracid = last three digits of patidold
gold_diagnoses_HES_OP_dict[,pracid:= paste("10",pracid,sep="")] # new pracid = "10" + last three digits of patidold 
# change patids
gold_diagnoses_HES_OP_dict[,patid := as.character(substr(patidold, 1, floor(log10(patidold))-2 ))] # patid all digits up to the last three (which are the pracid)
gold_diagnoses_HES_OP_dict[,patid:= as.numeric(paste(patid,pracid,sep=""))] # new patid = old patid (up to the last three digits) + new pracid 
head(gold_diagnoses_HES_OP_dict)
```

### Diagnoses in CPRD GOLD - ONS Death 
```{r, eval=TRUE, warning=FALSE, message=FALSE}
death_gold= fread(file.path(PATH_D2,"/Gold/Data/Linked_Data/ONS/death_patient_19_156A_DM.txt.gz"), header = T, sep="\t")
format(nrow(death_gold), big.mark="'")  # number of records in table
class(death_gold$patid)
colnames(death_gold)
death_gold[,dod:=as.Date(dod, format="%d/%m/%Y")] #set date format
death_gold[,dod_partial:=as.Date(dod_partial, format="%d/%m/%Y")] #set date format
nrow(death_gold[is.na(dod)]) # check how many dod are missing
nrow(death_gold[is.na(dod) & !is.na(dod_partial)]) # check dod_partial can be used for those with missing dod
death_gold = death_gold[!is.na(dod)] # exclude records with missing death date
setnames(death_gold, old=c("cause", "cause1", "cause2", "cause3", "cause4", "cause5", "cause6", "cause7", "cause8", "cause9", "cause10", "cause11", "cause12", "cause13", "cause14", "cause15"), new =c("death_cause_first", "death_cause2", "death_cause3", "death_cause4", "death_cause5", "death_cause6", "death_cause7", "death_cause8", "death_cause9", "death_cause10", "death_cause11", "death_cause12", "death_cause13", "death_cause14", "death_cause15", "death_cause16"))
death_gold = death_gold[,.(patid, dod, death_cause_first, death_cause2, death_cause3, death_cause4, death_cause5, death_cause6, death_cause7, death_cause8, death_cause9, death_cause10, death_cause11, death_cause12, death_cause13, death_cause14, death_cause15, death_cause16)] # select relevant columns
head(death_gold)
format(nrow(death_gold), big.mark="'")  # number of records in table
format(length(unique(death_gold$patid)), big.mark="'")  # number of unique patient IDs in table

death_gold_melted = data.table::melt(death_gold, measure.vars = c("death_cause_first", "death_cause2", "death_cause3", "death_cause4", "death_cause5", "death_cause6", "death_cause7", "death_cause8", "death_cause9", "death_cause10", "death_cause11", "death_cause12", "death_cause13", "death_cause14", "death_cause15", "death_cause16"),variable.name = "death_diag_order", value.name = "diag_code") # melt table
#setnames(death_gold_melted, old = "value", new = "diag_code")
head(death_gold_melted)
death_gold_melted = death_gold_melted[!is.na(diag_code)] # exclude empty fields
death_gold_melted = death_gold_melted[!(diag_code == "")] # exclude empty fields
head(death_gold_melted)

format(nrow(death_gold_melted), big.mark="'")  # number of records in table
format(length(unique(death_gold_melted$patid)), big.mark="'")  # number of unique patient IDs in table

# Select only CVD codes
death_gold_melted_cvd = death_gold_melted[diag_code %in% icd_9_10_codes_table[disease_category == "cardiovascular"]$icd_code]
format(nrow(death_gold_melted_cvd), big.mark="'")  # number of records in table
format(length(unique(death_gold_melted_cvd$patid)), big.mark="'")  # number of unique patient IDs in table

# Merge with code dictionary
death_gold_melted_cvd2 = merge(death_gold_melted_cvd, icd_9_10_codes_table[disease_category == "cardiovascular",.(alt_icd_code, icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "diag_code", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
levels(as.factor(fsetdiff(death_gold_melted_cvd[,.(diag_code)], death_gold_melted_cvd2[,.(diag_code)], all = TRUE)))
levels(as.factor(fsetdiff(death_gold_melted_cvd2[,.(diag_code)], death_gold_melted_cvd[,.(diag_code)], all = TRUE)))
icd_9_10_codes_table[icd_code %in% c("I26.0", "I26.9", "I81", "I82.3")] # these codes refer to 2 or more CVD
death_gold_melted_cvd = death_gold_melted_cvd2
setnames(death_gold_melted_cvd, old=c("alt_icd_code", "unique_ID"), new =c("alt_code", "diag_code_unique_ID")) # rename columns

# Check that all codes have been matched with a disease
nrow(death_gold_melted_cvd[is.na(disease)])

# Define code type and database
death_gold_melted_cvd[,database := "ONS GOLD"] 
death_gold_melted_cvd[,codetype := "icd"] 
levels(as.factor(death_gold_melted_cvd$death_diag_order))

# Rename dod as eventdate 
setnames(death_gold_melted_cvd, old=c("dod"), new =c("eventdate")) # rename columns
```

### Diagnoses in CPRD GOLD - HES PRIMARY (for sensitivity analyses)
```{r, eval=TRUE, warning=FALSE, message=FALSE}
hes_gold_primary= fread(file.path(PATH_D2,"/Gold/Data/Linked_Data/HES_Primary/hes_primary_diag_hosp_19_156A_DM.txt.gz"), header = T, sep="\t")
class(hes_gold_primary$patid)
head(hes_gold_primary)
hes_gold_primary[,admidate:=as.Date(admidate, format="%d/%m/%Y")] #set date format
hes_gold_primary[,discharged:=as.Date(discharged, format="%d/%m/%Y")] #set date format
format(nrow(hes_gold_primary), big.mark="'")  # number of records in table
format(nrow(hes_gold_primary[icdx != ""]), big.mark="'")  
hes_gold_primary[icdx %in% c("-","--","~","-~", "A", "D", "d", "Z", "-A","-D", "X", "E", "+", "*", ",", "!", "G", ".", "H", "F", "J", "K", "R", "N", "DN", "C", "I", "DH", "DR", "H3", "+L", "DG", "a", "M", "#", "~Y", "S", "0D", "2D", "2~", "9~","9D", " ", "0~")]$icdx = ""  # Exclude unhelpful modifiers
hes_gold_primary[icd_primary %in% c("I70.1", "I70.8", "I70.9",  "I48.0", "I48.1", "I48.9") & icdx %in% c("0", "1", "9")]$icdx = ""  # Exclude unhelpful modifiers

format(nrow(hes_gold_primary[icdx != ""]), big.mark="'") 
hes_gold_primary[,ICD_5:= paste(icd_primary, icdx, sep = "")] # concatenate ICD codes and modifiers as one single code
#icd_codes_table[disease_category == "cardiovascular"]
hes_gold_primary1 = subset(hes_gold_primary, icd_primary %in% icd_codes_table[disease_category == "cardiovascular"]$icd_code)
hes_gold_primary2 = subset(hes_gold_primary, ICD_5 %in% icd_codes_table[disease_category == "cardiovascular"]$icd_code)
nrow(hes_gold_primary1)
nrow(hes_gold_primary2)
nrow(hes_gold_primary1)-nrow(hes_gold_primary2)
fsetdiff(hes_gold_primary1, hes_gold_primary2, all = TRUE)
fsetdiff(hes_gold_primary2, hes_gold_primary1, all = TRUE)
hes_gold_primary = hes_gold_primary1
nrow(hes_gold_primary)

#comorb_gold_hes[,database := "HES APC gold"] 
#comorb_gold_hes[,codetype := "ICD"] 
setnames(hes_gold_primary, old=c("icd_primary", "icdx"), new =c("diag_code", "icd_modifier")) 
nrow(hes_gold_primary[is.na(discharged),]) # double check number of corrupt eventdates
hes_gold_primary[, eventdate:= discharged ] # date of diagnosis = date of discharge 
hes_gold_primary[is.na(eventdate), eventdate:= admidate ] # where discharge date is missing, use admission date
nrow(hes_gold_primary[is.na(eventdate),]) # double check number of corrupt eventdates
hes_gold_primary = hes_gold_primary[!is.na(eventdate)] # exclude events where both admission and discharge dates are missing
nrow(hes_gold_primary[is.na(eventdate)])

hes_gold_primary = hes_gold_primary[duplicated(hes_gold_primary)==F,] # Exclude duplicates
format(nrow(hes_gold_primary), big.mark="'") 
#comorb_gold_hes[,diag_code_unique_ID := paste("I",diag_code, sep="_")] ## Define unique_ID
colnames(hes_gold_primary)
hes_gold_primary = hes_gold_primary[,.(patid, eventdate, diag_code, admidate, discharged, spno, ICD_5, icd_modifier)]

# Merge with code dictionary
hes_gold_primary2 = merge(hes_gold_primary, icd_codes_table[disease_category == "cardiovascular",.(alt_icd_code, icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "diag_code", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
levels(as.factor(fsetdiff(hes_gold_primary[,.(diag_code)], hes_gold_primary2[,.(diag_code)], all = TRUE)))
levels(as.factor(fsetdiff(hes_gold_primary2[,.(diag_code)], hes_gold_primary[,.(diag_code)], all = TRUE)))
icd_codes_table[icd_code %in% c("I26.0", "I26.9", "I81", "I82.3")]
hes_gold_primary = hes_gold_primary2
setnames(hes_gold_primary, old=c("alt_icd_code", "unique_ID"), new =c("alt_code", "diag_code_unique_ID")) # rename columns
colnames(hes_gold_primary)

# Check that all codes have been matched with a disease
nrow(hes_gold_primary[is.na(disease)])

# Define code type and database
hes_gold_primary[,database := "HES GOLD PRIMARY"] 
hes_gold_primary[,codetype := "icd"] 

# Add pracid
format(nrow(hes_gold_primary), big.mark="'")  # number of records in table
hes_gold_primary[,patid:=as.integer64(patid)]
hes_gold_primary = merge(hes_gold_primary, denominator_gold[,.(patid, pracid)], by = "patid", all.x = TRUE)
nrow(hes_gold_primary[is.na(pracid)]) # check that no pracids are missing

colnames(hes_gold_primary)
format(nrow(hes_gold_primary), big.mark="'")  # number of records in table
format(length(unique(hes_gold_primary$patid)), big.mark="'")  # number of unique patient IDs in table
```

### Combine all diagnoses in CPRD GOLD - Primary care, HES APC and HES OP, 
```{r combine_gold, eval=TRUE, warning=FALSE, message=FALSE}
include_cvd_death
if (include_cvd_death == "yes") {gold_diagnoses_all = rbind( gold_diagnoses_primary_care_dict, gold_diagnoses_HES_APC_dict,gold_diagnoses_HES_OP_dict, death_gold_melted_cvd, fill=TRUE ) }  else { gold_diagnoses_all = rbind( gold_diagnoses_primary_care_dict, gold_diagnoses_HES_APC_dict,gold_diagnoses_HES_OP_dict, fill=TRUE )} # if include_cvd_death == "yes" then include records of CVD death, else do not includes records of CVD death

format(nrow(gold_diagnoses_all), big.mark="'") 
head(gold_diagnoses_all)

# Check that for all diag_codes include == 1
levels(as.factor(gold_diagnoses_all$include))

# check patids
summary(gold_diagnoses_all$patid)
class(gold_diagnoses_all$patid)
nrow(gold_diagnoses_all[patid == 1002210231]) # new patid, should be in the table
nrow(gold_diagnoses_all[patid == 10231]) # old patid, should not appear in the table
nrow(gold_diagnoses_all[patid == 1000010010]) # new patid, should be in the table
nrow(gold_diagnoses_all[patid == 10010]) # old patid, should not appear in the table

summary(denominator_gold$patid)
class(denominator_gold$patid)
denominator_gold[,patid := as.integer64(patid)]
head(denominator_gold)
nrow(denominator_gold[patid == 1002210231]) # new patid, should be in the table
nrow(denominator_gold[patid == 10231]) # old patid, should not appear in the table
nrow(denominator_gold[patid == 1000010010]) # new patid, should be in the table
nrow(denominator_gold[patid == 10010]) # old patid, should not appear in the table
#1000010010	10010	10000010	10	
#1002210231	10231	10022231	231


# Deduplicate patids that are in both aurum and gold (the are marked with exclude ==1 in gold data)
gold_diagnoses_all = merge(gold_diagnoses_all, denominator_gold[,.(patid, exclude)], by = "patid", all.x = TRUE)
nrow(gold_diagnoses_all)
nrow(denominator_gold[is.na(exclude)])
nrow(denominator_gold[exclude == 1])
nrow(gold_diagnoses_all) - nrow(gold_diagnoses_all[exclude == 1]) -nrow(gold_diagnoses_all[exclude == 0]) # check that this is 0
gold_diagnoses_all = gold_diagnoses_all[exclude == 0] ## exclude patids with exclude == 1 - those patients who are both in CPRD gold and aurum
format(nrow(gold_diagnoses_all), big.mark="'") 

# Check eventdates and patid
nrow(gold_diagnoses_all[is.na(eventdate),])
nrow(gold_diagnoses_all[is.na(pracid),])

# define db_patid across gold and aurum
gold_diagnoses_all[,db_patid := paste("G", patid, sep="")] 
```

## Save_0
```{r save_0, eval=TRUE, warning=FALSE, message=FALSE}
#save.image(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_0.RData"))
rm(list=setdiff(ls(), c("gold_diagnoses_all",  "aurum_diagnoses_all", "death_gold_melted_cvd", "death_aurum_melted_cvd", "hes_gold_primary", "hes_aurum_primary", "study_start_date", "study_end_date", "PATH", "PATH_D", "PATH_D2", "PATH_W", "PATH_W_orig", "PATH_L", "gold_codes_table", "aurum_codes_table", "icd_codes_table", "icd_9_10_codes_table", "opcs_codes_table", "all_codes_table", "denominator", "denominator_aurum", "age_group_table", "compute_days", "age_group_fun", "icd_codes_to_be_double_checked_for_inclusion_gold", "diag_codes_table_inc_0", "gold_codes_to_be_double_checked_for_inclusion", "aurum_codes_to_be_double_checked_for_inclusion", "icd_codes_to_be_double_checked_for_inclusion_aurum", "include_cvd_death", "drug_codes", "drug_codes_gold", "drug_codes_aurum", "death_gold", "death_aurum")))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_0.RData"))
#save.image(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_0.RData"))
gc()
```

## 2.2 Diagnoses in CPRD Aurum
### Diagnoses in CPRD Aurum - Primary Care - !! Needs to be updated with the latest "CVD_INCIDENCE_AURUM_OBSERVATION_diagnoses.Rmd" file when diagnostic codes change !!
```{r, eval=TRUE, warning=FALSE, message=FALSE}
aurum_diagnoses_primary_care= fread(file.path(PATH_W,"/observation_aurum_diagnoses.txt.gz"), colClasses=c("patid"="integer64", "medcodeid"="integer64", "obsdate"="Date"))
format(nrow(aurum_diagnoses_primary_care), big.mark="'")  # Check total number of events
head(aurum_diagnoses_primary_care)
setnames(aurum_diagnoses_primary_care, old=c( "obsdate", "medcodeid"), new =c("eventdate", "medcode_aurum")) # rename columns
class(aurum_diagnoses_primary_care$medcode_aurum) # check class is integer64 (CPRD Aurum only)
#aurum_diagnoses_primary_care[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] # Set date format
format(nrow(aurum_diagnoses_primary_care[is.na(eventdate),]), big.mark="'") # Check number of corrupt eventdates
aurum_diagnoses_primary_care=aurum_diagnoses_primary_care[!is.na(eventdate),] # Exclude events with corrupt date
#nrow(aurum_diagnoses_primary_care[rapportools::is.empty(eventdate),]) # Check number of empty eventdates
format(nrow(aurum_diagnoses_primary_care), big.mark="'") 
aurum_diagnoses_primary_care = aurum_diagnoses_primary_care[duplicated(aurum_diagnoses_primary_care)==F,] # Exclude duplicates
format(nrow(aurum_diagnoses_primary_care), big.mark="'") 
aurum_diagnoses_primary_care[,database := "CPRD Aurum"]
aurum_diagnoses_primary_care[,codetype := "aurum"]
head(aurum_diagnoses_primary_care)

#Merge with code dictionary
aurum_diagnoses_primary_care_dict = merge(aurum_diagnoses_primary_care, aurum_codes_table[,!c("database","codetype", "keyword")], by = "medcode_aurum", all.x=T, allow.cartesian=TRUE)
setnames(aurum_diagnoses_primary_care_dict, old=c( "medcode_aurum", "unique_ID"), new =c("diag_code_aurum", "diag_code_unique_ID")) # rename to diag_code
head(aurum_diagnoses_primary_care_dict)
colnames(aurum_diagnoses_primary_care_dict)
nrow(aurum_diagnoses_primary_care)
nrow(aurum_diagnoses_primary_care_dict)
nrow(aurum_diagnoses_primary_care_dict[is.na(disease)])
levels(as.factor(aurum_diagnoses_primary_care_dict[is.na(disease)]$diag_code_aurum)) # Codes checked (these are codes that have been excluded from final analyses) 
levels(as.factor(aurum_diagnoses_primary_care_dict$disease)) # Codes checked (these are codes that have been excluded from final analyses) 

# check which codes remain invalid
aurum_codes_to_be_double_checked_for_inclusion = aurum_diagnoses_primary_care_dict[is.na(disease)]
aurum_codes_to_be_double_checked_for_inclusion[, count_na:= .N, by = c("diag_code_aurum")]
aurum_codes_to_be_double_checked_for_inclusion = unique(aurum_codes_to_be_double_checked_for_inclusion[,.(diag_code_aurum, count_na)])
aurum_codes_to_be_double_checked_for_inclusion = merge(aurum_codes_to_be_double_checked_for_inclusion, diag_codes_table_inc_0[codetype == "aurum",.(description, disease, disease_category, unique_ID, medcode_aurum,codetype, include)], by.x = "diag_code_aurum", by.y = "medcode_aurum", all.x = TRUE) # merge with full original dictionary to retrieve descriptions
aurum_codes_to_be_double_checked_for_inclusion = aurum_codes_to_be_double_checked_for_inclusion[order(-count_na)]
aurum_codes_to_be_double_checked_for_inclusion

aurum_diagnoses_primary_care_dict = aurum_diagnoses_primary_care_dict[!is.na(disease)]
nrow(aurum_diagnoses_primary_care_dict)
```

### Diagnoses in CPRD Aurum - HES APC
```{r aurum_apc, eval=TRUE, warning=FALSE, message=FALSE}
aurum_diagnoses_HES_APC_ICD= fread(file.path(PATH_D2,"/Aurum/Data/Linked_Data/HES_Diagnoses_by_hosp/hes_diagnosis_hosp_19_156A_DM.txt.gz"), header = T, sep="\t")
head(aurum_diagnoses_HES_APC_ICD)
nrow(aurum_diagnoses_HES_APC_ICD)
colnames(aurum_diagnoses_HES_APC_ICD)
aurum_diagnoses_HES_APC_ICD[as.numeric(ICD)>0] # double-check if icd-9 codes were used (icd-9 codes are numeric and should not have been used here)

aurum_diagnoses_HES_APC_ICD[,database := "HES APC Aurum"]
setnames(aurum_diagnoses_HES_APC_ICD, old=c("discharged", "ICD", "ICDx"), new =c("eventdate", "ICD_main", "ICD_modifier")) # date of diagnosis = date of admission 
aurum_diagnoses_HES_APC_ICD[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(aurum_diagnoses_HES_APC_ICD[is.na(eventdate),]) # double check number of corrupt eventdates
aurum_diagnoses_HES_APC_ICD[is.na(eventdate), eventdate:= as.Date(admidate, format="%d/%m/%Y")] # if discharge date is missing, then use epiend date
#aurum_diagnoses_HES_APC_ICD[is.na(eventdate), eventdate:= as.Date(epistart, format="%d/%m/%Y")] # if discharge date is missing, then use epistart date
nrow(aurum_diagnoses_HES_APC_ICD[is.na(eventdate),]) # double check number of corrupt eventdates
#aurum_diagnoses_HES_APC_ICD[is.na(eventdate),]
aurum_diagnoses_HES_APC_ICD = aurum_diagnoses_HES_APC_ICD[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(aurum_diagnoses_HES_APC_ICD)
#nrow(aurum_diagnoses_HES_APC_ICD[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
aurum_diagnoses_HES_APC_ICD = aurum_diagnoses_HES_APC_ICD[duplicated(aurum_diagnoses_HES_APC_ICD)==F,] # Exclude duplicates
nrow(aurum_diagnoses_HES_APC_ICD)
aurum_diagnoses_HES_APC_ICD[,codetype := "icd"] 
aurum_diagnoses_HES_APC_ICD[ICD_modifier %in% c("-","--","~","-~", "A", "D", "d", "Z", "-A","-D", "X", "E", "+", "*", ",", "!", "G", ".", "H", "F", "J", "K", "R", "N", "DN", "C", "I", "DH", "DR", "H3", "+L", "DG", "a", "M", "#", "~Y", "S", "0D", "2D", "2~", "9~","9D")]$ICD_modifier = ""  # Exclude unhelpful modifiers
aurum_diagnoses_HES_APC_ICD$ICD = paste(aurum_diagnoses_HES_APC_ICD$ICD_main, aurum_diagnoses_HES_APC_ICD$ICD_modifier, sep="") # concatenate ICD codes and modifiers as one single code
aurum_diagnoses_HES_APC_ICD = unique(aurum_diagnoses_HES_APC_ICD[,.(patid, eventdate, ICD, database, codetype)]) 
nrow(aurum_diagnoses_HES_APC_ICD)
#nrow(aurum_diagnoses_HES_APC_ICD[is.na(eventdate)])
#nrow(aurum_diagnoses_HES_APC_ICD[is.na(pracid)])

# HES APC OPCS
aurum_diagnoses_HES_APC_OPCS= fread(file.path(PATH_D,"/CPRD_Aurum/Event_of_interest/Aurum_HESAPC_OPCS_interim.txt.gz"), header = T, sep="\t")
nrow(aurum_diagnoses_HES_APC_OPCS)
aurum_diagnoses_HES_APC_OPCS[,database := "HES APC Aurum"] 

setnames(aurum_diagnoses_HES_APC_OPCS, old=c("discharged"), new =c("eventdate")) # date of diagnosis = date of admission 
aurum_diagnoses_HES_APC_OPCS[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(aurum_diagnoses_HES_APC_OPCS[is.na(eventdate),]) # double check number of corrupt eventdates
aurum_diagnoses_HES_APC_OPCS[is.na(eventdate), eventdate:= as.Date(epiend, format="%d/%m/%Y")] # if discharge date is missing, then use epiend date
aurum_diagnoses_HES_APC_OPCS[is.na(eventdate), eventdate:= as.Date(epistart, format="%d/%m/%Y")] # if discharge date is missing, then use epistart date
nrow(aurum_diagnoses_HES_APC_OPCS[is.na(eventdate),]) # double check number of corrupt eventdates
aurum_diagnoses_HES_APC_OPCS = aurum_diagnoses_HES_APC_OPCS[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(aurum_diagnoses_HES_APC_OPCS)
#nrow(aurum_diagnoses_HES_APC_OPCS[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
aurum_diagnoses_HES_APC_OPCS[,codetype := "opcs"] 
aurum_diagnoses_HES_APC_OPCS = unique(aurum_diagnoses_HES_APC_OPCS[,.(patid, eventdate, OPCS, database, codetype)]) # Exclude duplicates
nrow(aurum_diagnoses_HES_APC_OPCS)

#ICD table - Merge with code dictionary
aurum_diagnoses_HES_APC_ICD_dict = merge(aurum_diagnoses_HES_APC_ICD, icd_codes_table[,.(alt_icd_code, icd_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "ICD", by.y = "icd_code", all=T, allow.cartesian=TRUE)
setnames(aurum_diagnoses_HES_APC_ICD_dict, old=c("ICD",  "alt_icd_code", "unique_ID"), new =c("diag_code","alt_code", "diag_code_unique_ID")) # rename columns
aurum_diagnoses_HES_APC_ICD_dict[,orig_diag_code := diag_code]
nrow(aurum_diagnoses_HES_APC_ICD)
nrow(aurum_diagnoses_HES_APC_ICD_dict)
nrow(aurum_diagnoses_HES_APC_ICD_dict[is.na(disease)])
levels(as.factor(aurum_diagnoses_HES_APC_ICD_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses) 

## CHECK
kable(aurum_diagnoses_HES_APC_ICD_dict[is.na(eventdate) & !is.na(disease)]) # ICD codes for which there have been no match!
aurum_diagnoses_HES_APC_ICD_dict = aurum_diagnoses_HES_APC_ICD_dict[!is.na(eventdate)] # exclude records missing eventdates (here these are ICD codes for which there have been no matches (ICD chapter codes))
nrow(aurum_diagnoses_HES_APC_ICD_dict[is.na(eventdate)]) 

# for codes that do not match, try to match with removing last character
aurum_diagnoses_HES_APC_ICD_dict_na = aurum_diagnoses_HES_APC_ICD_dict[is.na(disease)]
aurum_diagnoses_HES_APC_ICD_dict_na[,short_diag_code := substr(as.character(diag_code), 1, nchar(as.character(diag_code))-1)]
aurum_diagnoses_HES_APC_ICD_dict_na = merge(unique(aurum_diagnoses_HES_APC_ICD_dict_na[,.(patid, eventdate, diag_code, short_diag_code, database, codetype)]), icd_codes_table[,.(icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "short_diag_code", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
head(aurum_diagnoses_HES_APC_ICD_dict_na[!is.na(disease)])
aurum_diagnoses_HES_APC_ICD_dict_na[,diag_code_orig:=diag_code]
aurum_diagnoses_HES_APC_ICD_dict_na[,diag_code:=short_diag_code]
aurum_diagnoses_HES_APC_ICD_dict_na[,diag_code_unique_ID:=unique_ID]
nrow(aurum_diagnoses_HES_APC_ICD_dict_na)
nrow(aurum_diagnoses_HES_APC_ICD_dict_na[is.na(disease)])
aurum_diagnoses_HES_APC_ICD_dict_na[is.na(disease)]

# check which codes remain invalid
icd_codes_to_be_double_checked_for_inclusion_aurum = aurum_diagnoses_HES_APC_ICD_dict_na[is.na(disease)]
icd_codes_to_be_double_checked_for_inclusion_aurum[, count_na:= .N, by = c("diag_code")]
icd_codes_to_be_double_checked_for_inclusion_aurum = unique(icd_codes_to_be_double_checked_for_inclusion_aurum[,.(diag_code, short_diag_code, count_na)])
icd_codes_to_be_double_checked_for_inclusion_aurum = merge(icd_codes_to_be_double_checked_for_inclusion_aurum, diag_codes_table_inc_0[codetype == "icd",.(description, disease, disease_category, unique_ID, icd_code,codetype, include)], by.x = "diag_code", by.y = "icd_code", all.x = TRUE) # merge with full original dictionary to retrieve descriptions
icd_codes_to_be_double_checked_for_inclusion_aurum = icd_codes_to_be_double_checked_for_inclusion_aurum[order(-count_na)]
icd_codes_to_be_double_checked_for_inclusion_aurum

# exclude events that refer to codes that are not part of final set of codes
aurum_diagnoses_HES_APC_ICD_dict_final = rbind(aurum_diagnoses_HES_APC_ICD_dict[!is.na(disease)], aurum_diagnoses_HES_APC_ICD_dict_na[!is.na(disease)], fill = TRUE)
nrow(aurum_diagnoses_HES_APC_ICD_dict_final) 
nrow(aurum_diagnoses_HES_APC_ICD_dict_final[is.na(eventdate)])
nrow(aurum_diagnoses_HES_APC_ICD_dict_final[is.na(disease)])

#OPCS table - Merge with code dictionary
aurum_diagnoses_HES_APC_OPCS_dict = merge(aurum_diagnoses_HES_APC_OPCS[,.(patid, eventdate, OPCS, database, codetype)], opcs_codes_table[,.(alt_opcs_code, opcs_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "OPCS", by.y = "alt_opcs_code", all.x=T, allow.cartesian=TRUE) # ! no points in OPCS codes!
setnames(aurum_diagnoses_HES_APC_OPCS_dict, old=c("OPCS", "opcs_code", "unique_ID"), new =c("alt_code", "diag_code", "diag_code_unique_ID")) # rename columns
nrow(aurum_diagnoses_HES_APC_OPCS)
nrow(aurum_diagnoses_HES_APC_OPCS_dict)
nrow(aurum_diagnoses_HES_APC_OPCS_dict[is.na(disease)])
levels(as.factor(aurum_diagnoses_HES_APC_OPCS_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses) 
aurum_diagnoses_HES_APC_OPCS_dict = aurum_diagnoses_HES_APC_OPCS_dict[!is.na(disease)]
nrow(aurum_diagnoses_HES_APC_OPCS_dict)
nrow(aurum_diagnoses_HES_APC_OPCS_dict[is.na(eventdate)])
nrow(aurum_diagnoses_HES_APC_OPCS_dict[is.na(disease)])

# RBind ICD and OPCS tables
aurum_diagnoses_HES_APC_dict = rbind(aurum_diagnoses_HES_APC_ICD_dict_final,aurum_diagnoses_HES_APC_OPCS_dict, fill=TRUE )
```

### Diagnoses in CPRD Aurum - HES OP
```{r, eval=TRUE, warning=FALSE, message=FALSE}
# HES OP ICD
aurum_diagnoses_HES_OP_ICD= fread(file.path(PATH_D,"/CPRD_Aurum/Event_of_interest/Aurum_HESOP_ICD_interim.txt.gz"), header = T, sep="\t")
aurum_diagnoses_HES_OP_ICD_E05= fread(file.path(PATH_D,"/Extra_E_Chapter/Event_of_interest/Aurum_HESOP_ICD_interim_extra.txt.gz"), header = T, sep="\t") # additional E05 events
nrow(aurum_diagnoses_HES_OP_ICD_E05)
aurum_diagnoses_HES_OP_ICD = rbind(aurum_diagnoses_HES_OP_ICD, aurum_diagnoses_HES_OP_ICD_E05)

nrow(aurum_diagnoses_HES_OP_ICD)
aurum_diagnoses_HES_OP_ICD[,database := "HES OP Aurum"] 
setnames(aurum_diagnoses_HES_OP_ICD, old=c("apptdate"), new =c("eventdate")) # date of diagnosis = date of appointment 
aurum_diagnoses_HES_OP_ICD[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(aurum_diagnoses_HES_OP_ICD[is.na(eventdate),]) # double check number of corrupt eventdates
aurum_diagnoses_HES_OP_ICD = aurum_diagnoses_HES_OP_ICD[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(aurum_diagnoses_HES_OP_ICD)
#nrow(aurum_diagnoses_HES_OP_ICD[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
#aurum_diagnoses_HES_OP_ICD = aurum_diagnoses_HES_OP_ICD[duplicated(aurum_diagnoses_HES_OP_ICD)==F,] # Exclude duplicates
nrow(aurum_diagnoses_HES_OP_ICD)
aurum_diagnoses_HES_OP_ICD[,codetype := "icd"] 
aurum_diagnoses_HES_OP_ICD=aurum_diagnoses_HES_OP_ICD[,.(patid, eventdate, ICD, database, codetype)] # Exclude duplicates
nrow(aurum_diagnoses_HES_OP_ICD)
head(aurum_diagnoses_HES_OP_ICD)

# HES OP OPCS
aurum_diagnoses_HES_OP_OPCS= fread(file.path(PATH_D,"/CPRD_Aurum/Event_of_interest/Aurum_HESOP_OPCS_interim.txt.gz"), header = T, sep="\t")
nrow(aurum_diagnoses_HES_OP_OPCS)
aurum_diagnoses_HES_OP_OPCS[,database := "HES OP Aurum"] 
setnames(aurum_diagnoses_HES_OP_OPCS, old=c("apptdate"), new =c("eventdate")) # date of diagnosis = date of appointment 
aurum_diagnoses_HES_OP_OPCS[,eventdate:=as.Date(eventdate, format="%d/%m/%Y")] #set date format
nrow(aurum_diagnoses_HES_OP_OPCS[is.na(eventdate),]) # double check number of corrupt eventdates
aurum_diagnoses_HES_OP_OPCS = aurum_diagnoses_HES_OP_OPCS[!is.na(eventdate),] # Exclude corrupt eventdates
nrow(aurum_diagnoses_HES_OP_OPCS)
#nrow(aurum_diagnoses_HES_OP_OPCS[rapportools::is.empty(eventdate),]) # double check number of empty eventdates
#aurum_diagnoses_HES_OP_OPCS = aurum_diagnoses_HES_OP_OPCS[duplicated(aurum_diagnoses_HES_OP_OPCS)==F,] # Exclude duplicates
nrow(aurum_diagnoses_HES_OP_OPCS)
aurum_diagnoses_HES_OP_OPCS[,codetype := "opcs"] 
aurum_diagnoses_HES_OP_OPCS=aurum_diagnoses_HES_OP_OPCS[,.(patid, eventdate, OPCS, database, codetype)] # Exclude duplicates
nrow(aurum_diagnoses_HES_OP_OPCS)
head(aurum_diagnoses_HES_OP_OPCS)

#ICD table - Merge with code dictionary
aurum_diagnoses_HES_OP_ICD_dict = merge(aurum_diagnoses_HES_OP_ICD[,.(patid, eventdate, ICD, database, codetype)], icd_codes_table[,.(alt_icd_code, icd_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "ICD", by.y = "alt_icd_code", all.x=T, allow.cartesian=TRUE)  # ! no points in OP codes!
head(aurum_diagnoses_HES_OP_ICD_dict)
setnames(aurum_diagnoses_HES_OP_ICD_dict, old=c("icd_code",  "ICD", "unique_ID"), new =c("diag_code","alt_code", "diag_code_unique_ID")) # rename columns
nrow(aurum_diagnoses_HES_OP_ICD)
nrow(aurum_diagnoses_HES_OP_ICD_dict)
nrow(aurum_diagnoses_HES_OP_ICD_dict[is.na(disease)])
aurum_diagnoses_HES_OP_ICD_dict[is.na(disease)]
levels(as.factor(aurum_diagnoses_HES_OP_ICD_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses) 
aurum_diagnoses_HES_OP_ICD_dict = aurum_diagnoses_HES_OP_ICD_dict[!is.na(disease)]
nrow(aurum_diagnoses_HES_OP_ICD_dict)

#OPCS table - Merge with code dictionary
aurum_diagnoses_HES_OP_OPCS_dict = merge(aurum_diagnoses_HES_OP_OPCS[,.(patid, eventdate, OPCS, database, codetype)], opcs_codes_table[,.(alt_opcs_code, opcs_code, unique_ID, description, disease, disease_category, disease_subcategory, disease_short, include)], by.x = "OPCS", by.y = "alt_opcs_code", all.x=T, allow.cartesian=TRUE) # ! no points in OPCS codes!
head(aurum_diagnoses_HES_OP_OPCS_dict)
setnames(aurum_diagnoses_HES_OP_OPCS_dict, old=c("OPCS", "opcs_code", "unique_ID"), new =c("alt_code", "diag_code", "diag_code_unique_ID")) # rename columns
nrow(aurum_diagnoses_HES_OP_OPCS)
nrow(aurum_diagnoses_HES_OP_OPCS_dict)
nrow(aurum_diagnoses_HES_OP_OPCS_dict[is.na(disease)])
levels(as.factor(aurum_diagnoses_HES_OP_OPCS_dict[is.na(disease)]$diag_code)) # Codes checked (these are codes that have been excluded from final analyses) 
aurum_diagnoses_HES_OP_OPCS_dict = aurum_diagnoses_HES_OP_OPCS_dict[!is.na(disease)]
nrow(aurum_diagnoses_HES_OP_OPCS_dict)

# RBind ICD and OPCS tables
aurum_diagnoses_HES_OP_dict = rbind(aurum_diagnoses_HES_OP_ICD_dict,aurum_diagnoses_HES_OP_OPCS_dict, fill=TRUE )
#head(aurum_diagnoses_HES_OP_OPCS_dict)
nrow(aurum_diagnoses_HES_OP_dict)
nrow(aurum_diagnoses_HES_OP_OPCS_dict)+nrow(aurum_diagnoses_HES_OP_ICD_dict)
```

### Diagnoses in CPRD Aurum - ONS Death
```{r, eval=TRUE, warning=FALSE, message=FALSE}
death_aurum= fread(file.path(PATH_D2,"/Aurum/Data/Linked_Data/ONS/death_patient_19_156A_DM.txt.gz"), header = T, sep="\t")
class(death_aurum$patid)
colnames(death_aurum)
death_aurum[,dod:=as.Date(dod, format="%d/%m/%Y")] #set date format
death_aurum[,dod_partial:=as.Date(dod_partial, format="%d/%m/%Y")] #set date format
nrow(death_aurum[is.na(dod)]) # check how many dod are missing
nrow(death_aurum[is.na(dod) & !is.na(dod_partial)]) # check dod_partial can be used for those with missing dod
death_aurum = death_aurum[!is.na(dod)] # exclude records with missing death date
setnames(death_aurum, old=c("cause", "cause1", "cause2", "cause3", "cause4", "cause5", "cause6", "cause7", "cause8", "cause9", "cause10", "cause11", "cause12", "cause13", "cause14", "cause15"), new =c("death_cause_first", "death_cause2", "death_cause3", "death_cause4", "death_cause5", "death_cause6", "death_cause7", "death_cause8", "death_cause9", "death_cause10", "death_cause11", "death_cause12", "death_cause13", "death_cause14", "death_cause15", "death_cause16"))
death_aurum = death_aurum[,.(patid, dod, death_cause_first, death_cause2, death_cause3, death_cause4, death_cause5, death_cause6, death_cause7, death_cause8, death_cause9, death_cause10, death_cause11, death_cause12, death_cause13, death_cause14, death_cause15, death_cause16)] # select relevant columns
head(death_aurum)
format(nrow(death_aurum), big.mark="'")  # number of records in table
format(length(unique(death_aurum$patid)), big.mark="'")  # number of unique patient IDs in table

death_aurum_melted = data.table::melt(death_aurum, measure.vars = c("death_cause_first", "death_cause2", "death_cause3", "death_cause4", "death_cause5", "death_cause6", "death_cause7", "death_cause8", "death_cause9", "death_cause10", "death_cause11", "death_cause12", "death_cause13", "death_cause14", "death_cause15", "death_cause16"),variable.name = "death_diag_order", value.name = "diag_code") # melt table
#setnames(death_aurum_melted, old = "value", new = "diag_code")
death_aurum_melted = death_aurum_melted[!is.na(diag_code)] # exclude empty fields
death_aurum_melted = death_aurum_melted[!(diag_code == "")] # exclude empty fields
head(death_aurum_melted)

format(nrow(death_aurum_melted), big.mark="'")  # number of records in table
format(length(unique(death_aurum_melted$patid)), big.mark="'")  # number of unique patient IDs in table

# Select only CVD codes
death_aurum_melted_cvd = death_aurum_melted[diag_code %in% icd_9_10_codes_table[disease_category == "cardiovascular"]$icd_code]
format(nrow(death_aurum_melted_cvd), big.mark="'")  # number of records in table
format(length(unique(death_aurum_melted_cvd$patid)), big.mark="'")  # number of unique patient IDs in table

# Merge with code dictionary
death_aurum_melted_cvd2 = merge(death_aurum_melted_cvd, icd_9_10_codes_table[disease_category == "cardiovascular",.(alt_icd_code, icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "diag_code", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
levels(as.factor(fsetdiff(death_aurum_melted_cvd[,.(diag_code)], death_aurum_melted_cvd2[,.(diag_code)], all = TRUE)))
levels(as.factor(fsetdiff(death_aurum_melted_cvd2[,.(diag_code)], death_aurum_melted_cvd[,.(diag_code)], all = TRUE)))
icd_9_10_codes_table[icd_code %in% c("I26.0", "I26.9", "I81", "I82.3")]
death_aurum_melted_cvd = death_aurum_melted_cvd2
setnames(death_aurum_melted_cvd, old=c("alt_icd_code", "unique_ID"), new =c("alt_code", "diag_code_unique_ID")) # rename columns

# Check that all codes have been matched with a disease
nrow(death_aurum_melted_cvd[is.na(disease)])

# Define code type and database
death_aurum_melted_cvd[,database := "ONS AURUM"] 
death_aurum_melted_cvd[,codetype := "icd"] 

# Rename dod as eventdate 
setnames(death_aurum_melted_cvd, old=c("dod"), new =c("eventdate")) # rename columns

format(nrow(death_aurum_melted_cvd), big.mark="'")  # number of records in table
colnames(death_aurum_melted_cvd)
```

### Diagnoses in CPRD Aurum - HES PRIMARY (for sensitivity analyses)
```{r, eval=TRUE, warning=FALSE, message=FALSE}
hes_aurum_primary= fread(file.path(PATH_D2,"/Aurum/Data/Linked_Data/HES_Primary/hes_primary_diag_hosp_19_156A_DM.txt.gz"), header = T, sep="\t")
class(hes_aurum_primary$patid)
head(hes_aurum_primary)
hes_aurum_primary[,admidate:=as.Date(admidate, format="%d/%m/%Y")] #set date format
hes_aurum_primary[,discharged:=as.Date(discharged, format="%d/%m/%Y")] #set date format
format(nrow(hes_aurum_primary), big.mark="'")  # number of records in table
format(nrow(hes_aurum_primary[ICDx != ""]), big.mark="'")  
hes_aurum_primary[ICDx %in% c("-","--","~","-~", "A", "D", "d", "Z", "-A","-D", "X", "E", "+", "*", ",", "!", "G", ".", "H", "F", "J", "K", "R", "N", "DN", "C", "I", "DH", "DR", "H3", "+L", "DG", "a", "M", "#", "~Y", "S", "0D", "2D", "2~", "9~","9D", " ", "0~")]$ICDx = ""  # Exclude unhelpful modifiers
hes_aurum_primary[ICD_PRIMARY %in% c("I70.1", "I70.8", "I70.9",  "I48.0", "I48.1", "I48.9") & ICDx %in% c("0", "1", "9")]$ICDx = ""  # Exclude unhelpful modifiers
#nrow(hes_aurum_primary[ICD_PRIMARY == "I70.1"])
#nrow(hes_aurum_primary[ICD_PRIMARY == "I70.10"])
#nrow(hes_aurum_primary[ICD_PRIMARY == "I70.9"])
#nrow(hes_aurum_primary[ICD_PRIMARY == "I70.8"])
#nrow(hes_aurum_primary[ICD_PRIMARY == "I70.80"])
#nrow(hes_aurum_primary[ICD_PRIMARY == "I48.9"])
#nrow(hes_aurum_primary[ICD_PRIMARY == "I48.90"])

format(nrow(hes_aurum_primary[ICDx != ""]), big.mark="'") 
hes_aurum_primary[,ICD_5:= paste(ICD_PRIMARY, ICDx, sep = "")] # concatenate ICD codes and modifiers as one single code
#icd_codes_table[disease_category == "cardiovascular"]
hes_aurum_primary1 = subset(hes_aurum_primary, ICD_PRIMARY %in% icd_codes_table[disease_category == "cardiovascular"]$icd_code)
hes_aurum_primary2 = subset(hes_aurum_primary, ICD_5 %in% icd_codes_table[disease_category == "cardiovascular"]$icd_code)
nrow(hes_aurum_primary1)
nrow(hes_aurum_primary2)
nrow(hes_aurum_primary1)-nrow(hes_aurum_primary2)
fsetdiff(hes_aurum_primary1, hes_aurum_primary2, all = TRUE)
fsetdiff(hes_aurum_primary2, hes_aurum_primary1, all = TRUE)
hes_aurum_primary = hes_aurum_primary1
nrow(hes_aurum_primary)

#comorb_aurum_hes[,database := "HES APC AURUM"] 
#comorb_aurum_hes[,codetype := "ICD"] 

setnames(hes_aurum_primary, old=c("ICD_PRIMARY", "ICDx"), new =c("diag_code", "icd_modifier")) # date of diagnosis = date of discharge 
nrow(hes_aurum_primary[is.na(discharged),]) # double check number of corrupt eventdates
hes_aurum_primary[, eventdate:= discharged ] # date of diagnosis = date of discharge 
hes_aurum_primary[is.na(eventdate), eventdate:= admidate ] # where discharge date is missing, use admission date
nrow(hes_aurum_primary[is.na(eventdate),]) # double check number of corrupt eventdates
hes_aurum_primary = hes_aurum_primary[!is.na(eventdate)] # exclude events where both admission and discharge dates are missing
nrow(hes_aurum_primary[is.na(eventdate)])

hes_aurum_primary = hes_aurum_primary[duplicated(hes_aurum_primary)==F,] # Exclude duplicates
format(nrow(hes_aurum_primary), big.mark="'") 
#comorb_aurum_hes[,diag_code_unique_ID := paste("I",diag_code, sep="_")] ## Define unique_ID
colnames(hes_aurum_primary)
hes_aurum_primary = hes_aurum_primary[,.(patid, eventdate, diag_code, admidate, discharged, spno, ICD_5, icd_modifier)]

# Merge with code dictionary
hes_aurum_primary2 = merge(hes_aurum_primary, icd_codes_table[disease_category == "cardiovascular",.(alt_icd_code, icd_code, unique_ID, description, disease, disease_category,disease_subcategory, disease_short, include)], by.x = "diag_code", by.y = "icd_code", all.x=T, allow.cartesian=TRUE)
levels(as.factor(fsetdiff(hes_aurum_primary[,.(diag_code)], hes_aurum_primary2[,.(diag_code)], all = TRUE)))
levels(as.factor(fsetdiff(hes_aurum_primary2[,.(diag_code)], hes_aurum_primary[,.(diag_code)], all = TRUE)))
#icd_codes_table[icd_code %in% c("I26.0", "I26.9", "I81", "I82.3")]
hes_aurum_primary = hes_aurum_primary2
setnames(hes_aurum_primary, old=c("alt_icd_code", "unique_ID"), new =c("alt_code", "diag_code_unique_ID")) # rename columns
colnames(hes_aurum_primary)

# Check that all codes have been matched with a disease
nrow(hes_aurum_primary[is.na(disease)])

# Define code type and database
hes_aurum_primary[,database := "HES AURUM PRIMARY"] 
hes_aurum_primary[,codetype := "icd"] 

colnames(hes_aurum_primary)
format(nrow(hes_aurum_primary), big.mark="'")  # number of records in table
format(length(unique(hes_aurum_primary$patid)), big.mark="'")  # number of unique patient IDs in table
```



### Combine all diagnoses in CPRD Aurum - Primary care, HES APC and HES OP
```{r combine_aurum, eval=TRUE, warning=FALSE, message=FALSE}
# Check
colnames(aurum_diagnoses_primary_care_dict)
class(aurum_diagnoses_primary_care_dict$patid)


# Rbind tables
include_cvd_death
if (include_cvd_death == "yes") {aurum_diagnoses_all = rbind( aurum_diagnoses_primary_care_dict, aurum_diagnoses_HES_APC_dict,aurum_diagnoses_HES_OP_dict, death_aurum_melted_cvd,  fill=TRUE ) }  else { aurum_diagnoses_all = rbind( aurum_diagnoses_primary_care_dict, aurum_diagnoses_HES_APC_dict, aurum_diagnoses_HES_OP_dict, fill=TRUE )} # if include_cvd_death == "yes" then include records of CVD death, else do not includes records of CVD death
#aurum_diagnoses_all = rbind(aurum_diagnoses_primary_care_dict, aurum_diagnoses_HES_APC_dict,aurum_diagnoses_HES_OP_dict, fill=TRUE )
nrow(aurum_diagnoses_all)

# Add pracid
aurum_diagnoses_all = merge(aurum_diagnoses_all, denominator_aurum[,.(patid, pracid)], by = "patid", all.x = TRUE)
summary(aurum_diagnoses_all$pracid)

# Check
# Check that for all diag_codes include == 1
levels(as.factor(aurum_diagnoses_all$include))

# Check eventdates and patid
nrow(aurum_diagnoses_all[is.na(eventdate),])
nrow(aurum_diagnoses_all[is.na(pracid),])
summary(aurum_diagnoses_all$pracid )

# define db_patid across gold and aurum
aurum_diagnoses_all[,db_patid := paste("A", patid, sep="")] 
```


## Save_1
```{r save_1, eval=TRUE, warning=FALSE, message=FALSE}
rm(list=setdiff(ls(), c("gold_diagnoses_all",  "aurum_diagnoses_all", "death_gold_melted_cvd", "death_aurum_melted_cvd", "hes_gold_primary", "hes_aurum_primary", "study_start_date", "study_end_date", "PATH", "PATH_D", "PATH_D2", "PATH_W", "PATH_W_orig", "PATH_L", "gold_codes_table", "aurum_codes_table", "icd_codes_table", "icd_9_10_codes_table", "opcs_codes_table", "all_codes_table", "denominator", "age_group_table", "compute_days", "age_group_fun", "icd_codes_to_be_double_checked_for_inclusion_gold", "diag_codes_table_inc_0", "gold_codes_to_be_double_checked_for_inclusion", "aurum_codes_to_be_double_checked_for_inclusion", "icd_codes_to_be_double_checked_for_inclusion_aurum", "include_cvd_death", "death_gold", "death_aurum")))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_1.RData"))
#save.image(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_1.RData"))
gc()
```


# Combine gold and aurum diagnoses
```{r, eval=TRUE, warning=FALSE, message=TRUE}
class(gold_diagnoses_all$patid)
class(aurum_diagnoses_all$patid)

gold_diagnoses_all[,patid:=as.integer64(patid)]
head(gold_diagnoses_all)
diagnoses_all = rbind(gold_diagnoses_all, aurum_diagnoses_all, fill=TRUE) # codes with include == 1 or 1-possible
nrow(diagnoses_all)
nrow(diagnoses_all[is.na(disease)])
head(diagnoses_all[is.na(disease)])
#levels(as.factor(diagnoses_all[is.na(disease)]$database))
nrow(diagnoses_all[is.na(pracid)])
nrow(diagnoses_all[is.na(eventdate)])

# DEATH All
death_gold[,db_patid := paste("G", patid, sep="")]
nrow(death_gold)
death_aurum[,db_patid := paste("A", patid, sep="")]
nrow(death_aurum)
death_all = rbind(death_gold, death_aurum, fill=TRUE)
nrow(death_all)

# DEATH (CVD only)
class(death_aurum_melted_cvd$patid)
class(death_gold_melted_cvd$patid)
death_gold_melted_cvd[,patid:=as.integer64(patid)]
death_gold_melted_cvd[,db_patid := paste("G", patid, sep="")]
death_aurum_melted_cvd[,db_patid := paste("A", patid, sep="")]
death_melted_cvd = rbind(death_gold_melted_cvd, death_aurum_melted_cvd, fill=TRUE)
nrow(death_melted_cvd)
nrow(death_melted_cvd[is.na(disease)])
nrow(death_melted_cvd[is.na(patid)])

# SENS (HES PRIMARY ONLY)
class(hes_gold_primary$patid)
class(hes_aurum_primary$patid)
hes_gold_primary[,patid:=as.integer64(patid)]
hes_gold_primary[,db_patid := paste("G", patid, sep="")]
hes_aurum_primary[,db_patid := paste("A", patid, sep="")]
hes_primary = rbind(hes_gold_primary, hes_aurum_primary, fill=TRUE)
nrow(hes_primary)
nrow(hes_primary[is.na(disease)])
nrow(hes_primary[is.na(patid)])
```


# Create code occurence tables - Any occurence
```{r code_occ, eval=TRUE, warning=FALSE, message=FALSE}
# Number of occurences by code with include == 1/1-possible (any occurence)
code_occ_1= diagnoses_all[,.N, by = c("diag_code_unique_ID","disease", "codetype" )]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=disease]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all = TRUE)
setcolorder(code_occ_1_dict, c("disease_category", "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, -N)]
nrow(code_occ_1_dict)
code_occ_1_dict[is.na(diag_code_unique_ID)]
levels(as.factor(diagnoses_all[is.na(diag_code_unique_ID)]$database))
diagnoses_all[is.na(diag_code_unique_ID)]

write.table(code_occ_1_dict, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/2023-03-11_code_occ_table_1_any_occurence.txt"), sep="\t", row.names=FALSE)

# Check number of unique patients identified by disease
#gold_diagnoses_all = gold_diagnoses_all[exclude == 0]
code_occ_table_by_disease =diagnoses_all[, .(count = uniqueN(patid)), by = c("disease", "disease_category")]
code_occ_table_by_disease=code_occ_table_by_disease[order(disease_category, disease)]
aggregate(code_occ_table_by_disease$count, by=list(Category=code_occ_table_by_disease$disease_category), FUN=sum)
code_occ_table_by_disease
write.table(code_occ_table_by_disease, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/2023-03-11_code_occ_table_by_disease_any_occurence.txt"), sep="\t")
```

# Save_2
```{r save_2, eval=TRUE, warning=FALSE, message=FALSE}
#save.image(file.path(PATH_W,"2022-02-18FullWorkspaceIdentification.RData"))
fwrite(diagnoses_all, file.path(PATH_W, "diagnoses_all.txt.gz"))
fwrite(death_melted_cvd, file.path(PATH_W, "death_melted_cvd.txt.gz"))
fwrite(hes_primary, file.path(PATH_W, "hes_primary.txt.gz"))
fwrite(death_all, file.path(PATH_W, "death_all.txt.gz"))


rm(list=setdiff(ls(), c("diagnoses_all", "death_melted_cvd", "hes_primary", "diagnoses_all_0", "study_start_date", "study_end_date", "PATH", "PATH_D", "PATH_D2", "PATH_W","PATH_W_orig", "PATH_L", "gold_codes_table", "aurum_codes_table", "icd_codes_table", "icd_9_10_codes_table", "opcs_codes_table", "all_codes_table", "denominator", "age_group_table", "compute_days", "age_group_fun", "icd_codes_to_be_double_checked_for_inclusion_gold", "diag_codes_table_inc_0", "gold_codes_to_be_double_checked_for_inclusion", "aurum_codes_to_be_double_checked_for_inclusion", "icd_codes_to_be_double_checked_for_inclusion_aurum", "include_cvd_death")))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_2.RData"))
save.image(file.path(PATH_W,"2023-03-03_SelectedWorkspaceIdentification_CVD_2.RData"))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_2.RData"))
gc()
```

# Select first date of diagnosis
## Select first date of diagnosis for each patient and EACH CONDITION
```{r first_date, eval=TRUE, warning=FALSE, message=FALSE}
start_time <- Sys.time()
diagnoses_all_first=diagnoses_all[,.SD[which.min(eventdate)], by = c("db_patid", "disease")]
end_time <- Sys.time()
end_time - start_time 

# Number of diagnoses
nrow(diagnoses_all_first)
class(diagnoses_all$eventdate)
```

# Save_3
```{r save_3, eval=TRUE, warning=FALSE, message=FALSE}
#save.image(file.path(PATH_W,"2022-02-18FullWorkspaceIdentification.RData"))
fwrite(diagnoses_all_first, file.path(PATH_W, "diagnoses_all_first.txt.gz"))
rm(list=setdiff(ls(), c("diagnoses_all_first", "diagnoses_all_AD_first", "diagnoses_all_CVD_first","study_start_date", "study_end_date", "PATH", "PATH_D", "PATH_D2", "PATH_W", "PATH_W_orig", "PATH_L", "gold_codes_table", "aurum_codes_table", "icd_codes_table", "icd_9_10_codes_table", "opcs_codes_table", "all_codes_table", "denominator", "cohort_1", "age_group_table", "compute_days", "age_group_fun", "icd_codes_to_be_double_checked_for_inclusion_gold", "diag_codes_table_inc_0", "gold_codes_to_be_double_checked_for_inclusion", "aurum_codes_to_be_double_checked_for_inclusion", "icd_codes_to_be_double_checked_for_inclusion_aurum", "include_cvd_death")))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_3.RData"))
#save.image(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_3.RData"))
gc()
```

# Create code occurence tables
```{r code_occ_1, eval=TRUE, warning=FALSE, message=FALSE}
# Number of occurences by code with include == 1 / 1-possible (any first occurence)
code_occ_1= diagnoses_all_first[,.N, by = c("diag_code_unique_ID","disease", "codetype" )]
code_occ_1[, "frequency":=paste(round(N/sum(N)*100,2),"%"), by=disease]
code_occ_1_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], all_codes_table, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all = TRUE)
setcolorder(code_occ_1_dict, c("disease_category", "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_1_dict=code_occ_1_dict[order(disease, -N)]
nrow(code_occ_1_dict)
write.table(code_occ_1_dict, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_any_time/2023-03-11_code_occ_table_1_first.txt"), sep="\t", row.names=FALSE)

# Number of occurences all codes including "0 - possible" codes
code_occ_0_dict = merge(code_occ_1[, .(disease, diag_code_unique_ID, N,frequency )], diag_codes_table_inc_0, by.x = c("disease", "diag_code_unique_ID"), by.y = c("disease", "unique_ID"), all = TRUE)
setcolorder(code_occ_0_dict, c("disease_category", "disease", "description", "N", "frequency","diag_code_unique_ID"))
code_occ_0_dict=code_occ_0_dict[order(disease, -N)]
nrow(code_occ_0_dict)
code_occ_0_dict

# Codes to be double-checked
icd_codes_to_be_double_checked_for_inclusion = rbind(icd_codes_to_be_double_checked_for_inclusion_gold, icd_codes_to_be_double_checked_for_inclusion_aurum)
icd_codes_to_be_double_checked_for_inclusion = icd_codes_to_be_double_checked_for_inclusion[,.(count_na=sum(count_na)),.(disease_category, disease, diag_code, description, unique_ID)]
icd_codes_to_be_double_checked_for_inclusion[,codetype := "icd"]
gold_codes_to_be_double_checked_for_inclusion[,codetype := "gold"]
aurum_codes_to_be_double_checked_for_inclusion[,codetype := "aurum"]
aurum_codes_to_be_double_checked_for_inclusion[, diag_code_aurum:= as.character(diag_code_aurum)]
codes_to_be_double_checked_for_inclusion = rbind(icd_codes_to_be_double_checked_for_inclusion, gold_codes_to_be_double_checked_for_inclusion, aurum_codes_to_be_double_checked_for_inclusion, fill=TRUE)
head(codes_to_be_double_checked_for_inclusion)
setcolorder(codes_to_be_double_checked_for_inclusion, c("disease_category", "disease", "description", "count_na","unique_ID", "diag_code", "diag_code_aurum"))
codes_to_be_double_checked_for_inclusion=codes_to_be_double_checked_for_inclusion[order(disease_category, disease, -count_na)]
codes_to_be_double_checked_for_inclusion
write.table(codes_to_be_double_checked_for_inclusion, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_any_time/2023-03-11_codes_to_be_double_checked_for_inclusion.txt"), sep="\t") # these are "0-possible" codes (ie. codes excluded from analysis but originally one of the reviewer sugggested to include that code) alongside number of occurences

# Check number of unique patients identified by disease
#gold_diagnoses_all = gold_diagnoses_all[exclude == 0]
code_occ_table_by_disease =diagnoses_all_first[, .(count = uniqueN(patid)), by = c("disease", "disease_category")]
code_occ_table_by_disease=code_occ_table_by_disease[order(disease_category, disease)]
aggregate(code_occ_table_by_disease$count, by=list(Category=code_occ_table_by_disease$disease_category), FUN=sum)
code_occ_table_by_disease
write.table(code_occ_table_by_disease, file.path(PATH,"/Phenotyping/Final_AD_INF_CVD/CVD_incidence/Code_occurence_tables_any_time/2023-03-11_code_occ_table_by_disease.txt"), sep="\t")
```

# Save_3b
```{r save_3b, eval=TRUE, warning=FALSE, message=FALSE}
#save.image(file.path(PATH_W,"2022-02-18FullWorkspaceIdentification.RData"))
#fwrite(diagnoses_all_first, file.path(PATH_W, "diagnoses_all_first.txt.gz"))
rm(list=setdiff(ls(), c("diagnoses_all_first", "diagnoses_all_AD_first", "diagnoses_all_CVD_first","study_start_date", "study_end_date", "PATH", "PATH_D", "PATH_D2", "PATH_W", "PATH_W_orig","PATH_L", "gold_codes_table", "aurum_codes_table", "icd_codes_table", "icd_9_10_codes_table", "opcs_codes_table", "all_codes_table", "denominator", "cohort_1", "age_group_table", "compute_days", "age_group_fun", "icd_codes_to_be_double_checked_for_inclusion_gold", "diag_codes_table_inc_0", "gold_codes_to_be_double_checked_for_inclusion", "aurum_codes_to_be_double_checked_for_inclusion", "icd_codes_to_be_double_checked_for_inclusion_aurum", "include_cvd_death")))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_3b.RData"))
save.image(file.path(PATH_W,"2023-03-03_SelectedWorkspaceIdentification_CVD_3b.RData"))
#load(file.path(PATH_W,"2022-02-18SelectedWorkspaceIdentification_3b.RData"))
gc()
```




# Save_5
```{r save_M, eval=TRUE, warning=FALSE, message=FALSE}
#save.image(file.path(PATH_W,"2022-02-18FullWorkspaceIdentification.RData"))
rm(list=setdiff(ls(), c("diagnoses_all_first_denom", "matching_cohort_no_CVD", "study_start_date", "study_end_date", "PATH", "PATH_D", "PATH_D2", "PATH_W","PATH_W_orig", "PATH_L", "gold_codes_table", "aurum_codes_table", "icd_codes_table", "icd_9_10_codes_table", "opcs_codes_table", "all_codes_table", "denominator", "cohort_1", "age_group_table", "compute_days", "age_group_fun", "icd_codes_to_be_double_checked_for_inclusion_gold", "diag_codes_table_inc_0", "gold_codes_to_be_double_checked_for_inclusion", "aurum_codes_to_be_double_checked_for_inclusion", "icd_codes_to_be_double_checked_for_inclusion_aurum", "include_cvd_death")))

save.image(file.path(PATH_W,"2023-03-03_SelectedWorkspaceIdentification_CVD_5.RData"))
```
```